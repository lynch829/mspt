

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mspt.scanning.deliverySimulation_Static_Dynamic &mdash; mspt  documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="mspt  documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../../../index.html" class="fa fa-home"> mspt</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../mspt.html">mspt package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../mspt.html#subpackages">Subpackages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../mspt.html#module-mspt">Module contents</a></li>
</ul>
</li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">mspt</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      
    <li>mspt.scanning.deliverySimulation_Static_Dynamic</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <h1>Source code for mspt.scanning.deliverySimulation_Static_Dynamic</h1><div class="highlight"><pre>
<span class="c">########################################################################</span>
<span class="c">#</span>
<span class="c"># deliverySimulation_Static_Dynamic.py</span>
<span class="c"># </span>
<span class="c"># Created by Paul Morel, LIGM, Universite Paris-Est Marne La Vallee, France</span>
<span class="c"># paul.morel@univ-mlv.fr</span>
<span class="c"># June 2013</span>
<span class="c"># </span>
<span class="c">#   </span>
<span class="c">########################################################################</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">..dataViewer</span> <span class="kn">import</span> <span class="n">array2DViewer</span> <span class="k">as</span> <span class="n">viewer2D</span> 
<span class="kn">from</span> <span class="nn">..mathTools</span> <span class="kn">import</span> <span class="n">tools</span> <span class="k">as</span> <span class="n">mathTools</span>
<span class="kn">from</span> <span class="nn">..simulator.tools</span> <span class="kn">import</span> <span class="n">Tools</span> <span class="k">as</span> <span class="n">simTools</span>
<span class="kn">from</span> <span class="nn">..dicomReader</span> <span class="kn">import</span> <span class="n">scanningPath</span> <span class="k">as</span> <span class="n">scanPlan</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span> 
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">cPickle</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">itemgetter</span><span class="p">,</span> <span class="n">attrgetter</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>
<span class="kn">import</span> <span class="nn">itertools</span> <span class="kn">as</span> <span class="nn">iter</span>

<span class="c">#C extension to simulate the beamlet</span>
<span class="kn">from</span> <span class="nn">..extensionsC.PythonExtensionAllPlatforms.PythonExtensionBeamletCalc</span> <span class="kn">import</span> <span class="n">_beamletSimulation_PythonExt</span> <span class="k">as</span> <span class="n">_beamletSimulation</span> 
<span class="kn">from</span> <span class="nn">..extensionsC.PythonExtensionAllPlatforms.PythonExtensionBeamletCalcDouble</span> <span class="kn">import</span> <span class="n">_beamletSimulation_PythonExtDouble</span> <span class="k">as</span> <span class="n">_beamletSimulationDouble</span> 

<span class="n">limitSmallWeights</span> <span class="o">=</span> <span class="mf">1e-4</span>
<span class="n">useFastRadiolDepth_DynaDeliv</span> <span class="o">=</span> <span class="bp">True</span> 

<div class="viewcode-block" id="simulatorDelivery"><a class="viewcode-back" href="../../../mspt.scanning.html#mspt.scanning.deliverySimulation_Static_Dynamic.simulatorDelivery">[docs]</a><span class="k">class</span> <span class="nc">simulatorDelivery</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Class simulatorDelivery is the core of the simulation. This where the delivery is actually simulated.</span>
<span class="sd">    </span>
<span class="sd">    :param patient: Patient object (in patient.patient) containing all the 3D arrays for the CT, density, ...</span>
<span class="sd">    :param ddCurvesData: DDcurve object (in physics.ddCurveManager) used to store all the depth-dose curves.</span>
<span class="sd">    :param configData: dictionary (globalVariables) storing the data configuring the simulator. \</span>
<span class="sd">    Mandatory keys:</span>
<span class="sd">        </span>
<span class="sd">        * *&#39;mainPath&#39;* : corresponds to the path where any simulation will be saved.</span>
<span class="sd">        * *&#39;nameSimulation&#39;* : corresponds to the path where the current simulation will be saved.</span>
<span class="sd">        * *&#39;typeFloat&#39;* : The type of numpy float to be used: &#39;float32&#39; or &#39;float64&#39;</span>
<span class="sd">        * *&#39;protPerMU&#39;* : Number of protons per MU to use.</span>
<span class="sd">        * *&#39;MeV&#39;*: Constant to convert 1MeV to Joules: 1MeV = 1.602e-13J</span>
<span class="sd">        * *&#39;displayScanPathUpdates&#39;* : Display the evolution of the current scanning path of the current energy layer. Scanning Paths are\</span>
<span class="sd">        stored in 3D numpy array ( see dicomReader.scanningPath for more information) where each frame is an energy layer. Therefore, if True \</span>
<span class="sd">        the frame corresponding the current energy layer will be displayed to show the remaining beam positions.</span>
<span class="sd">        * *&#39;skipSaveBeamlets&#39;*: False to save an image of the dose distribution of each beamlet simulated, True otherwise. </span>
<span class="sd">        * *&#39;saveBeamletsCPKL&#39;*: True to save the dose distribution of each beamlet (a 3D numpy array) in a cPickle structure.</span>
<span class="sd">        * *&#39;staticDelivery&#39;* : True if the patient is not moving, or False otherwise</span>
<span class="sd">        * *&#39;motionDuringBeam&#39;* (if &#39;staticDelivery&#39; is False): True to allow the patient to move while the beam is irradiating, False otherwise. </span>
<span class="sd">        * *&#39;motion3D&#39;* (if &#39;staticDelivery&#39; is False): True if the patient motion is in 3D.</span>
<span class="sd">        * *&#39;evaluateDiffStatDyna&#39;* (if &#39;staticDelivery&#39; is False) : True to evaluate the difference for each beam position between the static delivery and the dynamic delivery (i.e., moving patient).\</span>
<span class="sd">        False otherwise.</span>
<span class="sd">        * *&#39;storeInterDoseDens&#39;* (if &#39;staticDelivery&#39; is False) : True to store the density image of the moving patient and the dose distribution of the beam when the \</span>
<span class="sd">        patient is moving while being irradiated by a pencil beam. False otherwise. </span>
<span class="sd">        * *&#39;listSaveCompDoseAlong&#39;* (if &#39;staticDelivery&#39; is False):  list of the axis along which the user wants to save the density and dose images of the moving patient. Possible values are\</span>
<span class="sd">        &#39;x&#39; (i.e. the images are stored along the column axis of the dicom image), &#39;y&#39; (i.e. the images are stored along the rows axis of the dicom image), \</span>
<span class="sd">        &#39;z&#39; (i.e. the images are stored along the frame axis of the dicom image). Examlpes: listSaveCompDoseAlong = [] , or listSaveCompDoseAlong = [&#39;x&#39;] or listSaveCompDoseAlong = [&#39;x&#39;,&#39;z&#39;] ... </span>
<span class="sd">        * *&#39;timeEnergyChange&#39;* (if &#39;staticDelivery&#39; is False) : Time to change the energy of the beam in s.</span>
<span class="sd">        * *&#39;lateralScanningSpeed&#39;* (if &#39;staticDelivery&#39; is False): Beam lateral scanning speed in cm/s. </span>
<span class="sd">        * *&#39;spotSettlingTime&#39;* (if &#39;staticDelivery&#39; is False): Beam vertical scanning speed in cm/s. </span>
<span class="sd">        * *&#39;speedGantryRotation&#39;* (if &#39;staticDelivery&#39; is False): Gantry rotational speed in degrees/min.</span>
<span class="sd">        * *&#39;beamIntensity&#39;* (if &#39;staticDelivery&#39; is False): Number of protons per seconds being delivered.</span>
<span class="sd">        * *&#39;unitTimeForDelivery&#39;* (if &#39;staticDelivery&#39; is False): Unit time for motion simulation in seconde. Every unit time the patient position and radiological depth is updated.</span>
<span class="sd">        * *&#39;synchrotron&#39;* (if &#39;staticDelivery&#39; is False): True to simulate a synchrotron ( time energy change, refill the synchrotron). False for a cyclotron.</span>
<span class="sd">        * *&#39;spillLength&#39;* (if &#39;staticDelivery&#39; and synchrotron&#39; are True): Duration of a proton spill in s.</span>
<span class="sd">        * *&#39;compensationDynamic&#39;* (if &#39;staticDelivery&#39; is False): True to allow motion compensation, False otherwise.</span>
<span class="sd">        * *&#39;findStartPos&#39;* (if &#39;compensationDynamic&#39; is True): Find a good starting position in the energy layer( see dicomReader.scanningPath for more information).</span>
<span class="sd">        * *&#39;timeMeasureDisplacement&#39;* (if &#39;compensationDynamic&#39; is True): Time to measure the patient motion is s. </span>
<span class="sd">       </span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patient</span><span class="p">,</span><span class="n">ddCurvesData</span><span class="p">,</span> <span class="n">configData</span><span class="p">,</span> <span class="n">motion</span> <span class="o">=</span> <span class="bp">None</span> <span class="p">,</span><span class="n">monitor</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span> <span class="o">=</span> <span class="n">configData</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pathToOutputImages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">mainPath</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">nameSimulation</span> 
        <span class="c">############# If Dynamic delivery ############# </span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">staticDelivery</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">motion</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;In simulator delivery - dynamic mode - no motion has been provided for the patient...&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_motion</span> <span class="o">=</span> <span class="n">motion</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">compensationDynamic</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_monitoringSystm</span> <span class="o">=</span> <span class="n">monitor</span>
                    <span class="k">if</span> <span class="n">monitor</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Monitor is None in delivery with compensation&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_time</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_deffStatic</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># To be used when comparing computed dose for motion to computed dose in static</span>

        <span class="c">############# End - If Dynamic delivery #############       </span>
        <span class="k">if</span> <span class="n">patient</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">ddCurvesData</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span> <span class="p">(</span><span class="s">&quot;Input data (patient or ddCurves) is None&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span> <span class="o">=</span> <span class="n">patient</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ddCurvesData</span> <span class="o">=</span> <span class="n">ddCurvesData</span>
        
        
        

<div class="viewcode-block" id="simulatorDelivery.simulateDelivery"><a class="viewcode-back" href="../../../mspt.scanning.html#mspt.scanning.deliverySimulation_Static_Dynamic.simulatorDelivery.simulateDelivery">[docs]</a>    <span class="k">def</span> <span class="nf">simulateDelivery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spotPositions</span> <span class="p">):</span> 
        <span class="sd">&#39;&#39;&#39;Simulates the delivery of a proton therapy treatment plan to a patient based on the simulator configuration. \</span>
<span class="sd">        It uses the beam scanning method.</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        :param spotPosition: Treatment plan stored as a scanning path (dicomReader.scanningPath).</span>
<span class="sd">        </span>
<span class="sd">        :returns: None if the delivery is performed for a static patient or a moving patient without compensation. It returns a compensated treatment plan if the patient \</span>
<span class="sd">        is moving and &#39;compensationDynamic&#39; is True: dictionary[beam angle][Energy Rounded][ &quot;ScanSpotPositionMap&quot; / &quot;ScanSpotMetersetWeights&quot;]</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tool</span> <span class="o">=</span> <span class="n">simTools</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_receivedDose</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">shape</span><span class="p">(),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span>
        
        <span class="c">#Get spacing between spots in cm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xSpacing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">getSpacingInfo</span><span class="p">(</span><span class="s">&#39;x_spacing&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="mf">10.0</span>   <span class="c"># from mm to cm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ySpacing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">getSpacingInfo</span><span class="p">(</span><span class="s">&#39;y_spacing&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="mf">10.0</span> <span class="c"># from mm to cm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_zSpacing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">getSpacingInfo</span><span class="p">(</span><span class="s">&#39;z_spacing&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="mf">10.0</span> <span class="c"># from mm to cm</span>
        <span class="c">############# If Dynamic delivery #############</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">staticDelivery</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Starting dynamic delivery simulation...&quot;</span>
            <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">------------------&quot;</span>
            <span class="k">print</span> <span class="s">&quot;Motion Information:</span><span class="se">\n\t</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_motion</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;Motion allowed during a beamlet delivery: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">motionDuringBeam</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">------------------&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">compensationDynamic</span><span class="p">:</span>
                    <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monitoringSystm</span>
                    <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">------------------&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_staticPatientLoc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">getPatientExtentInStaticModel</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updateTime</span><span class="p">(</span><span class="s">&#39;Reset&#39;</span><span class="p">)</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">funcGetDataPatient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">getPatientDataForDisplVector</span>
            <span class="c">#self.computeDeff = self.updateDeff</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prevRotationAngle</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">compensationDynamic</span><span class="p">:</span>
                <span class="n">nbCompensatedSpots</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">nbCorrectSpots</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">nbMissedSpots</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">dictRepaintStat</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">compensatedPlan</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="c">############# End - If Dynamic delivery ############# </span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">print</span> <span class="s">&quot;Starting static delivery simulation...&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">funcGetDataPatient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">getPatientArrayForAttr</span>
            <span class="c">#self.computeDeff = self.computeDeffStatic</span>
        <span class="n">nbBeams</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spotPositions</span><span class="p">)</span>
        <span class="n">t_simul_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">nbTargets</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sumWeights</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">idxBeam</span><span class="p">,</span><span class="n">dataBeam</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spotPositions</span><span class="p">):</span>
            <span class="c">#####</span>
            <span class="c">#dataBeam : (0 : scanningPathSingleBeam ,1: angle , 2: isocenter , </span>
            <span class="c">#         3: vsad, 4: string &#39;NewAngle&#39; or &#39;SameAngle&#39; depending if the angle change between beams) </span>
            <span class="c">#####              </span>
            <span class="n">t_start_beam</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="k">print</span> <span class="s">&quot;Beam </span><span class="si">%i</span><span class="s"> / </span><span class="si">%i</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">idxBeam</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nbBeams</span><span class="p">)</span>
            <span class="c">### Get beam angle: In proton therapy, 1 angle/beam </span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">dataBeam</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="c">#angle = 45</span>
            <span class="k">print</span> <span class="s">&quot;Beam angle(degrees): </span><span class="si">%f</span><span class="s">&quot;</span><span class="o">%</span><span class="n">angle</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">staticDelivery</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">compensationDynamic</span><span class="p">:</span>
                <span class="n">dictRepaintStat</span><span class="p">[</span><span class="n">angle</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">compensatedPlan</span><span class="p">[</span><span class="n">angle</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            
            <span class="c">############# If Dynamic delivery #############</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">staticDelivery</span> <span class="ow">and</span> <span class="n">dataBeam</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;NewAngle&#39;</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">updateTime</span><span class="p">(</span><span class="s">&#39;GantryRotation&#39;</span><span class="p">,</span><span class="n">info</span> <span class="o">=</span> <span class="n">angle</span><span class="p">)</span>
            <span class="c">############# End - If Dynamic delivery ############# </span>
            
            <span class="c">#Set the patient and the source in the 3D space:</span>
            <span class="c">###Get isocenter</span>
            <span class="n">isocenterPos</span> <span class="o">=</span> <span class="p">[(</span><span class="n">value</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dataBeam</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="c">#spotPositions: data provided in mm! it must be converted to cm!</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">setIsocenter</span><span class="p">(</span><span class="n">dataBeam</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">indIsocenter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">getIsocenterInd</span><span class="p">()</span>
            <span class="k">print</span> <span class="s">&quot;Index isocenter: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">indIsocenter</span><span class="p">)</span>
            
            
            <span class="c"># Get coordinate system in the patient</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funcGetDataPatient</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">))</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span> <span class="o">/</span> <span class="mf">10.0</span> <span class="c"># from mm to cm</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funcGetDataPatient</span><span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">))</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">/</span> <span class="mf">10.0</span> <span class="c"># from mm to cm</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funcGetDataPatient</span><span class="p">(</span><span class="s">&#39;z&#39;</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span> <span class="o">/</span> <span class="mf">10.0</span> <span class="c"># from mm to cm </span>
            
            
            
            
            <span class="c">#Convert coordinate system in the IEC Fixed coordinate system</span>
                <span class="c">#Get isocenter</span>
            <span class="n">isocenterPos</span> <span class="o">=</span> <span class="p">[(</span><span class="n">value</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dataBeam</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="c">#spotPositions: data provided in mm! it muste be converted to cm!</span>

            <span class="c">#Convert X,Y,Z  coordinates from the patient dicom coordinate system to the IEC fixed gantry coordinate system</span>
            <span class="p">(</span><span class="n">X_iec_f</span><span class="p">,</span><span class="n">Y_iec_f</span><span class="p">,</span><span class="n">Z_iec_f</span><span class="p">)</span> <span class="o">=</span> <span class="n">mathTools</span><span class="o">.</span><span class="n">fromCTToIECFixedCoord</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">isocenterPos</span><span class="p">)</span>
            
            <span class="c">#Starting vector for radiological depth computation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_startVec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span><span class="n">X_iec_f</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">Y_iec_f</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">Z_iec_f</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span><span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="s">&#39;C&#39;</span><span class="p">)</span>
            <span class="c">#Incremental vector for radiological depth computation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_incVec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_xSpacing</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_zSpacing</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_ySpacing</span><span class="p">],</span><span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="s">&#39;C&#39;</span><span class="p">)</span>
            <span class="c">#First voxel coordinates used in the beamlet computation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_x0y0z0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">X_iec_f</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">Y_iec_f</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">Z_iec_f</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="s">&#39;C&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_IECFSpacing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">X_iec_f</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">X_iec_f</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>\
                                             <span class="n">Y_iec_f</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Y_iec_f</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>\
                                              <span class="n">Z_iec_f</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Z_iec_f</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="s">&#39;C&#39;</span><span class="p">)</span><span class="c"># Note: the y IEC F axis is along the frames axis</span>
    
            

    
            <span class="n">sourceLocation</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="c"># in the IEC fixed coordinate system</span>
            <span class="n">distanceSourceIsocenter</span> <span class="o">=</span> <span class="p">[(</span><span class="n">value</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dataBeam</span><span class="p">[</span><span class="mi">3</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span> <span class="c">#We assume that the beam is composed of 2 gaussian &quot;curves&quot; 1 in X direction, 1 in Y direction. Data provided in  &#39;VirtualSourceAxisDistances&#39; is composed by 2 coordinates (X,Y), we think that correspond to the distance with the virtual source generating the X gaussian and th Y gaussian.</span>
            <span class="n">sourceLocation</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">distanceSourceIsocenter</span><span class="p">)</span>
            
            <span class="k">print</span> <span class="s">&quot;Source location: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">sourceLocation</span><span class="p">)</span>
            
            
            <span class="c">###Compute rotation (around the patient - around y axis of the IEC fixed coord systm) matrix.</span>
            <span class="k">if</span> <span class="n">dataBeam</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;NewAngle&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rotMatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mathTools</span><span class="o">.</span><span class="n">rotationMatrixForAngle</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span>
                <span class="n">nVec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="c">#nVec corresponds to the beam trajectory(&quot;depth&quot; vector, on-axis): normal vector to the BEV plane. This is along the z axis rotated.</span>
                <span class="n">nVec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rotMatrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> 
                <span class="n">nVec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rotMatrix</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">nVec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rotMatrix</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                
                
                <span class="bp">self</span><span class="o">.</span><span class="n">_sourceVec</span> <span class="o">=</span> <span class="p">(</span><span class="n">sourceLocation</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">nVec</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>
                <span class="c">#Compute rotated coordinates (cm) </span>
                <span class="p">(</span><span class="n">Xr</span><span class="p">,</span><span class="n">Yr</span><span class="p">,</span><span class="n">Zr</span><span class="p">)</span> <span class="o">=</span> <span class="n">mathTools</span><span class="o">.</span><span class="n">rot3D</span><span class="p">(</span><span class="n">X_iec_f</span><span class="p">,</span><span class="n">Y_iec_f</span><span class="p">,</span><span class="n">Z_iec_f</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">_rotMatrix</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>
            <span class="n">nbSpots</span> <span class="o">=</span> <span class="mi">0</span>
            
                        
            <span class="n">listSpotsVisited</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">listSpotsDelivered</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">spotsVisitedButWeightNull</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">unexplainedWeightNull</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">countSmallWeights</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">logSpotsSmallWeights</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">countNotSmallWeights</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">sumNotSmallWeights</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="k">for</span> <span class="n">idxSpot</span><span class="p">,</span><span class="n">dataSpot</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataBeam</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span> <span class="c"># dataBeam[0] : class ScanningPathSingleBeam</span>
                <span class="c">#####</span>
                <span class="c">#dataSpot : (0 : weight ,1: index in scanning path structure (3D) , 2: x shift in IEC Gantry , </span>
                <span class="c">#         3: y shift in IEC Gantry, 4: energy , 5:spot size , </span>
                <span class="c">#         6:string &#39;SameEnergy&#39; or &#39;NewEnergy&#39; depending on what was </span>
                <span class="c">#         the energy of the previous spot - it will be &#39;NewEnergy&#39; for 1st spot ) </span>
                <span class="c">#####  </span>
                <span class="c">### Get beam size (width) </span>
                <span class="n">sig0</span> <span class="o">=</span> <span class="p">[((</span><span class="n">value</span><span class="o">/</span> <span class="mf">2.3548200</span><span class="p">)</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">dataSpot</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span>
                <span class="n">T0</span> <span class="o">=</span> <span class="n">dataSpot</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                
                
                <span class="n">T0_round</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">T0</span><span class="p">)</span>
                <span class="k">print</span> <span class="s">&quot;Start new spot #</span><span class="si">%i</span><span class="s">&quot;</span><span class="o">%</span><span class="n">idxSpot</span>
                <span class="k">print</span> <span class="s">&quot;Energy rounded: </span><span class="si">%f</span><span class="s">&quot;</span><span class="o">%</span><span class="n">T0_round</span>
                <span class="n">nbSpots</span> <span class="o">=</span> <span class="n">nbSpots</span> <span class="o">+</span> <span class="mi">1</span>
                
                <span class="n">compensated</span> <span class="o">=</span> <span class="bp">False</span>
                
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">displayScanPathUpdates</span><span class="p">:</span>
                    <span class="c">#Display the current scanning path slice</span>
                    <span class="n">currentEnergyLayer</span> <span class="o">=</span> <span class="n">dataBeam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getEnergySliceWeights</span><span class="p">(</span><span class="n">T0</span><span class="p">)</span>
                    <span class="n">viewer2D</span><span class="o">.</span><span class="n">displayImageFromArray</span><span class="p">(</span> <span class="n">currentEnergyLayer</span><span class="p">,</span> <span class="s">&quot;Scan path - energy layer </span><span class="si">%i</span><span class="s"> MeV&quot;</span><span class="o">%</span><span class="n">T0_round</span><span class="p">)</span>
                    <span class="n">filenameScanPath</span> <span class="o">=</span> <span class="s">&quot;ScanningPath</span><span class="si">%0.9d</span><span class="s">_</span><span class="si">%0.3d</span><span class="s">MeV&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">idxSpot</span><span class="p">,</span><span class="n">T0_round</span><span class="p">)</span>
                    <span class="n">viewer2D</span><span class="o">.</span><span class="n">saveFigure</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pathToOutputImages</span> <span class="o">+</span> <span class="s">&quot;ScanningPathUpdates/&quot;</span><span class="p">,</span><span class="n">filenameScanPath</span> <span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="s">&#39;png&#39;</span><span class="p">,</span> <span class="n">subplotIdx</span> <span class="o">=</span> <span class="mi">111</span><span class="p">)</span>
                    <span class="n">viewer2D</span><span class="o">.</span><span class="n">closePlot</span><span class="p">()</span>
            

                <span class="k">if</span> <span class="n">dataSpot</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;NewEnergy&#39;</span><span class="p">:</span>
                    <span class="c">############# If Dynamic delivery #############</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">staticDelivery</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">updateTime</span><span class="p">(</span><span class="s">&#39;Energy&#39;</span><span class="p">)</span>
                    <span class="c">############# End - If Dynamic delivery ############# </span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">computeStoppingPowerArray</span><span class="p">(</span><span class="n">energy</span> <span class="o">=</span> <span class="n">T0_round</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_protPerMU</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">protPerMU</span>
                    <span class="n">dmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddCurvesData</span><span class="o">.</span><span class="n">dataForEnergy</span><span class="p">(</span><span class="s">&#39;BraggPeak&#39;</span> <span class="p">,</span> <span class="n">T0</span><span class="p">)</span>
                    <span class="k">print</span> <span class="s">&quot;For energy </span><span class="si">%0.2f</span><span class="s"> Bragg Peak at:</span><span class="si">%s</span><span class="s"> cm in water.&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">T0</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">dmax</span><span class="p">))</span>
                    <span class="c">#Depth dose curve data (Gy.cm^2)</span>
                    <span class="n">z_dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddCurvesData</span><span class="o">.</span><span class="n">dataForEnergy</span><span class="p">(</span><span class="s">&#39;DD_Curve&#39;</span> <span class="p">,</span> <span class="n">T0</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span> <span class="c"># depths at which dose was computed</span>
                    <span class="n">dd</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_ddCurvesData</span><span class="o">.</span><span class="n">dataForEnergy</span><span class="p">(</span><span class="s">&#39;DD_Curve&#39;</span> <span class="p">,</span> <span class="n">T0</span><span class="p">)[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span><span class="c"># computed dose for depth dose curve</span>
                    
                    
                    <span class="c">#Get number of protons used for the Monte Carlo simulation providing the depth dose curve</span>
                    <span class="n">nbProtons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddCurvesData</span><span class="o">.</span><span class="n">dataForEnergy</span><span class="p">(</span><span class="s">&#39;NbProtons&#39;</span><span class="p">,</span> <span class="n">T0</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">staticDelivery</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_StPwrRatioGrid</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funcGetDataPatient</span><span class="p">(</span><span class="s">&#39;stpPwrRatio&#39;</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_DensityGrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">funcGetDataPatient</span><span class="p">(</span><span class="s">&#39;density&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_radiolDepth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">computeRadiologicalDepth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_startVec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_incVec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sourceVec</span><span class="p">,</span> <span class="n">dispVec</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">,</span> <span class="n">ener</span> <span class="o">=</span> <span class="n">T0_round</span><span class="p">)</span>
                


                                
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">staticDelivery</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">compensationDynamic</span><span class="p">:</span>
                <span class="c">####################&quot;</span>
                <span class="c">#### Compensation : update the table for the repainting statistics</span>
                <span class="c">####################&quot;</span>
                    <span class="k">if</span> <span class="n">T0_round</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dictRepaintStat</span><span class="p">[</span><span class="n">angle</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">dictRepaintStat</span><span class="p">[</span><span class="n">angle</span><span class="p">][</span><span class="n">T0_round</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="n">compensatedPlan</span><span class="p">[</span><span class="n">angle</span><span class="p">][</span><span class="n">T0_round</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="n">compensatedPlan</span><span class="p">[</span><span class="n">angle</span><span class="p">][</span><span class="n">T0_round</span><span class="p">][</span><span class="s">&quot;ScanSpotPositionMap&quot;</span><span class="p">]</span><span class="o">=</span><span class="nb">list</span><span class="p">()</span>
                        <span class="n">compensatedPlan</span><span class="p">[</span><span class="n">angle</span><span class="p">][</span><span class="n">T0_round</span><span class="p">][</span><span class="s">&quot;ScanSpotMetersetWeights&quot;</span><span class="p">]</span><span class="o">=</span><span class="nb">list</span><span class="p">()</span>                        
                    <span class="k">if</span> <span class="n">dataSpot</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dictRepaintStat</span><span class="p">[</span><span class="n">angle</span><span class="p">][</span><span class="n">T0_round</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">findStartPos</span><span class="p">:</span>
                        <span class="c">####################&quot;</span>
                        <span class="c">#### Compensation : find a good starting position at each repainting</span>
                        <span class="c">####################&quot;</span>
                            <span class="n">startSpot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compensationFindStartSpotEnerLayer</span><span class="p">(</span><span class="n">dataBeam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddCurvesData</span> <span class="p">,</span><span class="n">dataSpot</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="p">)</span>  
                            <span class="k">if</span> <span class="n">startSpot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                                <span class="k">print</span> <span class="s">&quot;Starting Point found: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">startSpot</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                                <span class="n">dataSpot</span> <span class="o">=</span> <span class="n">startSpot</span>                          
                        
                        <span class="n">dictRepaintStat</span><span class="p">[</span><span class="n">angle</span><span class="p">][</span><span class="n">T0_round</span><span class="p">][</span><span class="n">dataSpot</span><span class="p">[</span><span class="mi">8</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="c">#If margins added to scan spot position map, display it:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">displayScanPathUpdates</span><span class="p">:</span>
                            <span class="n">mapWithMargin</span> <span class="o">=</span> <span class="n">dataBeam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getMapWithMargin</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">mapWithMargin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                                <span class="n">viewer2D</span><span class="o">.</span><span class="n">displayImageFromArray</span><span class="p">(</span> <span class="n">mapWithMargin</span><span class="p">,</span> <span class="s">&quot;Current Scan Spot Map with Margins - energy layer </span><span class="si">%i</span><span class="s"> MeV&quot;</span><span class="o">%</span><span class="n">T0_round</span><span class="p">)</span>
                                <span class="n">filenameScanMap</span> <span class="o">=</span> <span class="s">&quot;ScanSpotMapWithMargin</span><span class="si">%0.3d</span><span class="s">MeV_Repainting</span><span class="si">%0.3d</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">T0_round</span><span class="p">,</span><span class="n">dataSpot</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
                                <span class="n">viewer2D</span><span class="o">.</span><span class="n">saveFigure</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pathToOutputImages</span> <span class="o">+</span> <span class="s">&quot;ScanSpotMapWithMargin/&quot;</span><span class="p">,</span><span class="n">filenameScanMap</span> <span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="s">&#39;png&#39;</span><span class="p">,</span> <span class="n">subplotIdx</span> <span class="o">=</span> <span class="mi">111</span><span class="p">)</span>
                                <span class="n">viewer2D</span><span class="o">.</span><span class="n">closePlot</span><span class="p">()</span>
                     
                    <span class="k">print</span> <span class="s">&quot;Current repainting: </span><span class="si">%i</span><span class="s"> - nb comp spot so far: </span><span class="si">%i</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">dataSpot</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span><span class="n">dictRepaintStat</span><span class="p">[</span><span class="n">angle</span><span class="p">][</span><span class="n">T0_round</span><span class="p">][</span><span class="n">dataSpot</span><span class="p">[</span><span class="mi">8</span><span class="p">]]</span> <span class="p">)</span>                
                    
                    
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">displayScanPathUpdates</span><span class="p">:</span>
                    <span class="n">mapWithCurrTarget</span> <span class="o">=</span> <span class="n">dataBeam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getMapWithEnhancedSpot</span><span class="p">(</span><span class="n">dataSpot</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">viewer2D</span><span class="o">.</span><span class="n">displayImageFromArray</span><span class="p">(</span> <span class="n">mapWithCurrTarget</span><span class="p">,</span> <span class="s">&quot;Current Scan Spot Position - energy layer </span><span class="si">%i</span><span class="s"> MeV&quot;</span><span class="o">%</span><span class="n">T0_round</span><span class="p">)</span>
                    <span class="n">filenameScanPos</span> <span class="o">=</span> <span class="s">&quot;ScanSpotPosition</span><span class="si">%0.9d</span><span class="s">_</span><span class="si">%0.3d</span><span class="s">MeV&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">idxSpot</span><span class="p">,</span><span class="n">T0_round</span><span class="p">)</span>
                    <span class="n">viewer2D</span><span class="o">.</span><span class="n">saveFigure</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pathToOutputImages</span> <span class="o">+</span> <span class="s">&quot;ScanSpotPosition/&quot;</span><span class="p">,</span><span class="n">filenameScanPos</span> <span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="s">&#39;png&#39;</span><span class="p">,</span> <span class="n">subplotIdx</span> <span class="o">=</span> <span class="mi">111</span><span class="p">)</span>
                    <span class="n">viewer2D</span><span class="o">.</span><span class="n">closePlot</span><span class="p">()</span>                   
                    
                <span class="c">###Spot delivery</span>
                <span class="n">t_start_spot</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                <span class="n">weight</span> <span class="o">=</span> <span class="n">dataSpot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">weight</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Spot </span><span class="si">%i</span><span class="s"> , weight: </span><span class="si">%e</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">idxSpot</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">weight</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Spot </span><span class="si">%i</span><span class="s"> , weight: </span><span class="si">%f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">idxSpot</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">weight</span><span class="p">)</span>
                
                <span class="n">xrshift</span> <span class="o">=</span> <span class="n">dataSpot</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mf">10.0</span><span class="c"># lateral shift of spot: from mm to cm</span>
                <span class="n">yrshift</span> <span class="o">=</span> <span class="n">dataSpot</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mf">10.0</span><span class="c">#on-axis shift of spot: from mm to cm</span>
                <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">(xrshift,yrshift) : (</span><span class="si">%f</span><span class="s">,</span><span class="si">%f</span><span class="s">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">xrshift</span><span class="p">,</span><span class="n">yrshift</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">listSpotsVisited</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">listSpotsVisited</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">xrshift</span><span class="p">,</span><span class="n">yrshift</span><span class="p">,</span><span class="n">T0</span><span class="p">)</span> <span class="ow">in</span> <span class="n">listSpotsVisited</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">listSpotsVisited</span><span class="p">[(</span><span class="n">xrshift</span><span class="p">,</span><span class="n">yrshift</span><span class="p">,</span><span class="n">T0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">listSpotsVisited</span><span class="p">[(</span><span class="n">xrshift</span><span class="p">,</span><span class="n">yrshift</span><span class="p">,</span><span class="n">T0</span><span class="p">)]</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">print</span> <span class="s">&quot;spot (</span><span class="si">%f</span><span class="s">,</span><span class="si">%f</span><span class="s">) : number of visits : </span><span class="si">%i</span><span class="s"> times&quot;</span><span class="o">%</span><span class="p">(</span> <span class="n">xrshift</span><span class="p">,</span><span class="n">yrshift</span><span class="p">,</span> <span class="n">listSpotsVisited</span><span class="p">[(</span><span class="n">xrshift</span><span class="p">,</span><span class="n">yrshift</span><span class="p">,</span><span class="n">T0</span><span class="p">)])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">listSpotsVisited</span><span class="p">[(</span><span class="n">xrshift</span><span class="p">,</span><span class="n">yrshift</span><span class="p">,</span><span class="n">T0</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
                    
                
                <span class="k">if</span> <span class="n">weight</span> <span class="o">&lt;=</span> <span class="n">limitSmallWeights</span><span class="p">:</span>
                    <span class="n">countSmallWeights</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">logSpotsSmallWeights</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">xrshift</span><span class="p">,</span><span class="n">yrshift</span><span class="p">,</span><span class="n">T0</span><span class="p">,</span><span class="n">weight</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">countNotSmallWeights</span> <span class="o">+=</span> <span class="mi">1</span> 
                    <span class="n">sumNotSmallWeights</span> <span class="o">+=</span> <span class="n">weight</span>
                    
                <span class="k">if</span> <span class="n">weight</span> <span class="o">&lt;=</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">epsilon</span><span class="p">:</span>
                     
                    <span class="k">if</span> <span class="n">listSpotsDelivered</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">flagXYInList</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">indSpot</span> <span class="ow">in</span> <span class="n">listSpotsDelivered</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">dataSpot</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">indSpot</span><span class="p">):</span>
                                <span class="n">flagXYInList</span> <span class="o">=</span> <span class="mi">1</span>
                                <span class="k">print</span> <span class="s">&quot;Spot with weight 0. Original weight </span><span class="si">%f</span><span class="s">.&quot;</span><span class="o">%</span><span class="n">dataBeam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getPlannedWeightForSpotInd</span><span class="p">(</span><span class="n">indSpot</span><span class="p">)</span>
                                <span class="k">break</span>
                        <span class="k">if</span> <span class="n">flagXYInList</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">spotsVisitedButWeightNull</span> <span class="o">=</span> <span class="n">spotsVisitedButWeightNull</span> <span class="o">+</span> <span class="mi">1</span>
                            <span class="k">print</span> <span class="s">&quot;Weight null - already visited&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">unexplainedWeightNull</span> <span class="o">=</span> <span class="n">unexplainedWeightNull</span> <span class="o">+</span> <span class="mi">1</span>
                            <span class="k">print</span> <span class="s">&quot;Weight null - don&#39;t know why&quot;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">staticDelivery</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">compensationDynamic</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">staticDelivery</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="c">############# If Dynamic delivery #############</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">staticDelivery</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">dataSpot</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;NewEnergy&#39;</span> <span class="p">:</span>
                        <span class="n">prevSpot</span> <span class="o">=</span> <span class="p">[</span><span class="n">xrshift</span><span class="p">,</span><span class="n">yrshift</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">prevSpot</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">!=</span> <span class="n">yrshift</span> <span class="ow">and</span> <span class="p">(</span><span class="n">prevSpot</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="n">xrshift</span><span class="p">:</span>
                            <span class="n">deltaX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">prevSpot</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="n">xrshift</span><span class="p">)</span>
                            <span class="n">deltaY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">prevSpot</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="n">yrshift</span><span class="p">)</span>
                            <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">deltaX</span><span class="p">,</span> <span class="n">deltaY</span><span class="p">])</span> <span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">updateTime</span><span class="p">(</span><span class="s">&#39;MoveToSpot&#39;</span><span class="p">,</span><span class="n">info</span><span class="o">=</span><span class="n">dist</span><span class="p">)</span>                
                <span class="c">############# If Dynamic delivery #############</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">staticDelivery</span><span class="p">:</span>
                    <span class="c">####################&quot;</span>
                    <span class="c">#### Compensation</span>
                    <span class="c">####################&quot;</span>
                
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">compensationDynamic</span><span class="p">:</span>
                        <span class="k">print</span><span class="s">&quot;Start compensation&quot;</span>
                        <span class="p">(</span><span class="n">dispVec_IECFixed</span> <span class="p">,</span><span class="n">dispVec_IECG</span><span class="p">,</span><span class="n">dispVec_CT</span><span class="p">,</span><span class="n">indDispCT</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computeDisplacementVectors</span><span class="p">(</span><span class="n">useMotionMonitor</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)[</span><span class="s">&#39;MeasuredMotion&#39;</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">updateTime</span><span class="p">(</span><span class="s">&#39;Displacement Measure&#39;</span><span class="p">)</span>
                        <span class="n">pointX</span> <span class="o">=</span> <span class="p">(</span><span class="n">xrshift</span> <span class="o">-</span> <span class="n">dispVec_IECG</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mf">10.0</span> <span class="c">#convert from cm to mm</span>
                        <span class="n">pointY</span> <span class="o">=</span> <span class="p">(</span><span class="n">yrshift</span> <span class="o">-</span> <span class="n">dispVec_IECG</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="mf">10.0</span> <span class="c">#convert from cm to mm</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">motion3D</span><span class="p">:</span>
                            <span class="n">energyForCompens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddCurvesData</span><span class="o">.</span><span class="n">findEnergyForBraggPeak</span><span class="p">(</span><span class="n">dmax</span> <span class="o">+</span> <span class="n">dispVec_IECG</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="c">## Double check depth</span>
                            <span class="k">if</span> <span class="n">energyForCompens</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                                <span class="k">print</span> <span class="s">&quot;Spot cannot be compensated: no energy achievable for BP </span><span class="si">%f</span><span class="s"> cm!</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">dmax</span> <span class="o">+</span> <span class="n">dispVec_IECG</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                                <span class="n">dataBeam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">updateSpot</span><span class="p">(</span><span class="n">dataSpot</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                                <span class="n">nbMissedSpots</span> <span class="o">=</span> <span class="n">nbMissedSpots</span> <span class="o">+</span> <span class="mi">1</span>
                                <span class="k">print</span> <span class="s">&quot;End Slice compensation&quot;</span>
                                <span class="k">continue</span>
                            <span class="n">energyForCompens</span> <span class="o">=</span> <span class="n">dataBeam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">findCorrespondingEnergy</span><span class="p">(</span><span class="n">energyForCompens</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">energyForCompens</span> <span class="o">=</span> <span class="n">T0</span>
                        <span class="k">if</span> <span class="n">energyForCompens</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">neighbor</span> <span class="o">=</span> <span class="n">dataBeam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isPointNearOtherSpot</span><span class="p">(</span><span class="n">energyForCompens</span><span class="p">,</span><span class="n">pointX</span><span class="p">,</span> <span class="n">pointY</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">neighbor</span> <span class="o">=</span> <span class="p">[</span><span class="bp">False</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">neighbor</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="n">locationNeighbors</span> <span class="o">=</span> <span class="n">dataBeam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">locateSpots</span><span class="p">(([</span><span class="n">xrshift</span><span class="o">*</span><span class="mf">10.0</span><span class="p">,</span><span class="n">pointX</span><span class="p">,</span><span class="n">neighbor</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]],[</span><span class="n">yrshift</span><span class="o">*</span><span class="mf">10.0</span><span class="p">,</span><span class="n">pointY</span><span class="p">,</span><span class="n">neighbor</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]]))</span>
                            <span class="n">viewer2D</span><span class="o">.</span><span class="n">displayImageFromArray</span><span class="p">(</span> <span class="n">locationNeighbors</span><span class="p">,</span> <span class="s">&quot;Neighbours in energy slice&quot;</span><span class="p">)</span>
                            <span class="n">filenameNeighbors</span> <span class="o">=</span> <span class="s">&quot;Neighbors</span><span class="si">%0.9d</span><span class="s">_</span><span class="si">%0.3d</span><span class="s">MeV&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">idxSpot</span><span class="p">,</span><span class="n">T0_round</span><span class="p">)</span>
                            <span class="n">viewer2D</span><span class="o">.</span><span class="n">saveFigure</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pathToOutputImages</span> <span class="o">+</span> <span class="s">&quot;Neighbors/&quot;</span><span class="p">,</span><span class="n">filenameNeighbors</span> <span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="s">&#39;png&#39;</span><span class="p">,</span> <span class="n">subplotIdx</span> <span class="o">=</span> <span class="mi">111</span><span class="p">)</span>
                            <span class="n">viewer2D</span><span class="o">.</span><span class="n">closePlot</span><span class="p">()</span>
                            
                            <span class="n">newWeight</span> <span class="o">=</span> <span class="n">dataBeam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getWeightForSpotInd</span><span class="p">(</span><span class="n">neighbor</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="n">compensated</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="n">nbCompensatedSpots</span> <span class="o">=</span> <span class="n">nbCompensatedSpots</span> <span class="o">+</span> <span class="mi">1</span>
                            <span class="n">dictRepaintStat</span><span class="p">[</span><span class="n">angle</span><span class="p">][</span><span class="n">T0_round</span><span class="p">][</span><span class="n">dataSpot</span><span class="p">[</span><span class="mi">8</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">print</span> <span class="s">&quot;Compensation is possible!&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">print</span> <span class="s">&quot;Spot cannot be compensated: no spot position found</span><span class="se">\n</span><span class="s">&quot;</span>
                            <span class="n">dataBeam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">updateSpot</span><span class="p">(</span><span class="n">dataSpot</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="n">nbMissedSpots</span> <span class="o">=</span> <span class="n">nbMissedSpots</span> <span class="o">+</span> <span class="mi">1</span>
                            <span class="k">print</span> <span class="s">&quot;End Slice compensation&quot;</span>
                            <span class="k">continue</span>
                        
                        
                        <span class="k">print</span> <span class="s">&quot;End Slice compensation&quot;</span>
                        <span class="k">if</span> <span class="n">compensated</span><span class="p">:</span>
                            <span class="n">weight</span> <span class="o">=</span> <span class="n">newWeight</span>
                            
                        
                        <span class="k">exec</span> <span class="s">&quot;timeToSpendAtSpot = self.timeDeliverSpotWeight(np.</span><span class="si">%s</span><span class="s">(weight))&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span>
                        <span class="k">if</span>  <span class="n">timeToSpendAtSpot</span> <span class="o">&gt;</span> <span class="mf">1e-3</span><span class="p">:</span>
                            <span class="k">print</span> <span class="s">&quot;Time to spent at current spot is: </span><span class="si">%e</span><span class="s"> s&quot;</span><span class="o">%</span><span class="n">timeToSpendAtSpot</span>


                    <span class="c">####################&quot;</span>
                    <span class="c">#### End compensation</span>
                    <span class="c">####################&quot;</span>
                                
                <span class="c">############# End - If Dynamic delivery #######</span>
                <span class="c">####################&quot;</span>
                <span class="c">####    End  code for scanning path optimization</span>
                <span class="c">####################&quot;                </span>
                
                <span class="c">#Get number of loops to deliver each unit time</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">staticDelivery</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">motionDuringBeam</span><span class="p">:</span>
                    <span class="n">loopsDeliv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberOfUnitTimeToDeliverWeight</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">loopsDeliv</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">weight</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">compensated</span><span class="p">:</span>
                    <span class="n">tupleIndices</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">neighbor</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">tupleCoord</span> <span class="o">=</span> <span class="p">(</span><span class="n">neighbor</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">10.0</span><span class="p">,</span><span class="n">neighbor</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">10.0</span><span class="p">)</span>
                    <span class="n">verifyCompensation</span> <span class="o">=</span> <span class="bp">True</span>
                    
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">tupleIndices</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">dataSpot</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">tupleCoord</span> <span class="o">=</span> <span class="p">(</span><span class="n">xrshift</span><span class="p">,</span><span class="n">yrshift</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">listSpotsDelivered</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">tupleIndices</span> <span class="ow">in</span> <span class="n">listSpotsDelivered</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">listSpotsDelivered</span><span class="p">[</span><span class="n">tupleIndices</span><span class="p">][</span><span class="s">&#39;visits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">listSpotsDelivered</span><span class="p">[</span><span class="n">tupleIndices</span><span class="p">][</span><span class="s">&#39;visits&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="n">listSpotsDelivered</span><span class="p">[</span><span class="n">tupleIndices</span><span class="p">][</span><span class="s">&#39;sumWeight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">listSpotsDelivered</span><span class="p">[</span><span class="n">tupleIndices</span><span class="p">][</span><span class="s">&#39;sumWeight&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">weight</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">listSpotsDelivered</span><span class="p">[</span><span class="n">tupleIndices</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;visits&#39;</span><span class="p">:</span><span class="mi">1</span> <span class="p">,</span> <span class="s">&#39;sumWeight&#39;</span><span class="p">:</span><span class="n">weight</span> <span class="p">,</span><span class="s">&#39;coord&#39;</span><span class="p">:</span><span class="n">tupleCoord</span><span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">listSpotsDelivered</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="n">listSpotsDelivered</span><span class="p">[</span><span class="n">tupleIndices</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;visits&#39;</span><span class="p">:</span><span class="mi">1</span> <span class="p">,</span> <span class="s">&#39;sumWeight&#39;</span><span class="p">:</span><span class="n">weight</span> <span class="p">,</span><span class="s">&#39;coord&#39;</span><span class="p">:</span><span class="n">tupleCoord</span><span class="p">}</span>
                    
                <span class="k">print</span> <span class="s">&quot;Nb of time units for current weight: </span><span class="si">%i</span><span class="s">&quot;</span><span class="o">%</span><span class="n">loopsDeliv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">staticDelivery</span><span class="p">:</span>
                    <span class="n">prevDispIndices</span> <span class="o">=</span> <span class="bp">None</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">skipSaveBeamlets</span><span class="p">:</span>
                    <span class="n">beamletDoseDistrib</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DensityGrid</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="s">&#39;C&#39;</span><span class="p">)</span>
                
                
                <span class="k">for</span> <span class="n">loopIdx</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">loopsDeliv</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>   
                    <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">----- # of time units: </span><span class="si">%i</span><span class="s"> / </span><span class="si">%i</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">loopIdx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">loopsDeliv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    
                    <span class="k">if</span> <span class="n">loopIdx</span> <span class="o">&lt;</span> <span class="n">loopsDeliv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">weightLoop</span> <span class="o">=</span> <span class="n">loopsDeliv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">weightLoop</span> <span class="o">=</span> <span class="n">loopsDeliv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="c">############## If Dynamic delivery #############</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">staticDelivery</span><span class="p">:</span>
                        
                        <span class="p">(</span><span class="n">dispVec_IECFixed</span> <span class="p">,</span><span class="n">dispVec_IECG</span><span class="p">,</span><span class="n">dispVec_CT</span><span class="p">,</span><span class="n">indDispCT</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computeDisplacementVectors</span><span class="p">()</span>
                         
                        <span class="bp">self</span><span class="o">.</span><span class="n">_dynaPatientLoc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">getPatientExtentInDynamicModel</span><span class="p">(</span><span class="n">dispVec_CT</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span>  <span class="bp">self</span><span class="o">.</span><span class="n">isPatientInTheVolume</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">shape</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">_dynaPatientLoc</span><span class="p">):</span>
                            <span class="n">strErr</span> <span class="o">=</span> <span class="s">&quot;Shifted patient is outside the volume defined &quot;</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">strErr</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_StPwrRatioGrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">funcGetDataPatient</span><span class="p">(</span><span class="s">&#39;stpPwrRatio&#39;</span><span class="p">,</span><span class="n">dispVec_CT</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_DensityGrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">funcGetDataPatient</span><span class="p">(</span><span class="s">&#39;density&#39;</span><span class="p">,</span><span class="n">dispVec_CT</span><span class="p">)</span> 
        
                        <span class="k">if</span> <span class="n">prevDispIndices</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">prevDispIndices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">prevDispIndices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">indDispCT</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> \
                                                                                      <span class="n">prevDispIndices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">indDispCT</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> \
                                                                                      <span class="n">prevDispIndices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">indDispCT</span><span class="p">[</span><span class="mi">2</span><span class="p">])):</span>
                            <span class="n">targetIECG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xrshift</span><span class="p">,</span><span class="n">yrshift</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span><span class="c"># target point in isocenter frame</span>
                            <span class="n">targetIECF</span> <span class="o">=</span>  <span class="n">mathTools</span><span class="o">.</span><span class="n">rotateCoordinates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rotMatrix</span><span class="p">,</span><span class="n">targetIECG</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>
                            <span class="n">sourceIECG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">sourceLocation</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span><span class="n">dtype</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">useFastRadiolDepth_DynaDeliv</span><span class="p">:</span>
                                <span class="n">nbPositionsX</span> <span class="o">=</span> <span class="mi">2</span>
                                <span class="n">nbPositionsY</span> <span class="o">=</span> <span class="mi">2</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_radiolDepth</span><span class="p">,</span><span class="n">ssd0</span><span class="p">,</span><span class="n">listIndices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">computeLocalizedRadiologicalDepth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_startVec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_incVec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sourceVec</span><span class="p">,</span>\
                                                        <span class="n">sourceIECG</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_rotMatrix</span><span class="p">,</span><span class="n">Xr</span><span class="p">,</span><span class="n">Yr</span><span class="p">,</span><span class="n">Zr</span><span class="p">,</span><span class="n">xrshift</span><span class="p">,</span><span class="n">yrshift</span><span class="p">,</span> \
                                                        <span class="n">nbPositionsX</span> <span class="o">=</span> <span class="n">nbPositionsX</span><span class="p">,</span><span class="n">nbPositionsY</span> <span class="o">=</span> <span class="n">nbPositionsY</span><span class="p">,</span> <span class="n">dispVec</span> <span class="o">=</span> <span class="n">dispVec_CT</span><span class="p">,</span> <span class="n">ener</span> <span class="o">=</span> <span class="n">T0_round</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_radiolDepth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">computeRadiologicalDepth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_startVec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_incVec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sourceVec</span><span class="p">,</span> <span class="n">dispVec</span> <span class="o">=</span> <span class="n">dispVec_CT</span> <span class="p">,</span> <span class="n">ener</span> <span class="o">=</span> <span class="n">T0_round</span><span class="p">)</span>
                                <span class="n">patientMask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DensityGrid</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span> <span class="s">&#39;int8&#39;</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span> 
                                <span class="n">patientMask</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dynaPatientLoc</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                                <span class="n">ssd0</span><span class="p">,</span> <span class="n">listIndices</span><span class="p">,</span><span class="n">listLenVoxels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">calculateSSD0</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sourceVec</span><span class="p">,</span><span class="n">targetIECF</span><span class="p">,</span><span class="n">Xr</span><span class="p">,</span><span class="n">Yr</span><span class="p">,</span><span class="n">Zr</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_DensityGrid</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_startVec</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_incVec</span><span class="p">,</span><span class="n">sourceIECG</span><span class="p">,</span><span class="n">patientMask</span><span class="p">)</span>
                            
                            <span class="n">prevDispIndices</span> <span class="o">=</span> <span class="n">indDispCT</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">print</span> <span class="s">&quot;No need to update radiol depth: indices of the displacement vector didn&#39;t change.&quot;</span>
                        
                        <span class="c">#In dynamic the first computation of self._subVol returned None and X,Y,Z, X_iec, Y_iec, Z_iec and Xr, Yr,Zr have been computed for the entire volume.</span>
                        <span class="n">Xr_tmp</span> <span class="o">=</span> <span class="n">Xr</span> 
                        <span class="n">Yr_tmp</span> <span class="o">=</span> <span class="n">Yr</span> 
                        <span class="n">Zr_tmp</span> <span class="o">=</span> <span class="n">Zr</span> 
                        <span class="k">print</span> <span class="s">&quot;Displacement vector (f,r,c) in CT image:</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">indDispCT</span><span class="p">)</span>
                        
                    <span class="c">############ End - If Dynamic delivery ############# </span>
                    <span class="k">else</span><span class="p">:</span> <span class="c">#Static</span>
                        <span class="n">Xr_tmp</span> <span class="o">=</span> <span class="n">Xr</span>
                        <span class="n">Yr_tmp</span> <span class="o">=</span> <span class="n">Yr</span>
                        <span class="n">Zr_tmp</span> <span class="o">=</span> <span class="n">Zr</span>
                        <span class="n">dispVec</span> <span class="o">=</span> <span class="bp">None</span>
                        <span class="n">patientMask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">getPatientMask</span><span class="p">()</span>
                        <span class="n">targetIECG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xrshift</span><span class="p">,</span><span class="n">yrshift</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span><span class="c"># target point in isocenter frame</span>
                        <span class="n">targetIECF</span> <span class="o">=</span>  <span class="n">mathTools</span><span class="o">.</span><span class="n">rotateCoordinates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rotMatrix</span><span class="p">,</span><span class="n">targetIECG</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>
                        <span class="n">sourceIECG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">sourceLocation</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span><span class="n">dtype</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span>
                        <span class="n">ssd0</span><span class="p">,</span> <span class="n">listIndices</span><span class="p">,</span><span class="n">listLenVoxels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">calculateSSD0</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sourceVec</span><span class="p">,</span><span class="n">targetIECF</span><span class="p">,</span><span class="n">Xr_tmp</span><span class="p">,</span><span class="n">Yr_tmp</span><span class="p">,</span><span class="n">Zr_tmp</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_DensityGrid</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_startVec</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_incVec</span><span class="p">,</span><span class="n">sourceIECG</span><span class="p">,</span><span class="n">patientMask</span><span class="p">)</span>
                    
                    <span class="n">t_start_beamlet</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                
                    
                    <span class="n">computedDoseRaw</span> <span class="o">=</span> <span class="n">beamletSimul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DensityGrid</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_StPwrRatioGrid</span><span class="p">,</span>\
                                     <span class="n">Xr_tmp</span><span class="p">,</span><span class="n">Yr_tmp</span><span class="p">,</span><span class="n">Zr_tmp</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dmax</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">),</span>\
                                     <span class="n">z_dd</span><span class="p">,</span><span class="n">dd</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sig0</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">),</span>\
                                     <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xrshift</span> <span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">),</span>\
                                     <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yrshift</span> <span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sourceLocation</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>\
                                     <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ssd0</span> <span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">_radiolDepth</span><span class="p">,</span><span class="n">listIndices</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_x0y0z0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_IECFSpacing</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_rotMatrix</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>


                    <span class="n">t_end_beamlet</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                    <span class="k">print</span> <span class="s">&quot;Beamlet simul in </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">t_end_beamlet</span> <span class="o">-</span> <span class="n">t_start_beamlet</span><span class="p">)</span>
                    
                
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">staticDelivery</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">compensationDynamic</span><span class="p">:</span>
                            <span class="n">indexForVerification</span> <span class="o">=</span> <span class="n">idxSpot</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">indexForVerification</span> <span class="o">=</span> <span class="n">nbCompensatedSpots</span>
                    
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">staticDelivery</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">evaluateDiffStatDyna</span> <span class="ow">and</span> <span class="n">loopIdx</span> <span class="o">==</span> <span class="n">loopsDeliv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="n">indexForVerification</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">indexForVerification</span><span class="o">%</span><span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">compensated</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">verifyCompensation</span><span class="p">:</span> 
                                <span class="p">(</span><span class="n">xStat</span> <span class="p">,</span> <span class="n">yStat</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">neighbor</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">10.0</span><span class="p">,</span><span class="n">neighbor</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">10.0</span><span class="p">)</span>
                                <span class="n">nameEvaluationText</span>  <span class="o">=</span> <span class="s">&quot;EvaluationCompensation.txt&quot;</span>
                                <span class="n">outputEvalImages</span> <span class="o">=</span> <span class="s">&#39;CompensatedBeamlet&#39;</span>
                                <span class="n">titleFig</span> <span class="o">=</span> <span class="s">&#39;Compensation &#39;</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">motion3D</span><span class="p">:</span>
                                    <span class="n">dmax_stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddCurvesData</span><span class="o">.</span><span class="n">dataForEnergy</span><span class="p">(</span><span class="s">&#39;BraggPeak&#39;</span> <span class="p">,</span> <span class="n">energyForCompens</span><span class="p">)</span>
                                    <span class="n">z_dd_stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddCurvesData</span><span class="o">.</span><span class="n">dataForEnergy</span><span class="p">(</span><span class="s">&#39;DD_Curve&#39;</span> <span class="p">,</span>  <span class="n">energyForCompens</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>
                                    <span class="n">dd_stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddCurvesData</span><span class="o">.</span><span class="n">dataForEnergy</span><span class="p">(</span><span class="s">&#39;DD_Curve&#39;</span> <span class="p">,</span> <span class="n">energyForCompens</span><span class="p">)[</span><span class="mi">1</span><span class="p">,:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">dmax_stat</span> <span class="o">=</span> <span class="n">dmax</span>
                                    <span class="n">z_dd_stat</span> <span class="o">=</span> <span class="n">z_dd</span>
                                    <span class="n">dd_stat</span> <span class="o">=</span> <span class="n">dd</span>
                        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">compensationDynamic</span><span class="p">:</span>
                            <span class="p">(</span><span class="n">xStat</span> <span class="p">,</span> <span class="n">yStat</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">xrshift</span><span class="p">,</span><span class="n">yrshift</span><span class="p">)</span>
                            <span class="n">nameEvaluationText</span>  <span class="o">=</span> <span class="s">&quot;EvaluationNoCompensation.txt&quot;</span>
                            <span class="n">outputEvalImages</span> <span class="o">=</span> <span class="s">&#39;NotCompensatedBeamlet&#39;</span>
                            <span class="n">titleFig</span> <span class="o">=</span> <span class="s">&#39;Motion &#39;</span>
                            <span class="n">dmax_stat</span> <span class="o">=</span> <span class="n">dmax</span>
                            <span class="n">z_dd_stat</span> <span class="o">=</span> <span class="n">z_dd</span>
                            <span class="n">dd_stat</span> <span class="o">=</span> <span class="n">dd</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;in dynamic delivery - wrong choice for result evaluation!&quot;</span><span class="p">)</span>
                        
                        
                        
                        <span class="n">beamletStatic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computeBeamletStatic</span><span class="p">(</span><span class="n">Xr</span><span class="p">,</span><span class="n">Yr</span><span class="p">,</span><span class="n">Zr</span><span class="p">,</span><span class="n">dmax_stat</span><span class="p">,</span><span class="n">z_dd_stat</span><span class="p">,</span><span class="n">dd_stat</span><span class="p">,</span><span class="n">sig0</span><span class="p">,</span><span class="n">xStat</span>  <span class="p">,</span><span class="n">yStat</span><span class="p">,</span><span class="n">sourceLocation</span><span class="p">)</span>
                        
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">motion3D</span><span class="p">:</span>

                            <span class="n">tmpComputedDoseRaw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">computedDoseRaw</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> 
                            <span class="n">indicesCompDose</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">computedDoseRaw</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="n">newIndCompDose</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="n">indicesCompDose</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">indDispCT</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">indicesCompDose</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">indDispCT</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">indicesCompDose</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">indDispCT</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                            <span class="n">tmpComputedDoseRaw</span><span class="p">[</span><span class="n">newIndCompDose</span><span class="p">]</span> <span class="o">=</span> <span class="n">computedDoseRaw</span><span class="p">[</span><span class="n">indicesCompDose</span><span class="p">]</span>
                        
                            <span class="n">dataStatic</span> <span class="o">=</span> <span class="n">beamletStatic</span>
                            <span class="n">dataDyna</span> <span class="o">=</span> <span class="n">tmpComputedDoseRaw</span>
                        <span class="k">else</span><span class="p">:</span>
                            
                            
                            <span class="n">staticLoc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">getPatientExtentInStaticModel</span><span class="p">()</span>
                                                 
                            <span class="n">dataStatic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">computedDoseRaw</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                            <span class="n">dataDyna</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">computedDoseRaw</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                            
                            <span class="n">patientLoc</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">staticLoc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynaPatientLoc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dynaPatientLoc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">,</span>\
                                        <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">staticLoc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynaPatientLoc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dynaPatientLoc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">,</span>\
                                        <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">staticLoc</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynaPatientLoc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dynaPatientLoc</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">)</span>
                            
                            <span class="n">dataStatic</span><span class="p">[</span><span class="n">patientLoc</span><span class="p">]</span> <span class="o">=</span> <span class="n">beamletStatic</span><span class="p">[</span><span class="n">staticLoc</span><span class="p">]</span>
                            <span class="n">dataDyna</span><span class="p">[</span><span class="n">patientLoc</span><span class="p">]</span> <span class="o">=</span> <span class="n">computedDoseRaw</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dynaPatientLoc</span><span class="p">]</span>
                        
                        <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">*********Beamlet evaluation*********&quot;</span>
                        <span class="n">valuesEval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tool</span><span class="o">.</span><span class="n">evaluateDifference</span><span class="p">(</span><span class="n">dataStatic</span><span class="p">,</span> <span class="n">dataDyna</span><span class="p">)</span>
                        <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">******************&quot;</span>
                        
                        <span class="bp">self</span><span class="o">.</span><span class="n">_tool</span><span class="o">.</span><span class="n">showHotColdSpots</span><span class="p">(</span><span class="n">dataStatic</span><span class="p">,</span> <span class="n">dataDyna</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;Hot and cold spots&#39;</span> <span class="p">,</span> <span class="n">pathToSaveImg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">mainPath</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">nameSimulation</span> <span class="o">+</span> <span class="s">&#39;HotColdSpotsBeamlets/&#39;</span><span class="o">+</span><span class="s">&#39;HotAndColdSpots_Spot</span><span class="si">%0.9d</span><span class="s">_loop</span><span class="si">%0.9d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">idxSpot</span><span class="p">,</span><span class="n">loopIdx</span><span class="p">))</span>
                        
                        <span class="n">dataHotColdSpots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">hotAndColdSpotsPerStrcuture</span><span class="p">(</span><span class="n">dataStatic</span><span class="p">,</span> <span class="n">dataDyna</span><span class="p">,</span> <span class="n">unpadded</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">dataHotColdSpots</span><span class="p">:</span>
                            <span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> :</span><span class="se">\n\t</span><span class="s">#of voxels: </span><span class="si">%i</span><span class="s"> , </span><span class="se">\n\t</span><span class="s">#of hot spot:</span><span class="si">%i</span><span class="s"> ( </span><span class="si">%0.3f</span><span class="s"> </span><span class="si">%%</span><span class="s">) , </span><span class="se">\n\t</span><span class="s">#of cold spots:</span><span class="si">%i</span><span class="s"> (</span><span class="si">%0.3f</span><span class="s"> </span><span class="si">%%</span><span class="s">), </span><span class="se">\n\t</span><span class="s">#of correct spots:</span><span class="si">%i</span><span class="s"> (</span><span class="si">%0.3f</span><span class="s"> </span><span class="si">%%</span><span class="s">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">roi</span><span class="p">,</span><span class="n">dataHotColdSpots</span><span class="p">[</span><span class="n">roi</span><span class="p">][</span><span class="s">&#39;nbVoxels&#39;</span><span class="p">],</span>\
                            <span class="n">dataHotColdSpots</span><span class="p">[</span><span class="n">roi</span><span class="p">][</span><span class="s">&#39;nbHotSpots&#39;</span><span class="p">],</span>\
                            <span class="n">dataHotColdSpots</span><span class="p">[</span><span class="n">roi</span><span class="p">][</span><span class="s">&#39;percHotSpots&#39;</span><span class="p">],</span>\
                            <span class="n">dataHotColdSpots</span><span class="p">[</span><span class="n">roi</span><span class="p">][</span><span class="s">&#39;nbColdSpots&#39;</span><span class="p">],</span>\
                            <span class="n">dataHotColdSpots</span><span class="p">[</span><span class="n">roi</span><span class="p">][</span><span class="s">&#39;percColdSpots&#39;</span><span class="p">],</span>\
                            <span class="n">dataHotColdSpots</span><span class="p">[</span><span class="n">roi</span><span class="p">][</span><span class="s">&#39;nbCorrectSpots&#39;</span><span class="p">],</span>\
                            <span class="n">dataHotColdSpots</span><span class="p">[</span><span class="n">roi</span><span class="p">][</span><span class="s">&#39;percCorrectSpots&#39;</span><span class="p">])</span>
                        
                        
                        <span class="k">if</span> <span class="p">(</span><span class="n">compensated</span> <span class="ow">and</span> <span class="n">nbCompensatedSpots</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span><span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">compensationDynamic</span> <span class="ow">and</span> <span class="n">idxSpot</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> 
                            <span class="n">fileOption</span> <span class="o">=</span> <span class="s">&#39;wb&#39;</span>
                            <span class="n">textToWrite</span> <span class="o">=</span> <span class="s">&#39;Ener</span><span class="se">\t</span><span class="s">Spot</span><span class="se">\t</span><span class="s">ShiftX</span><span class="se">\t</span><span class="s">ShiftY</span><span class="se">\t</span><span class="s">ShiftZ</span><span class="se">\t</span><span class="s">Sens</span><span class="se">\t</span><span class="s">Spec</span><span class="se">\t</span><span class="s">Jac&#39;</span><span class="o">+</span>\
                            <span class="s">&#39;</span><span class="se">\t</span><span class="s">MinStat</span><span class="se">\t</span><span class="s">MaxStat</span><span class="se">\t</span><span class="s">AvgStat</span><span class="se">\t</span><span class="s">StdStat&#39;</span><span class="o">+</span>\
                            <span class="s">&#39;</span><span class="se">\t</span><span class="s">MinDyna</span><span class="se">\t</span><span class="s">MaxDyna</span><span class="se">\t</span><span class="s">AvgDyna</span><span class="se">\t</span><span class="s">StdDyna</span><span class="se">\t</span><span class="s">DiffMax</span><span class="se">\t</span><span class="s">DiffAvg</span><span class="se">\t</span><span class="s">DiffStd</span><span class="se">\n</span><span class="s">&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">fileOption</span> <span class="o">=</span> <span class="s">&#39;a&#39;</span>
                            <span class="n">textToWrite</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                        <span class="n">fileOutput</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">mainPath</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">nameSimulation</span> <span class="o">+</span> <span class="n">nameEvaluationText</span>
                        
                        <span class="n">textHeader</span> <span class="o">=</span><span class="s">&#39;</span><span class="si">%0.2f</span><span class="se">\t</span><span class="si">%i</span><span class="se">\t</span><span class="si">%0.3f</span><span class="se">\t</span><span class="si">%0.3f</span><span class="se">\t</span><span class="si">%0.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">T0</span><span class="p">,</span><span class="n">idxSpot</span><span class="p">,</span><span class="n">dispVec_CT</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dispVec_CT</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">dispVec_CT</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                        <span class="n">resEvalValues</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\t</span><span class="si">%0.3f</span><span class="se">\t</span><span class="si">%0.3f</span><span class="se">\t</span><span class="si">%0.3f</span><span class="se">\t</span><span class="si">%0.3f</span><span class="se">\t</span><span class="si">%0.3f</span><span class="se">\t</span><span class="si">%0.3f</span><span class="se">\t</span><span class="si">%0.3f</span><span class="se">\t</span><span class="si">%0.3f</span><span class="se">\t</span><span class="si">%0.3f</span><span class="se">\t</span><span class="si">%0.3f</span><span class="se">\t</span><span class="si">%0.3f</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">valuesEval</span><span class="p">[</span><span class="s">&#39;vol1&#39;</span><span class="p">][</span><span class="s">&#39;min&#39;</span><span class="p">],</span><span class="n">valuesEval</span><span class="p">[</span><span class="s">&#39;vol1&#39;</span><span class="p">][</span><span class="s">&#39;max&#39;</span><span class="p">],</span><span class="n">valuesEval</span><span class="p">[</span><span class="s">&#39;vol1&#39;</span><span class="p">][</span><span class="s">&#39;avg&#39;</span><span class="p">],</span><span class="n">valuesEval</span><span class="p">[</span><span class="s">&#39;vol1&#39;</span><span class="p">][</span><span class="s">&#39;std&#39;</span><span class="p">],</span><span class="n">valuesEval</span><span class="p">[</span><span class="s">&#39;vol2&#39;</span><span class="p">][</span><span class="s">&#39;min&#39;</span><span class="p">],</span><span class="n">valuesEval</span><span class="p">[</span><span class="s">&#39;vol2&#39;</span><span class="p">][</span><span class="s">&#39;max&#39;</span><span class="p">],</span><span class="n">valuesEval</span><span class="p">[</span><span class="s">&#39;vol2&#39;</span><span class="p">][</span><span class="s">&#39;avg&#39;</span><span class="p">],</span><span class="n">valuesEval</span><span class="p">[</span><span class="s">&#39;vol2&#39;</span><span class="p">][</span><span class="s">&#39;std&#39;</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">valuesEval</span><span class="p">[</span><span class="s">&#39;vol1&#39;</span><span class="p">][</span><span class="s">&#39;max&#39;</span><span class="p">]</span><span class="o">-</span> <span class="n">valuesEval</span><span class="p">[</span><span class="s">&#39;vol2&#39;</span><span class="p">][</span><span class="s">&#39;max&#39;</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">valuesEval</span><span class="p">[</span><span class="s">&#39;vol1&#39;</span><span class="p">][</span><span class="s">&#39;avg&#39;</span><span class="p">]</span><span class="o">-</span> <span class="n">valuesEval</span><span class="p">[</span><span class="s">&#39;vol2&#39;</span><span class="p">][</span><span class="s">&#39;avg&#39;</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">valuesEval</span><span class="p">[</span><span class="s">&#39;vol1&#39;</span><span class="p">][</span><span class="s">&#39;std&#39;</span><span class="p">]</span><span class="o">-</span> <span class="n">valuesEval</span><span class="p">[</span><span class="s">&#39;vol2&#39;</span><span class="p">][</span><span class="s">&#39;std&#39;</span><span class="p">]))</span>
                        
                        <span class="n">textToWrite</span> <span class="o">=</span>  <span class="n">textToWrite</span> <span class="o">+</span> <span class="n">textHeader</span> <span class="o">+</span> <span class="n">resEvalValues</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fileOutput</span><span class="p">,</span> <span class="n">fileOption</span><span class="p">)</span> <span class="k">as</span> <span class="n">myFile</span><span class="p">:</span>
                            <span class="n">myFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">textToWrite</span><span class="p">)</span>
                        
                        
                        <span class="n">indStat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dataStatic</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="n">frameStat</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">indStat</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">indStat</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">motion3D</span><span class="p">:</span>
                            <span class="n">indDyna</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dataDyna</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="n">frameDyna</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">indDyna</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">indDyna</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">frameDyna</span> <span class="o">=</span> <span class="n">frameStat</span>
                            
                        <span class="n">viewer2D</span><span class="o">.</span><span class="n">display2ImagesFromArray</span><span class="p">(</span> <span class="n">dataStatic</span><span class="p">[</span><span class="n">frameStat</span><span class="p">],</span> <span class="n">dataDyna</span><span class="p">[</span><span class="n">frameDyna</span><span class="p">],</span> <span class="s">&quot;Beamlet Static: target(</span><span class="si">%0.3f</span><span class="s">,</span><span class="si">%0.3f</span><span class="s">) - frame:</span><span class="si">%i</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">xStat</span> <span class="p">,</span> <span class="n">yStat</span><span class="p">,</span><span class="n">frameStat</span><span class="p">),</span> <span class="s">&quot;Beamlet Dynamic: target(</span><span class="si">%0.3f</span><span class="s">,</span><span class="si">%0.3f</span><span class="s">) - frame:</span><span class="si">%i</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">xrshift</span><span class="p">,</span><span class="n">yrshift</span><span class="p">,</span><span class="n">frameDyna</span><span class="p">),</span><span class="n">titleFig</span><span class="o">+</span><span class="s">&quot; observation&quot;</span><span class="p">)</span>
                        <span class="n">filenameBeamlets</span> <span class="o">=</span> <span class="n">outputEvalImages</span><span class="o">+</span><span class="s">&quot;</span><span class="si">%0.9d</span><span class="s">_frames</span><span class="si">%0.4d</span><span class="s">_and_</span><span class="si">%0.4d</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">idxSpot</span><span class="p">,</span><span class="n">frameStat</span><span class="p">,</span><span class="n">frameDyna</span><span class="p">)</span>
                        <span class="n">viewer2D</span><span class="o">.</span><span class="n">saveFigure</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pathToOutputImages</span> <span class="o">+</span> <span class="n">outputEvalImages</span><span class="o">+</span><span class="s">&quot;s/&quot;</span><span class="p">,</span><span class="n">filenameBeamlets</span> <span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="s">&#39;png&#39;</span><span class="p">)</span>
                        <span class="n">viewer2D</span><span class="o">.</span><span class="n">closePlot</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">compensated</span><span class="p">:</span>  
                            <span class="k">if</span> <span class="n">verifyCompensation</span><span class="p">:</span>
                                <span class="n">verifyCompensation</span> <span class="o">=</span> <span class="bp">False</span>

                    <span class="c">############# If Dynamic delivery #############</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">staticDelivery</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">updateTime</span><span class="p">(</span><span class="s">&#39;Delivery&#39;</span><span class="p">,</span><span class="n">info</span> <span class="o">=</span> <span class="n">weightLoop</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">storeInterDoseDens</span><span class="p">:</span>
                            <span class="n">dVec</span> <span class="o">=</span> <span class="n">dispVec_IECG</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">dVec</span> <span class="o">=</span> <span class="bp">None</span>
                        <span class="n">computedDose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processDynamicDoseDistrib</span><span class="p">(</span><span class="n">computedDoseRaw</span><span class="p">,</span> <span class="n">T0_round</span><span class="p">,</span> <span class="n">dispVec</span> <span class="o">=</span> <span class="n">dVec</span><span class="p">)</span>
                    <span class="c">############# End - If Dynamic delivery #######</span>
                    <span class="k">else</span><span class="p">:</span>
                        
                        <span class="n">computedDose</span> <span class="o">=</span> <span class="n">computedDoseRaw</span>
    
                    <span class="c">#Find Bragg Peak</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">findBraggPeak</span><span class="p">(</span><span class="n">computedDose</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_radiolDepth</span><span class="p">)</span>
        
                    <span class="n">correcFactor</span> <span class="o">=</span>  <span class="n">doseCorrectionFactor</span><span class="p">(</span><span class="n">T0</span><span class="p">)</span>

                    <span class="n">weightedDose</span> <span class="o">=</span> <span class="p">(</span><span class="n">weightLoop</span> <span class="o">*</span> <span class="n">computedDose</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_protPerMU</span> <span class="o">/</span> <span class="p">(</span><span class="n">nbProtons</span><span class="p">))</span> <span class="o">*</span><span class="n">correcFactor</span> <span class="p">)</span>
                    
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">skipSaveBeamlets</span><span class="p">:</span>
                        <span class="n">beamletDoseDistrib</span> <span class="o">=</span> <span class="n">beamletDoseDistrib</span> <span class="o">+</span> <span class="n">weightedDose</span>

                
                    <span class="bp">self</span><span class="o">.</span><span class="n">_receivedDose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_receivedDose</span> <span class="o">+</span>  <span class="n">weightedDose</span>
                    
                <span class="c">#For info:</span>
                <span class="n">nbTargets</span> <span class="o">=</span> <span class="n">nbTargets</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">sumWeights</span> <span class="o">=</span> <span class="n">sumWeights</span> <span class="o">+</span> <span class="n">weight</span>

                <span class="k">if</span> <span class="n">compensated</span><span class="p">:</span>
                    <span class="n">dataBeam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">updateSpot</span><span class="p">(</span><span class="n">neighbor</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">weight</span><span class="p">,</span> <span class="n">decrRepaint</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
                    <span class="n">dataBeam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">updateSpot</span><span class="p">(</span><span class="n">dataSpot</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">compensatedPlan</span><span class="p">[</span><span class="n">angle</span><span class="p">][</span><span class="n">T0_round</span><span class="p">][</span><span class="s">&quot;ScanSpotPositionMap&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataSpot</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">compensatedPlan</span><span class="p">[</span><span class="n">angle</span><span class="p">][</span><span class="n">T0_round</span><span class="p">][</span><span class="s">&quot;ScanSpotPositionMap&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataSpot</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                    <span class="n">compensatedPlan</span><span class="p">[</span><span class="n">angle</span><span class="p">][</span><span class="n">T0_round</span><span class="p">][</span><span class="s">&quot;ScanSpotMetersetWeights&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
 
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dataBeam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">updateSpot</span><span class="p">(</span><span class="n">dataSpot</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">weight</span><span class="p">)</span>
                    <span class="k">print</span> <span class="s">&quot;Update done..&quot;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">skipSaveBeamlets</span><span class="p">:</span>
                    <span class="n">indImg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">beamletDoseDistrib</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">frameImg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">indImg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">indImg</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
<span class="c">#                     print &quot;Dose not empty&quot;</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">print</span> <span class="s">&quot;Computed dose empty&quot;</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Computed dose empty&quot;</span><span class="p">)</span>
                
                    <span class="n">viewer2D</span><span class="o">.</span><span class="n">displayImageFromArray</span><span class="p">(</span> <span class="n">beamletDoseDistrib</span><span class="p">[</span><span class="n">frameImg</span><span class="p">],</span> <span class="s">&quot;Beamlet </span><span class="si">%i</span><span class="s">&quot;</span><span class="o">%</span><span class="n">idxSpot</span><span class="p">)</span>
                    <span class="n">filenameBeamlets</span> <span class="o">=</span> <span class="s">&quot;Beam_</span><span class="si">%0.2d</span><span class="s">_Beamlet</span><span class="si">%0.9d</span><span class="s">_frame</span><span class="si">%0.4d</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">idxBeam</span><span class="p">,</span><span class="n">idxSpot</span><span class="p">,</span><span class="n">frameImg</span><span class="p">)</span>
                    <span class="n">viewer2D</span><span class="o">.</span><span class="n">saveFigure</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pathToOutputImages</span> <span class="o">+</span> <span class="s">&quot;Beamlets/&quot;</span><span class="p">,</span><span class="n">filenameBeamlets</span> <span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="s">&#39;png&#39;</span><span class="p">,</span> <span class="n">subplotIdx</span> <span class="o">=</span> <span class="mi">111</span><span class="p">)</span>
                    <span class="n">viewer2D</span><span class="o">.</span><span class="n">closePlot</span><span class="p">()</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Beam_</span><span class="si">%0.2d</span><span class="s">_Beamlet</span><span class="si">%0.9d</span><span class="s">_E</span><span class="si">%i</span><span class="s">MeV_frame</span><span class="si">%0.4d</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">idxBeam</span><span class="p">,</span><span class="n">idxSpot</span><span class="p">,</span><span class="n">T0_round</span><span class="p">,</span><span class="n">frameImg</span><span class="p">)</span>
                    <span class="n">viewer2D</span><span class="o">.</span><span class="n">storeMatrixAsImage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pathToOutputImages</span><span class="p">,</span><span class="n">beamletDoseDistrib</span><span class="p">[</span><span class="n">frameImg</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">computedDose</span><span class="p">[</span><span class="n">frameImg</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">computedDose</span><span class="p">[</span><span class="n">frameImg</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="n">name</span><span class="p">,</span> <span class="n">alongAxis</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span><span class="n">cpkl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">saveBeamletsCPKL</span><span class="p">,</span> <span class="n">bw</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
            
                
                <span class="n">t_end_spot</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                <span class="k">print</span> <span class="s">&quot;Spot # </span><span class="si">%i</span><span class="s"> processed in </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">idxSpot</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">t_end_spot</span> <span class="o">-</span> <span class="n">t_start_spot</span><span class="p">))</span>            
                
            
            <span class="c">#Display resulting scanning path &quot;matrix&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">displayScanPathUpdates</span><span class="p">:</span>
                    <span class="n">listEnergies</span> <span class="o">=</span> <span class="n">dataBeam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getListEnergies</span><span class="p">()</span>
                    <span class="c">#Display the current scanning path slice</span>
                    <span class="k">for</span> <span class="n">T0</span> <span class="ow">in</span> <span class="n">listEnergies</span><span class="p">:</span>
                        <span class="n">currentEnergyLayer</span> <span class="o">=</span> <span class="n">dataBeam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getEnergySliceWeights</span><span class="p">(</span><span class="n">T0</span><span class="p">)</span>
                        <span class="n">viewer2D</span><span class="o">.</span><span class="n">displayImageFromArray</span><span class="p">(</span> <span class="n">currentEnergyLayer</span><span class="p">,</span> <span class="s">&quot;Scan path - energy layer </span><span class="si">%i</span><span class="s"> MeV&quot;</span><span class="o">%</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">T0</span><span class="p">))</span>
                        <span class="n">filenameScanPath</span> <span class="o">=</span> <span class="s">&quot;FinalScanningPath_</span><span class="si">%0.3d</span><span class="s">MeV&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">T0</span><span class="p">))</span>
                        <span class="n">viewer2D</span><span class="o">.</span><span class="n">saveFigure</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pathToOutputImages</span> <span class="o">+</span> <span class="s">&quot;ScanningPathUpdates/&quot;</span><span class="p">,</span><span class="n">filenameScanPath</span> <span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="s">&#39;png&#39;</span><span class="p">,</span> <span class="n">subplotIdx</span> <span class="o">=</span> <span class="mi">111</span><span class="p">)</span>
                        <span class="n">viewer2D</span><span class="o">.</span><span class="n">closePlot</span><span class="p">()</span>
            
            
            <span class="n">t_end_beam</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="k">print</span> <span class="s">&quot;Beam # </span><span class="si">%i</span><span class="s"> processed in </span><span class="si">%s</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">idxBeam</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">t_end_beam</span><span class="o">-</span><span class="n">t_start_beam</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">listSpotsVisited</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">dataBeam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">repaintingMethodSlice</span> <span class="o">==</span> <span class="s">&#39;ScaledRepaint&#39;</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;#### Checking repainting ####&quot;</span>
                <span class="n">flagRepaint</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">repaintFactor</span> <span class="o">=</span> <span class="n">dataBeam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getRepaintingFactor</span><span class="p">()</span>
                <span class="k">print</span> <span class="s">&quot;Repainting factor used: </span><span class="si">%i</span><span class="s">&quot;</span><span class="o">%</span><span class="n">repaintFactor</span>
                <span class="k">print</span> <span class="s">&quot;Number of unique spots: </span><span class="si">%i</span><span class="s">&quot;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">listSpotsVisited</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">visitedSpots</span> <span class="ow">in</span>  <span class="n">listSpotsVisited</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">listSpotsVisited</span><span class="p">[</span><span class="n">visitedSpots</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">repaintFactor</span><span class="p">:</span>
                        <span class="n">flagRepaint</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">print</span> <span class="s">&quot;WARNING : spot </span><span class="si">%s</span><span class="s"> visited </span><span class="si">%i</span><span class="s"> times instead of </span><span class="si">%i</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">visitedSpots</span><span class="p">),</span><span class="n">listSpotsVisited</span><span class="p">[</span><span class="n">visitedSpots</span><span class="p">],</span><span class="n">repaintFactor</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">flagRepaint</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;Nothing wrong has been detected in the repaintings.&quot;</span>

            <span class="k">if</span> <span class="n">listSpotsDelivered</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">dataBeam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">repaintingMethodSlice</span> <span class="o">==</span> <span class="s">&#39;ScaledRepaint&#39;</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;### checking weights deposited ###&quot;</span>
                <span class="n">flagHotSpot</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">flagVisit</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">indSpot</span> <span class="ow">in</span> <span class="n">listSpotsDelivered</span><span class="p">:</span>
                    <span class="n">expectedWeight</span> <span class="o">=</span> <span class="n">dataBeam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getPlannedWeightForSpotInd</span><span class="p">(</span><span class="n">indSpot</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">expectedWeight</span><span class="o">-</span><span class="n">listSpotsDelivered</span><span class="p">[</span><span class="n">indSpot</span><span class="p">][</span><span class="s">&#39;sumWeight&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">float_info</span><span class="o">.</span><span class="n">epsilon</span><span class="p">:</span>
                        <span class="n">flagHotSpot</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">print</span> <span class="s">&quot;WARNING : spot </span><span class="si">%s</span><span class="s"> : expected weight: </span><span class="si">%f</span><span class="s"> - delivered weight: </span><span class="si">%f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">listSpotsDelivered</span><span class="p">[</span><span class="n">indSpot</span><span class="p">][</span><span class="s">&#39;coord&#39;</span><span class="p">]),</span><span class="n">expectedWeight</span><span class="p">,</span><span class="n">listSpotsDelivered</span><span class="p">[</span><span class="n">indSpot</span><span class="p">][</span><span class="s">&#39;sumWeight&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">listSpotsDelivered</span><span class="p">[</span><span class="n">indSpot</span><span class="p">][</span><span class="s">&#39;visits&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">repaintFactor</span><span class="p">:</span>
                        <span class="n">flagVisit</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">print</span> <span class="s">&quot;WARNING: spot </span><span class="si">%s</span><span class="s"> : delivered </span><span class="si">%i</span><span class="s"> times&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">listSpotsDelivered</span><span class="p">[</span><span class="n">indSpot</span><span class="p">][</span><span class="s">&#39;coord&#39;</span><span class="p">]),</span><span class="n">listSpotsDelivered</span><span class="p">[</span><span class="n">indSpot</span><span class="p">][</span><span class="s">&#39;visits&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">flagVisit</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;Nothing wrong has been detected in the number of times spots have been delivered.&quot;</span>
                <span class="k">if</span> <span class="n">flagHotSpot</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;Nothing wrong has been detected in the spots weight.&quot;</span>
            <span class="k">print</span> <span class="s">&quot;#### Max Number of repaintings per energy slice ####&quot;</span>
            <span class="k">for</span> <span class="n">indSlice</span><span class="p">,</span><span class="n">repaintNb</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataBeam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getNumberOfRepaintingsPerSlice</span><span class="p">()):</span>
                <span class="k">print</span> <span class="s">&quot;slice </span><span class="si">%i</span><span class="s">: </span><span class="si">%i</span><span class="s"> repainting(s)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">indSlice</span><span class="p">,</span><span class="n">repaintNb</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;#### Checking spots with weight Null ####&quot;</span>
            <span class="k">print</span> <span class="s">&quot;Spots with weight Null because already visited: </span><span class="si">%i</span><span class="s">&quot;</span><span class="o">%</span><span class="n">spotsVisitedButWeightNull</span> 
            <span class="k">print</span> <span class="s">&quot;Spots with unexplained weight null: </span><span class="si">%i</span><span class="s">&quot;</span><span class="o">%</span><span class="n">unexplainedWeightNull</span>
            <span class="k">print</span> <span class="s">&quot;################################&quot;</span>
                
                
                
                
        <span class="k">print</span> <span class="s">&quot;End beamlet calculation...&quot;</span>
        <span class="n">t_simul_end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">totalTimeSimul</span> <span class="o">=</span> <span class="n">t_simul_end</span><span class="o">-</span><span class="n">t_simul_start</span>
        <span class="k">print</span> <span class="s">&quot;Total delivery simulation in </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">totalTimeSimul</span><span class="p">)</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">setReceivedDose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_receivedDose</span><span class="p">)</span>
        
        <span class="c">############# If Dynamic delivery #############</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">staticDelivery</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;The delivery lasted (simulated time): </span><span class="si">%f</span><span class="s"> min&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getCurrentTime</span><span class="p">()</span><span class="o">/</span><span class="mf">60.0</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;The time spent irradiating is: </span><span class="si">%f</span><span class="s"> min&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getCumulDelivDuration</span><span class="p">()</span><span class="o">/</span><span class="mf">60.0</span><span class="p">)</span>
        <span class="c">############# End - If Dynamic delivery #######</span>
        
        <span class="k">if</span> <span class="n">countSmallWeights</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;</span>
            <span class="k">print</span> <span class="s">&quot;List of spots (</span><span class="si">%i</span><span class="s">) Null ( &lt;= </span><span class="si">%e</span><span class="s"> ) that shouldn&#39;t:&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">countSmallWeights</span><span class="p">,</span><span class="n">limitSmallWeights</span><span class="p">)</span>
            <span class="n">sumSmallWeights</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">tup</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">logSpotsSmallWeights</span><span class="p">):</span>
                <span class="n">sumSmallWeights</span><span class="o">+=</span> <span class="n">tup</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="k">print</span> <span class="s">&quot;Spot </span><span class="si">%i</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">tup</span><span class="p">))</span>
            <span class="k">print</span> <span class="s">&quot;Sum weights: </span><span class="si">%f</span><span class="s">&quot;</span><span class="o">%</span><span class="n">sumSmallWeights</span>
            <span class="k">print</span> <span class="s">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;</span>
            <span class="k">print</span> <span class="s">&quot;Not small weights: </span><span class="si">%i</span><span class="s"> spots : </span><span class="si">%f</span><span class="s"> MU&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">countNotSmallWeights</span><span class="p">,</span><span class="n">sumNotSmallWeights</span><span class="p">)</span>


        
        <span class="k">print</span> <span class="s">&quot;Average weight : </span><span class="si">%f</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">sumWeights</span><span class="o">/</span><span class="n">nbTargets</span><span class="p">)</span>       
        <span class="k">print</span> <span class="s">&quot;Sum weights : </span><span class="si">%f</span><span class="s">&quot;</span><span class="o">%</span><span class="n">sumWeights</span>
        <span class="k">print</span> <span class="s">&quot;Total number of spots: </span><span class="si">%i</span><span class="s">&quot;</span><span class="o">%</span><span class="n">nbSpots</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">staticDelivery</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">compensationDynamic</span><span class="p">:</span>
            <span class="n">textToWrite</span> <span class="o">=</span> <span class="s">&quot;*********************************</span><span class="se">\n</span><span class="s">Summary compensation:</span><span class="se">\n</span><span class="s">Number of missed spots:</span><span class="si">%i</span><span class="se">\n</span><span class="s">Number of compensated spots:</span><span class="si">%i</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">nbMissedSpots</span><span class="p">,</span><span class="n">nbCompensatedSpots</span><span class="p">)</span>
            <span class="k">print</span> <span class="n">textToWrite</span>
            <span class="k">print</span> <span class="s">&quot;Statistics on repaintings:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">dictRepaintStat</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storeDictStatisticsRepaint</span><span class="p">(</span><span class="n">dictRepaintStat</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">compensatedPlan</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
            
        
       
<span class="c">#############################################################################</span>
<span class="c">###         Functions related to dynamic delivery</span>
<span class="c">#############################################################################</span>
</div>
<div class="viewcode-block" id="simulatorDelivery.updateTime"><a class="viewcode-back" href="../../../mspt.scanning.html#mspt.scanning.deliverySimulation_Static_Dynamic.simulatorDelivery.updateTime">[docs]</a>    <span class="k">def</span> <span class="nf">updateTime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">,</span><span class="n">info</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;For dynamic delivery: Update the delivery timer (expressed in seconds).</span>
<span class="sd">        </span>
<span class="sd">        :param event: The type of event that requires a timer update:</span>
<span class="sd">            </span>
<span class="sd">            * &#39;Reset&#39;: Reset the timer</span>
<span class="sd">            * &#39;Energy&#39;: Energy change</span>
<span class="sd">            * &#39;MoveToSpot&#39;: Change beam position</span>
<span class="sd">            * &#39;GantryRotation&#39;: Gantry rotation</span>
<span class="sd">            * &#39;Delivery&#39;: Time spent at a beam position for the delivery</span>
<span class="sd">            * &#39;Refill&#39;: Time to refill the synchrotron ( if the machine setting is set to Synchrotron)</span>
<span class="sd">            * &#39;Displacement Measure&#39;: Time to measure the patient displacement (if Compensation is activated)</span>
<span class="sd">            </span>
<span class="sd">        :param info: Information regarding the event</span>
<span class="sd">            </span>
<span class="sd">            * If event &#39;MoveToSpot&#39;, &#39;info&#39; is the distance between the spots in cm.</span>
<span class="sd">            * If event &#39;GantryRotation&#39;, &#39;info&#39; is the rotation angle in degrees.</span>
<span class="sd">            * If event &#39;Delivery&#39;, &#39;info&#39; is the weight in MU.</span>
<span class="sd">            * Otherwise info is None  </span>
<span class="sd">        </span>
<span class="sd">            </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t\t\t</span><span class="s">---&gt; Update time for event &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="o">%</span><span class="n">event</span>
        <span class="n">prevTime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time</span>
        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s">&#39;Reset&#39;</span><span class="p">:</span> <span class="c">#Reset delivery timer</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_time</span> <span class="o">=</span> <span class="mi">0</span> <span class="c">#Time of the entire delivery</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cumulDelivSpot</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># Cumulative delivery time at each spot (time spent over a spot)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_spillTimer</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># Time incremented every time a spot is irradiated and every time the beam moves from ones spot to another. This time must always stay below the maximal spill length, otherwise (with a synchrotron) it means we have to refill the tank.</span>
            <span class="c">#print&quot;reset Done&quot;</span>
            
        <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="s">&#39;Energy&#39;</span><span class="p">:</span><span class="c">#Energy change</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">timeEnergyChange</span>
        <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="s">&#39;MoveToSpot&#39;</span><span class="p">:</span> <span class="c">#Move to another spot: info shouldn&#39;t be None, it should be a number representing the distance in cm.</span>
            <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;In updateTime for delivery, information expected to update time in order to move between 2 spots: distance in cm !&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="p">(</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">,</span> <span class="nb">float</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="p">):</span>
                <span class="n">strErr</span> <span class="o">=</span> <span class="s">&quot;In updateTime for delivery, move between 2 spots: information expected is distance (number) in cm, not a &#39;</span><span class="si">%s</span><span class="s">&#39; - </span><span class="si">%s</span><span class="s">! &quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">info</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">strErr</span><span class="p">)</span> 
            <span class="k">exec</span> <span class="s">&quot;timeMove = (np.</span><span class="si">%s</span><span class="s">(info) / self._globalVar.lateralScanningSpeed) + self._globalVar.spotSettlingTime&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time</span> <span class="o">+</span>  <span class="n">timeMove</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">_spillTimer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spillTimer</span> <span class="o">+</span> <span class="n">timeMove</span>
            <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Time to move to spot:</span><span class="si">%f</span><span class="s"> ms&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">timeMove</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="s">&#39;GantryRotation&#39;</span><span class="p">:</span> <span class="c">#Beam rotation</span>
            <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Update time for gantry rotations needs the angle&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="p">(</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">,</span> <span class="nb">float</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="p">):</span>
                <span class="n">strErr</span> <span class="o">=</span> <span class="s">&quot;In updateTime for gantry rotation, information expected is an angle (number) indegrees, not a &#39;</span><span class="si">%s</span><span class="s">&#39; - </span><span class="si">%s</span><span class="s">! &quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">info</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">strErr</span><span class="p">)</span>
            <span class="k">exec</span> <span class="s">&quot;testInfo = np.</span><span class="si">%s</span><span class="s">(info)&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span>
            <span class="k">if</span> <span class="n">testInfo</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">exec</span> <span class="s">&quot;newAngle = 360 - np.</span><span class="si">%s</span><span class="s">(info)&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">exec</span> <span class="s">&quot;newAngle = np.</span><span class="si">%s</span><span class="s">(info)&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">newAngle</span> <span class="o">/</span>  <span class="mf">360.0</span>
            <span class="k">if</span> <span class="n">newAngle</span> <span class="o">&gt;</span>  <span class="mf">360.0</span> <span class="p">:</span>
                <span class="n">newAngle</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">res</span><span class="p">))</span> <span class="o">*</span> <span class="mf">360.0</span>
            
            <span class="n">angleRot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">newAngle</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prevRotationAngle</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time</span> <span class="o">+</span> <span class="p">(</span><span class="n">angleRot</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">speedGantryRotation</span><span class="p">)</span>
            <span class="k">exec</span> <span class="s">&quot;self._prevRotationAngle = np.</span><span class="si">%s</span><span class="s">(newAngle)&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span>
        <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="s">&#39;Delivery&#39;</span><span class="p">:</span> <span class="c"># Time spent at one spot: info shouldn&#39;t be None, it should be a number representing the weight in MU.</span>
            <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;In updateTime for delivery, information expected to update time in order to deliver at 1 spot: weight in MU!&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">info</span><span class="p">,</span> <span class="p">(</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="p">):</span>
                <span class="k">print</span> <span class="s">&quot;info: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
                <span class="n">strErr</span> <span class="o">=</span> <span class="s">&quot;In updateTime for delivery, deliver at 1 spot: information expected is weight (number) in MU, not a &#39;</span><span class="si">%s</span><span class="s">&#39;! &quot;</span><span class="o">%</span><span class="nb">type</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">strErr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">info</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;info: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
                    <span class="n">strErr</span> <span class="o">=</span> <span class="s">&quot;In updateTime for delivery, deliver at 1 spot: information expected is weight (number or numpy  array of 1 element) in MU, not a &#39;</span><span class="si">%i</span><span class="s">&#39; elements! &quot;</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">strErr</span><span class="p">)</span>                   
            <span class="k">exec</span> <span class="s">&quot;timeSpent = self.timeDeliverSpotWeight(np.</span><span class="si">%s</span><span class="s">(info))&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time</span> <span class="o">+</span> <span class="n">timeSpent</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cumulDelivSpot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cumulDelivSpot</span> <span class="o">+</span> <span class="n">timeSpent</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_spillTimer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spillTimer</span> <span class="o">+</span> <span class="n">timeSpent</span>
            <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Time spent over spot:</span><span class="si">%f</span><span class="s"> ms&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">timeSpent</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="s">&#39;Refill&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">timeEnergyChange</span>
        <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="s">&#39;Displacement Measure&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">timeMeasureDisplacement</span>
        
        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">strErr</span> <span class="o">=</span> <span class="s">&quot;In updateTime for delivery, unknowkn event &#39;</span><span class="si">%s</span><span class="s">&#39;! &quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spillTimer</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">spillDuration</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">synchrotron</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_spillTimer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spillTimer</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">spillDuration</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updateTime</span><span class="p">(</span><span class="s">&#39;Refill&#39;</span><span class="p">)</span> <span class="c"># in order to simulate the refill</span>
        <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t\t\t\t</span><span class="s">Updated timer: </span><span class="si">%f</span><span class="s"> ms&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_time</span><span class="p">)</span>
            
            </div>
<div class="viewcode-block" id="simulatorDelivery.getCurrentTime"><a class="viewcode-back" href="../../../mspt.scanning.html#mspt.scanning.deliverySimulation_Static_Dynamic.simulatorDelivery.getCurrentTime">[docs]</a>    <span class="k">def</span> <span class="nf">getCurrentTime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the current value of the timer (dynamic delivery)</span>
<span class="sd">        </span>
<span class="sd">        :returns: Current timer value</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time</span>
    </div>
<div class="viewcode-block" id="simulatorDelivery.getCumulDelivDuration"><a class="viewcode-back" href="../../../mspt.scanning.html#mspt.scanning.deliverySimulation_Static_Dynamic.simulatorDelivery.getCumulDelivDuration">[docs]</a>    <span class="k">def</span> <span class="nf">getCumulDelivDuration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the cumulative time spent at each beam position</span>
<span class="sd">        </span>
<span class="sd">        :returns: The cumulative irradiation time.</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cumulDelivSpot</span>
    </div>
<div class="viewcode-block" id="simulatorDelivery.timeDeliverSpotWeight"><a class="viewcode-back" href="../../../mspt.scanning.html#mspt.scanning.deliverySimulation_Static_Dynamic.simulatorDelivery.timeDeliverSpotWeight">[docs]</a>    <span class="k">def</span> <span class="nf">timeDeliverSpotWeight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">weight</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return the time spent at one spot to deliver a given weight (MU), knowing the beam intensity and the number_of_protons/MU. </span>
<span class="sd">        </span>
<span class="sd">        Formula : eq. 1 in &quot;Interplay effects in proton scanning for lung: a 4D Monte Carlo study assessing the impact of tumor and beam delivery parameters.&quot; Dowdell et al. 2013</span>
<span class="sd">        </span>
<span class="sd">        :param weight: Weight in MU of the beam position.</span>
<span class="sd">        </span>
<span class="sd">        :returns: Time spent at beam position</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">weight</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protPerMU</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">beamIntensity</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="simulatorDelivery.processDynamicDoseDistrib"><a class="viewcode-back" href="../../../mspt.scanning.html#mspt.scanning.deliverySimulation_Static_Dynamic.simulatorDelivery.processDynamicDoseDistrib">[docs]</a>    <span class="k">def</span> <span class="nf">processDynamicDoseDistrib</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">computedDose</span><span class="p">,</span>  <span class="n">T0_round</span> <span class="p">,</span><span class="n">dispVec</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Process the computed dose in dynamic mode:</span>
<span class="sd">        </span>
<span class="sd">        The dose received by the patient (located at its dynamic position: self._dynaPatientLoc) is translated toward the &quot;static position&quot; (self._staticPatientLoc). \</span>
<span class="sd">        The dose values located at indices self._dynaPatientLoc (body dynamic position) are moved to indices self._staticPatientLoc (body static position). \</span>
<span class="sd">        Then everything outside the patient body is set to zero.</span>
<span class="sd">       </span>
<span class="sd">        :param computedDose: 3D numpy array representing the 3D dose distribution of the pencilbeam.</span>
<span class="sd">        :param T0_round: Rounded beam energy</span>
<span class="sd">        :param dispVec: The displacement vector. By default it is None. It is used if the global variable &#39;storeInterDoseDens&#39; is set to True when configuring MSPT.</span>
<span class="sd">        </span>
<span class="sd">        :returns: The processed dose distribution</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">tmpComputedDose</span> <span class="o">=</span>  <span class="n">computedDose</span>
        <span class="n">tmpDoseToStore</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">computedDose</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>
        <span class="n">tmpDoseToStore</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dynaPatientLoc</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmpComputedDose</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dynaPatientLoc</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">storeInterDoseDens</span> <span class="ow">and</span> <span class="n">dispVec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">nameOutputDose</span> <span class="o">=</span> <span class="s">&quot;interCompDose_[</span><span class="si">%.2f</span><span class="s">,</span><span class="si">%.2f</span><span class="s">,</span><span class="si">%.2f</span><span class="s">]_</span><span class="si">%i</span><span class="s">MeV&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">dispVec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dispVec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">dispVec</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">T0_round</span><span class="p">)</span>
            <span class="n">nameOutputDensity</span> <span class="o">=</span> <span class="s">&quot;interDensity_[</span><span class="si">%.2f</span><span class="s">,</span><span class="si">%.2f</span><span class="s">,</span><span class="si">%.2f</span><span class="s">]_</span><span class="si">%i</span><span class="s">MeV&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">dispVec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dispVec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">dispVec</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">T0_round</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">listSaveCompDoseAlong</span><span class="p">:</span>
                <span class="n">viewer2D</span><span class="o">.</span><span class="n">storeMatrixAsImage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pathToOutputImages</span><span class="p">,</span><span class="n">tmpDoseToStore</span><span class="p">,</span><span class="n">nameOutputDose</span><span class="p">,</span><span class="n">alongAxis</span> <span class="o">=</span> <span class="n">axis</span> <span class="p">,</span><span class="n">cpkl</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">bw</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="n">viewer2D</span><span class="o">.</span><span class="n">storeMatrixAsImage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pathToOutputImages</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_DensityGrid</span><span class="p">,</span><span class="n">nameOutputDensity</span><span class="p">,</span><span class="n">alongAxis</span> <span class="o">=</span> <span class="n">axis</span> <span class="p">,</span><span class="n">cpkl</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">bw</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">saveDoseTumor</span> <span class="o">=</span> <span class="n">tmpComputedDose</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dynaPatientLoc</span><span class="p">]</span>
                     
        <span class="c">#Otherwise:</span>
        <span class="n">newCompDose</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">computedDose</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>
        <span class="n">newCompDose</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_staticPatientLoc</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">saveDoseTumor</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span>                        
                
        <span class="k">return</span> <span class="n">newCompDose</span>
    
    </div>
<div class="viewcode-block" id="simulatorDelivery.computeBeamletStatic"><a class="viewcode-back" href="../../../mspt.scanning.html#mspt.scanning.deliverySimulation_Static_Dynamic.simulatorDelivery.computeBeamletStatic">[docs]</a>    <span class="k">def</span> <span class="nf">computeBeamletStatic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">Xr</span><span class="p">,</span><span class="n">Yr</span><span class="p">,</span><span class="n">Zr</span><span class="p">,</span><span class="n">dmax</span><span class="p">,</span><span class="n">z_dd</span><span class="p">,</span><span class="n">dd</span><span class="p">,</span><span class="n">sig0</span><span class="p">,</span><span class="n">xrshift</span><span class="p">,</span><span class="n">yrshift</span><span class="p">,</span><span class="n">sourceLocation</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;This function is only used if MSPT global variables &#39;staticDelivery&#39; is set to False and &#39;evaluateDiffStatDyna&#39; is set to False.</span>
<span class="sd">        </span>
<span class="sd">        It simulates the irradiation at a beam position on the static body. This allows to highlight the differences between the beams delivered to \</span>
<span class="sd">        the static and the dynamic body for a same beam position.</span>
<span class="sd">        </span>
<span class="sd">        :param Xr: 3D matrix representing x coordinates in the IEC Gantry coordinate system (cm).</span>
<span class="sd">        :param Yr: 3D matrix representing y coordinates in the IEC Gantry coordinate system (cm).</span>
<span class="sd">        :param Zr: 3D matrix representing z coordinates in the IEC Gantry coordinate system (cm).</span>
<span class="sd">        :param dmax: Bragg Peak depth (cm)</span>
<span class="sd">        :param z_dd: &quot;depth&quot; coordinates for the depth dose curve (cm).</span>
<span class="sd">        :param dd: &quot;dose&quot; coordinates for the depth dose curve. (Gy.cm ^2 )</span>
<span class="sd">        :param sig0: beam size (along x and y IEC gantry axis) at patient entrance (cm): [sig0X,sig0Y]</span>
<span class="sd">        :param xrshift: x beam shift (from isocenter) used to define target position. Provided in the IEC gantry coordinate system.(cm)</span>
<span class="sd">        :apram yrshift: y beam shift (from isocenter) used to define target position. Provided in the IEC gantry coordinate system.(cm)</span>
<span class="sd">        :param sourceLocation: Source location in the IEC Fixed coordinate system(cm).</span>

<span class="sd">        :returns: The processed dose distribution</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">staticDelivery</span><span class="p">:</span>
            <span class="n">stpPwrStatic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">getPatientArrayForAttr</span><span class="p">(</span><span class="s">&#39;stpPwrRatio&#39;</span><span class="p">))</span>
            <span class="n">densityStatic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">getPatientArrayForAttr</span><span class="p">(</span><span class="s">&#39;density&#39;</span><span class="p">))</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deffStatic</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_deffStatic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">computeRadiologicalDepth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_startVec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_incVec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sourceVec</span><span class="p">,</span> <span class="n">dispVec</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">)</span>
            
            <span class="n">patientMask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">getPatientMask</span><span class="p">()</span>
            <span class="n">targetIECG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xrshift</span><span class="p">,</span><span class="n">yrshift</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span><span class="c"># target point in isocenter frame</span>
            <span class="n">targetIECF</span> <span class="o">=</span>  <span class="n">mathTools</span><span class="o">.</span><span class="n">rotateCoordinates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rotMatrix</span><span class="p">,</span><span class="n">targetIECG</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>
            <span class="n">sourceIECG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">sourceLocation</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span><span class="n">dtype</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span>
            <span class="n">ssd0</span><span class="p">,</span> <span class="n">listIndices</span><span class="p">,</span><span class="n">listLenVoxels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">calculateSSD0</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sourceVec</span><span class="p">,</span><span class="n">targetIECF</span><span class="p">,</span><span class="n">Xr</span><span class="p">,</span><span class="n">Yr</span><span class="p">,</span><span class="n">Zr</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_DensityGrid</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_startVec</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_incVec</span><span class="p">,</span><span class="n">sourceIECG</span><span class="p">,</span><span class="n">patientMask</span><span class="p">)</span>
 
            <span class="n">computedDose</span> <span class="o">=</span> <span class="n">beamletSimul</span><span class="p">(</span><span class="n">densityStatic</span><span class="p">,</span><span class="n">stpPwrStatic</span><span class="p">,</span>\
                                <span class="n">Xr</span><span class="p">,</span><span class="n">Yr</span><span class="p">,</span><span class="n">Zr</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dmax</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">),</span>\
                                <span class="n">z_dd</span><span class="p">,</span><span class="n">dd</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sig0</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">),</span>\
                                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xrshift</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">),</span>\
                                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yrshift</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sourceLocation</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>\
                                <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ssd0</span><span class="p">,</span>\
                                <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">_deffStatic</span><span class="p">,</span><span class="n">listIndices</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_x0y0z0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_IECFSpacing</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_rotMatrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">computedDose</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Trying to compute beamlet static designed for dynamic mode, in static mode... &quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>
        
        </div>
<div class="viewcode-block" id="simulatorDelivery.isPatientInTheVolume"><a class="viewcode-back" href="../../../mspt.scanning.html#mspt.scanning.deliverySimulation_Static_Dynamic.simulatorDelivery.isPatientInTheVolume">[docs]</a>    <span class="k">def</span> <span class="nf">isPatientInTheVolume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">shapeVolume</span><span class="p">,</span><span class="n">patientIndices</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Function to verify that the patient is in the field of view when moving.</span>
<span class="sd">        </span>
<span class="sd">        :param shapeVolume: Shape of the field of view volume (nb frames, nb rows, nb columns).</span>
<span class="sd">        :param patientIndices: Patient indices in the field of view 3D array.</span>
<span class="sd">        </span>
<span class="sd">        :returns: True if the patient is inside, False otherwise</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">nbFrames</span> <span class="o">=</span> <span class="n">shapeVolume</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nbRows</span> <span class="o">=</span> <span class="n">shapeVolume</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">nbCols</span> <span class="o">=</span> <span class="n">shapeVolume</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        
        <span class="c">#Check if patient in field of view:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">patientIndices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">patientIndices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span> <span class="n">nbFrames</span><span class="p">))</span> <span class="ow">and</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">patientIndices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">patientIndices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span> <span class="n">nbRows</span><span class="p">))</span> <span class="ow">and</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">patientIndices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">patientIndices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;</span> <span class="n">nbCols</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

</div>
<div class="viewcode-block" id="simulatorDelivery.numberOfUnitTimeToDeliverWeight"><a class="viewcode-back" href="../../../mspt.scanning.html#mspt.scanning.deliverySimulation_Static_Dynamic.simulatorDelivery.numberOfUnitTimeToDeliverWeight">[docs]</a>    <span class="k">def</span> <span class="nf">numberOfUnitTimeToDeliverWeight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">weight</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calculate the number of time units needed to deliver a given weight:</span>
<span class="sd">        </span>
<span class="sd">        :param weight: Beam weight in MU</span>
<span class="sd">        </span>
<span class="sd">        :returns: A list [ number of time units , weight to be delivered per time unit, remainder to deliver at last time unit]</span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="n">weightPerTimeUnit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weightDeliveredByUnitTime</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">weight</span> <span class="o">&lt;</span> <span class="n">weightPerTimeUnit</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">weight</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;Weight per time unit: </span><span class="si">%f</span><span class="s">&quot;</span><span class="o">%</span><span class="n">weightPerTimeUnit</span>
        <span class="n">nbLoops</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">weight</span> <span class="o">/</span> <span class="n">weightPerTimeUnit</span><span class="p">)</span>
        <span class="n">remainWeight</span> <span class="o">=</span> <span class="n">weight</span> <span class="o">-</span> <span class="p">((</span><span class="n">nbLoops</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="o">*</span>  <span class="n">weightPerTimeUnit</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">nbLoops</span><span class="p">),</span><span class="n">weightPerTimeUnit</span><span class="p">,</span><span class="n">remainWeight</span><span class="p">)</span>
        
        </div>
<div class="viewcode-block" id="simulatorDelivery.weightDeliveredByUnitTime"><a class="viewcode-back" href="../../../mspt.scanning.html#mspt.scanning.deliverySimulation_Static_Dynamic.simulatorDelivery.weightDeliveredByUnitTime">[docs]</a>    <span class="k">def</span> <span class="nf">weightDeliveredByUnitTime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calculates the weight delivered per time unit</span>
<span class="sd">        </span>
<span class="sd">        :returns: The calculated weight</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">beamIntensity</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">unitTimeForDelivery</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protPerMU</span> 


</div>
<div class="viewcode-block" id="simulatorDelivery.computeDisplacementVectors"><a class="viewcode-back" href="../../../mspt.scanning.html#mspt.scanning.deliverySimulation_Static_Dynamic.simulatorDelivery.computeDisplacementVectors">[docs]</a>    <span class="k">def</span> <span class="nf">computeDisplacementVectors</span><span class="p">(</span><span class="bp">self</span> <span class="p">,</span> <span class="n">useMotionMonitor</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Compute the displacement vector in the IEC fixed coordinate system from the simulated timer. \</span>
<span class="sd">        Then convert the coordinated into the IEC Gantry coordinate system and into the CT coordinate system.\</span>
<span class="sd">        </span>
<span class="sd">        :param useMotionMonitor: True if MSPT is configured to use motion monitoring, False otherwise. </span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        :returns: If useMotionMonitor is True:</span>
<span class="sd">        </span>
<span class="sd">            * A tuple T with:</span>
<span class="sd">                </span>
<span class="sd">                * tuple[0] : disp. vector in the IEC Fixed system</span>
<span class="sd">                * tuple[1] : disp vector in the IEC Gantry</span>
<span class="sd">                * tuple[2] : disp vector in the CT system</span>
<span class="sd">                * tuple[3] : disp indices in the CT image (matrix)</span>
<span class="sd">            </span>
<span class="sd">            * Else, a dictionary with keys:</span>
<span class="sd">                </span>
<span class="sd">                * &#39;PatientMotion&#39; : the tuple T</span>
<span class="sd">                * &#39;MeasuredMotion&#39; : a tuple equivalent to T corresponding to the monitor measurements.</span>
<span class="sd">            </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">currTime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCurrentTime</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">useMotionMonitor</span><span class="p">:</span>
            <span class="n">dispVec_IECFixed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_motion</span><span class="o">.</span><span class="n">getDisplacementVectorAtTime</span><span class="p">(</span><span class="n">currTime</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getVectorInDiffCoordSystm</span><span class="p">(</span><span class="n">dispVec_IECFixed</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            
            <span class="n">motion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monitoringSystm</span><span class="o">.</span><span class="n">monitorPatientMotionAtTime</span><span class="p">(</span><span class="n">currTime</span><span class="p">)</span>
            <span class="n">vecMotion</span> <span class="o">=</span> <span class="n">motion</span><span class="p">[</span><span class="s">&#39;PatientMotion&#39;</span><span class="p">]</span>
            <span class="n">vecMeasure</span> <span class="o">=</span> <span class="n">motion</span><span class="p">[</span><span class="s">&#39;MeasuredMotion&#39;</span><span class="p">]</span>
            
            <span class="n">vecInCoordSystmMotion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getVectorInDiffCoordSystm</span><span class="p">(</span><span class="n">vecMotion</span><span class="p">,</span><span class="s">&#39; real motion &#39;</span><span class="p">)</span>
            <span class="n">vecInCoordSystmMeasure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getVectorInDiffCoordSystm</span><span class="p">(</span><span class="n">vecMeasure</span><span class="p">,</span><span class="s">&#39; measured motion &#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s">&#39;PatientMotion&#39;</span><span class="p">:</span> <span class="n">vecInCoordSystmMotion</span><span class="p">,</span> <span class="s">&#39;MeasuredMotion&#39;</span><span class="p">:</span> <span class="n">vecInCoordSystmMeasure</span><span class="p">}</span>
            
            </div>
<div class="viewcode-block" id="simulatorDelivery.getVectorInDiffCoordSystm"><a class="viewcode-back" href="../../../mspt.scanning.html#mspt.scanning.deliverySimulation_Static_Dynamic.simulatorDelivery.getVectorInDiffCoordSystm">[docs]</a>    <span class="k">def</span> <span class="nf">getVectorInDiffCoordSystm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dispVec_IECFixed</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Converts a vector defined in the IEC Fixed coordinate system into the IEC grantry coordinate system and the dicom coordinate system.</span>
<span class="sd">        </span>
<span class="sd">       :param dispVec_IECFixed: Displacement vector in the IEC fixed coordinate system (x,y,z)</span>
<span class="sd">       :param info: String for information, to display, about the motion.</span>
<span class="sd">       </span>
<span class="sd">       :returns: A tuple with the displacement vector in different coordinate systems: \</span>
<span class="sd">       ( dispVec_IECFixed ,dispVec_IECG,dispVec_CT,indDispCT ). Note: indDispCT corresponds to the displacement vector as indices \</span>
<span class="sd">       in the CT volume: (frame, row, colum).</span>
<span class="sd">       </span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="n">dx_IEC_F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">dispVec_IECFixed</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">dy_IEC_F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">dispVec_IECFixed</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">dz_IEC_F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">dispVec_IECFixed</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="c">#Convert in the IEC Gantry</span>
        <span class="p">(</span><span class="n">dx</span><span class="p">,</span><span class="n">dy</span><span class="p">,</span><span class="n">dz</span><span class="p">)</span> <span class="o">=</span> <span class="n">mathTools</span><span class="o">.</span><span class="n">rot3D</span><span class="p">(</span><span class="n">dx_IEC_F</span><span class="p">,</span><span class="n">dy_IEC_F</span><span class="p">,</span><span class="n">dz_IEC_F</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">_rotMatrix</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>
        <span class="n">dispVec_IECG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>
        <span class="n">dispVec_IECG</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dx</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dispVec_IECG</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dy</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dispVec_IECG</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="c">#Convert in the CT system</span>
        <span class="n">isocenterPos</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="c"># : we just need the displacement vector, centered on zero, i.e. not at the isocenter</span>
        <span class="p">(</span><span class="n">X_ct</span><span class="p">,</span><span class="n">Y_ct</span><span class="p">,</span><span class="n">Z_ct</span><span class="p">)</span> <span class="o">=</span> <span class="n">mathTools</span><span class="o">.</span><span class="n">fromIECFixedToCTCoord</span><span class="p">(</span><span class="n">dx_IEC_F</span><span class="p">,</span><span class="n">dy_IEC_F</span><span class="p">,</span><span class="n">dz_IEC_F</span><span class="p">,</span><span class="n">isocenterPos</span><span class="p">)</span>
        <span class="n">dispVec_CT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>
        <span class="n">dispVec_CT</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_ct</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dispVec_CT</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Y_ct</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dispVec_CT</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z_ct</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>        
        <span class="c">#Convert CT coordinates into matrix indice</span>
        <span class="n">indDispCT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_patient</span><span class="o">.</span><span class="n">getDispIndices</span><span class="p">(</span><span class="n">dispVec_CT</span><span class="p">)</span>
        
        <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">***** Displacement info </span><span class="si">%s</span><span class="s"> *****&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;Displacement in IEC fixed (x,y,z) (cm): (</span><span class="si">%f</span><span class="s">,</span><span class="si">%f</span><span class="s">,</span><span class="si">%f</span><span class="s">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">dispVec_IECFixed</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dispVec_IECFixed</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">dispVec_IECFixed</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">print</span> <span class="s">&quot;Displacement in IEC gantry (x,y,z) (cm): (</span><span class="si">%f</span><span class="s">,</span><span class="si">%f</span><span class="s">,</span><span class="si">%f</span><span class="s">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">dispVec_IECG</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dispVec_IECG</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">dispVec_IECG</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">print</span> <span class="s">&quot;Displacement in CT (x,y,z) (cm): (</span><span class="si">%f</span><span class="s">,</span><span class="si">%f</span><span class="s">,</span><span class="si">%f</span><span class="s">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">dispVec_CT</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dispVec_CT</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">dispVec_CT</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">print</span> <span class="s">&quot;Displacement in CT matrix (f,r,c): (</span><span class="si">%i</span><span class="s">,</span><span class="si">%i</span><span class="s">,</span><span class="si">%i</span><span class="s">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">indDispCT</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">indDispCT</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">indDispCT</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">*****************************&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">dispVec_IECFixed</span> <span class="p">,</span><span class="n">dispVec_IECG</span><span class="p">,</span><span class="n">dispVec_CT</span><span class="p">,</span><span class="n">indDispCT</span> <span class="p">)</span>
        
        
<span class="c">#############################################################################</span>
<span class="c">###         Functions for compensation methods</span>
<span class="c">#############################################################################           </span></div>
<div class="viewcode-block" id="simulatorDelivery.storeDictStatisticsRepaint"><a class="viewcode-back" href="../../../mspt.scanning.html#mspt.scanning.deliverySimulation_Static_Dynamic.simulatorDelivery.storeDictStatisticsRepaint">[docs]</a>    <span class="k">def</span> <span class="nf">storeDictStatisticsRepaint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dictRep</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Store statistics about the repainting: the number of compensated beam positions for each repainting index.\</span>
<span class="sd">        It is stored to a csv file in the simulation directory in &#39;StatisticsRepaintings/&#39;.</span>
<span class="sd">        </span>
<span class="sd">        :param dictRep: Dictionary storing for each repainting index the number of compensated positions: \</span>
<span class="sd">        dictRep[gantry angle][energy][repainting Index].</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="n">pathToSave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">mainPath</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">nameSimulation</span> <span class="o">+</span><span class="s">&#39;StatisticsRepaintings/&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pathToSave</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">pathToSave</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">dictRep</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">ener</span> <span class="ow">in</span> <span class="n">dictRep</span><span class="p">[</span><span class="n">angle</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">enerData</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="n">enerData</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s">&#39;RepIdx&#39;</span><span class="p">,</span><span class="s">&#39;NbComp&#39;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">repIndex</span> <span class="ow">in</span> <span class="n">dictRep</span><span class="p">[</span><span class="n">angle</span><span class="p">][</span><span class="n">ener</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">enerData</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">repIndex</span><span class="p">,</span><span class="n">dictRep</span><span class="p">[</span><span class="n">angle</span><span class="p">][</span><span class="n">ener</span><span class="p">][</span><span class="n">repIndex</span><span class="p">]])</span>
                <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">enerData</span><span class="p">)</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">pathToSave</span><span class="o">+</span><span class="s">&quot;StatRepaint-Angle</span><span class="si">%0.3d</span><span class="s">-</span><span class="si">%0.3d</span><span class="s">MeV.csv&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">angle</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">ener</span><span class="p">))</span>
                <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&quot;,&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">)</span>
                </div>
<div class="viewcode-block" id="simulatorDelivery.compensationFindStartSpotEnerLayer"><a class="viewcode-back" href="../../../mspt.scanning.html#mspt.scanning.deliverySimulation_Static_Dynamic.simulatorDelivery.compensationFindStartSpotEnerLayer">[docs]</a>    <span class="k">def</span> <span class="nf">compensationFindStartSpotEnerLayer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scanPath</span> <span class="p">,</span> <span class="n">ddCurvesData</span> <span class="p">,</span> <span class="n">strEner</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;If MSPT global variables compensationDynamic and findStartPos are True, it look for a &#39;good starting position&#39;\</span>
<span class="sd">        for delivery of the current the energy layer. See dicomReader.scanningPath method findStartingPointForMotion() for more information.</span>
<span class="sd">        </span>
<span class="sd">        :param scanPath: scanning path object (dicomReader.scanningPath.ScanningPathSingleBeam)</span>
<span class="sd">        :param ddCurvesData: depth dose curves data : physics.ddcurveManager.DDCurves</span>
<span class="sd">        :param strEner: String indicating if the energy being used has just been set (&#39;NewEnergy&#39;) or has already been set for at least one \</span>
<span class="sd">        beam position (&#39;SameEnergy&#39;).</span>
<span class="sd">            </span>
<span class="sd">        :returns: None if no starting position has been found, otherwise a tuple:</span>
<span class="sd">            </span>
<span class="sd">            * index 0: spot weight</span>
<span class="sd">            * index 1: spot in the 3D matrices : frame, row, column </span>
<span class="sd">            * index 2: x position</span>
<span class="sd">            * index 3: y position</span>
<span class="sd">            * index 4: energy</span>
<span class="sd">            * index 5: list of 2 elements : spot size along x and along y </span>
<span class="sd">            * index 6: &#39;NewEnergy&#39; if the energy is changing or &#39;SameEnergy&#39; otherwise </span>
<span class="sd">            * index 7: spot type = 1 (native spot) or 2 (spot from added margin) </span>
<span class="sd">            * index 8: repainting index </span>
<span class="sd">            </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="p">(</span><span class="n">dispVec_IECFixed</span> <span class="p">,</span><span class="n">dispVec_IECG</span><span class="p">,</span><span class="n">dispVec_CT</span><span class="p">,</span><span class="n">indDispCT</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computeDisplacementVectors</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updateTime</span><span class="p">(</span><span class="s">&#39;Displacement Measure&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scanPath</span><span class="o">.</span><span class="n">findStartingPointForMotion</span><span class="p">(</span> <span class="n">dispVec_IECG</span> <span class="o">*</span> <span class="mf">10.0</span> <span class="p">,</span><span class="n">ddCurvesData</span><span class="p">,</span> <span class="n">strEner</span><span class="p">)</span> <span class="c"># dispVec_IECG * 10.0 : convert from cm to mm</span>

    
<span class="c">#############################################################################</span>
<span class="c">###         Functions shared by static and dynamic</span>
<span class="c">#############################################################################    </span>
                 </div>
<div class="viewcode-block" id="simulatorDelivery.findBraggPeak"><a class="viewcode-back" href="../../../mspt.scanning.html#mspt.scanning.deliverySimulation_Static_Dynamic.simulatorDelivery.findBraggPeak">[docs]</a>    <span class="k">def</span> <span class="nf">findBraggPeak</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compDose</span><span class="p">,</span> <span class="n">deff</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Finds and display the Bragg Peak depth in the beam dose distribution. </span>
<span class="sd">    </span>
<span class="sd">        :param compDose: Computed 3D dose distribution</span>
<span class="sd">        :param deff: 3D numpy array of the radiological depth</span>
<span class="sd">    </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c">#We assume beam along z dcm axis</span>
        <span class="n">indBraggPeak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">compDose</span><span class="o">.</span><span class="n">argmax</span><span class="p">(),</span> <span class="n">compDose</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="c">#         print &quot;ind Bragg Peak: %s&quot;%(str(indBraggPeak))</span>
        <span class="k">print</span> <span class="s">&quot;Bragg Peak at :</span><span class="si">%f</span><span class="s"> in patient - spacing = </span><span class="si">%f</span><span class="s"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ySpacing</span> <span class="o">*</span> <span class="p">(</span><span class="n">compDose</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">indBraggPeak</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_ySpacing</span><span class="p">)</span>
        <span class="c">#print &quot;Bragg Peak at :%f in water&quot;%(deff[indBraggPeak])</span>
        
</div></div>
<div class="viewcode-block" id="beamletSimul"><a class="viewcode-back" href="../../../mspt.scanning.html#mspt.scanning.deliverySimulation_Static_Dynamic.beamletSimul">[docs]</a><span class="k">def</span> <span class="nf">beamletSimul</span><span class="p">(</span><span class="n">rhomw</span><span class="p">,</span><span class="n">Smw</span><span class="p">,</span><span class="n">Xr</span><span class="p">,</span><span class="n">Yr</span><span class="p">,</span><span class="n">Zr</span><span class="p">,</span><span class="n">dmax</span><span class="p">,</span><span class="n">z_dd</span><span class="p">,</span><span class="n">dd</span><span class="p">,</span><span class="n">sig0</span><span class="p">,</span><span class="n">xrshift</span><span class="p">,</span><span class="n">yrshift</span><span class="p">,</span><span class="n">sad</span><span class="p">,</span><span class="n">ssd0</span><span class="p">,</span><span class="n">Deff</span><span class="p">,</span> <span class="n">indicesRay</span><span class="p">,</span><span class="n">x0y0z0_IECF</span><span class="p">,</span><span class="n">IECFSpacing</span><span class="p">,</span><span class="n">rotMatrixInv</span><span class="p">,</span><span class="n">typeFloat</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Calls the C extension: beamletSimulation_PythonExt and returns its result.</span>
<span class="sd">        </span>
<span class="sd">    The goal of this function is to simulate a beamlet and get the dose deposited by this beamlet.</span>
<span class="sd">    </span>
<span class="sd">    :param rhomw: 3D numpy array density ratio to water (i.e. density matrix since water density = 1.0 g.cm-3)</span>
<span class="sd">    :param Smw: 3D numpy array of the relative stopping power ratio to water</span>
<span class="sd">    :param Xr: 3D matrix representing x coordinates in the IEC Gantry coordinate system (cm).</span>
<span class="sd">    :param Yr: 3D matrix representing y coordinates in the IEC Gantry coordinate system (cm).</span>
<span class="sd">    :param Zr: 3D matrix representing z coordinates in the IEC Gantry coordinate system (cm).</span>
<span class="sd">    :param dmax: Bragg Peak depth (cm).</span>
<span class="sd">    :param z_dd: &quot;depth&quot; coordinates for the depth dose curve (cm).</span>
<span class="sd">    :param dd: &quot;dose&quot; coordinates for the depth dose curve. (Gy.cm ^2 )</span>
<span class="sd">    :param sig0: beam size (along x and y IEC gantry axis) at patient entrance (cm): [sig0X,sig0Y]</span>
<span class="sd">    :param xrshift: x beam shift (from isocenter) used to define target position. Provided in the IEC gantry coordinate system.(cm)</span>
<span class="sd">    :param yrshift: y beam shift (from isocenter) used to define target position. Provided in the IEC gantry coordinate system.(cm)</span>
<span class="sd">    :param sad: source-axis distance: distance between the source and the isocenter.(cm)</span>
<span class="sd">    :param ssd0: source to patient surface distance (cm)</span>
<span class="sd">    :param Deff: 3D matrix representing the radiological depth.(cm)</span>
<span class="sd">    :param indicesRay: list of indices (frame,row, column) of the voxels encountered by the ray from the source to the target spot (xrshift,yrshift)\</span>
<span class="sd">    located in the isocenter plane. They are sorted by increasing distance from the source.</span>
<span class="sd">    :param x0y0z0_IECF: beam target point in the IEC fixed coordinate system.</span>
<span class="sd">    :param spacingIECF: voxel spacing in the IEC fixed coord system</span>
<span class="sd">    :param rotMatrixInv: 3x3 array (rotation matrix) to convert coordinates from IECG to IECF</span>
<span class="sd">    :param typeFloat: the type of numpy float to be used: &#39;float32&#39; or &#39;float64&#39;</span>

<span class="sd">    :returns: The resulting 3D dose distribution in a numpy array. </span>
<span class="sd"> </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">test</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">typeFloat</span><span class="p">)</span>
    <span class="n">typetest</span><span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
    <span class="n">datatest</span><span class="o">=</span><span class="n">test</span><span class="o">.</span><span class="n">dtype</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s">&#39;rhomw&#39;</span><span class="p">,</span><span class="s">&#39;Smw&#39;</span><span class="p">,</span><span class="s">&#39;Xr&#39;</span><span class="p">,</span><span class="s">&#39;Yr&#39;</span><span class="p">,</span><span class="s">&#39;Zr&#39;</span><span class="p">,</span><span class="s">&#39;Deff&#39;</span><span class="p">]):</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span> <span class="o">!=</span> <span class="n">typetest</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;type &#39;</span><span class="si">%s</span><span class="s">&#39; : </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="n">mat</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;In beamletSimulation, mat is not *NumPy* array&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">mat</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;len shape &#39;</span><span class="si">%s</span><span class="s">&#39; : </span><span class="si">%i</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">mat</span><span class="p">)))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;In beamletSimulation, mat is not NumPy *3D array*&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mat</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">datatest</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;type &#39;</span><span class="si">%s</span><span class="s">&#39; : </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">mat</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;In beamletSimulation, mat is not *Float* NumPy array&#39;</span><span class="p">)</span>
    
    <span class="n">test</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">typeFloat</span><span class="p">)</span>
    <span class="n">typetest</span><span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
    <span class="n">datatest</span><span class="o">=</span><span class="n">test</span><span class="o">.</span><span class="n">dtype</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s">&#39;z_dd&#39;</span><span class="p">,</span><span class="s">&#39;dd&#39;</span><span class="p">]):</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span> <span class="o">!=</span> <span class="n">typetest</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;type &#39;</span><span class="si">%s</span><span class="s">&#39; : </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="n">mat</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;In beamletSimulation, mat is not *NumPy* array&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">mat</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;len shape &#39;</span><span class="si">%s</span><span class="s">&#39; : </span><span class="si">%i</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">mat</span><span class="p">)))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;In beamletSimulation, mat is not NumPy *3D array*&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mat</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">datatest</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;type &#39;</span><span class="si">%s</span><span class="s">&#39; : </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">mat</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;In beamletSimulation, mat is not *Float* NumPy array&#39;</span><span class="p">)</span>
        
    <span class="n">test</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">typeFloat</span><span class="p">)</span>
    <span class="n">typetest</span><span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
    <span class="n">datatest</span><span class="o">=</span><span class="n">test</span><span class="o">.</span><span class="n">dtype</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s">&#39;dmax&#39;</span><span class="p">,</span><span class="s">&#39;xrshift&#39;</span><span class="p">,</span><span class="s">&#39;yrshift&#39;</span><span class="p">,</span><span class="s">&#39;sad&#39;</span><span class="p">,</span><span class="s">&#39;ssd0&#39;</span><span class="p">]):</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span> <span class="o">!=</span> <span class="n">typetest</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;type &#39;</span><span class="si">%s</span><span class="s">&#39; : </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="n">mat</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;In beamletSimulation, mat is not *NumPy* array&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mat</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;size &#39;</span><span class="si">%s</span><span class="s">&#39; : </span><span class="si">%i</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">mat</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;In beamletSimulation, mat is not NumPy *3D array*&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mat</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">datatest</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;type &#39;</span><span class="si">%s</span><span class="s">&#39; : </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">mat</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;In beamletSimulation, mat is not *Float* NumPy array&#39;</span><span class="p">)</span>

    <span class="n">test</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="s">&#39;int&#39;</span><span class="p">)</span>
    <span class="n">typetest</span><span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
    <span class="n">datatest</span><span class="o">=</span><span class="n">test</span><span class="o">.</span><span class="n">dtype</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s">&#39;indicesRay&#39;</span><span class="p">]):</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span> <span class="o">!=</span> <span class="n">typetest</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;type &#39;</span><span class="si">%s</span><span class="s">&#39; : </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="n">mat</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;In beamletSimulation, mat is not *NumPy* array&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mat</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">datatest</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;type &#39;</span><span class="si">%s</span><span class="s">&#39; : </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">mat</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;In beamletSimulation, mat is not *int* NumPy array&#39;</span><span class="p">)</span>
            
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s">&#39;x0y0z0_IECF&#39;</span><span class="p">,</span><span class="s">&#39;IECFSpacing&#39;</span><span class="p">]):</span>
        <span class="n">item</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">test</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">typeFloat</span><span class="p">)</span>
        <span class="n">typetest</span><span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
        <span class="n">datatest</span><span class="o">=</span><span class="n">test</span><span class="o">.</span><span class="n">dtype</span>
        
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">!=</span> <span class="n">typetest</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">item</span>
            <span class="n">stringError</span> <span class="o">=</span> <span class="s">&#39;In beamletSimulation, &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span><span class="s">&#39; is not *NumPy* array&#39;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">stringError</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">item</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">item</span>
            <span class="n">stringError</span> <span class="o">=</span> <span class="s">&#39;In beamletSimulation, &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span><span class="s">&#39; is not NumPy *matrix*&#39;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">stringError</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">datatest</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">item</span>
            <span class="n">stringError</span> <span class="o">=</span> <span class="s">&#39;In beamletSimulation, &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span><span class="s">&#39; is not *Float* NumPy array&#39;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">stringError</span><span class="p">)</span>
 
 
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s">&#39;sig0&#39;</span><span class="p">]):</span>
        <span class="n">item</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">test</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">typeFloat</span><span class="p">)</span>
        <span class="n">typetest</span><span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
        <span class="n">datatest</span><span class="o">=</span><span class="n">test</span><span class="o">.</span><span class="n">dtype</span>
        
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">!=</span> <span class="n">typetest</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">item</span>
            <span class="n">stringError</span> <span class="o">=</span> <span class="s">&#39;In beamletSimulation, &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span><span class="s">&#39; is not *NumPy* array&#39;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">stringError</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">item</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">item</span>
            <span class="n">stringError</span> <span class="o">=</span> <span class="s">&#39;In beamletSimulation, &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span><span class="s">&#39; is not NumPy *matrix*&#39;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">stringError</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">datatest</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">item</span>
            <span class="n">stringError</span> <span class="o">=</span> <span class="s">&#39;In beamletSimulation, &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span><span class="s">&#39; is not *Float* NumPy array&#39;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">stringError</span><span class="p">)</span>
 
 
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s">&#39;rotMatrixInv&#39;</span><span class="p">]):</span>
        <span class="n">item</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">test</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">typeFloat</span><span class="p">)</span>
        <span class="n">typetest</span><span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
        <span class="n">datatest</span><span class="o">=</span><span class="n">test</span><span class="o">.</span><span class="n">dtype</span>
        
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">!=</span> <span class="n">typetest</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">item</span>
            <span class="n">stringError</span> <span class="o">=</span> <span class="s">&#39;In beamletSimulation, &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span><span class="s">&#39; is not *NumPy* array&#39;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">stringError</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">item</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">item</span>
            <span class="n">stringError</span> <span class="o">=</span> <span class="s">&#39;In beamletSimulation, &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span><span class="s">&#39; is not 2D NumPy *matrix*&#39;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">stringError</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">datatest</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">item</span>
            <span class="n">stringError</span> <span class="o">=</span> <span class="s">&#39;In beamletSimulation, &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span><span class="s">&#39; is not *Float* NumPy array&#39;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">stringError</span><span class="p">)</span>


    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s">&#39;rhomw&#39;</span><span class="p">,</span><span class="s">&#39;Smw&#39;</span><span class="p">,</span><span class="s">&#39;Xr&#39;</span><span class="p">,</span><span class="s">&#39;Yr&#39;</span><span class="p">,</span><span class="s">&#39;Zr&#39;</span><span class="p">,</span><span class="s">&#39;dmax&#39;</span><span class="p">,</span><span class="s">&#39;z_dd&#39;</span><span class="p">,</span><span class="s">&#39;dd&#39;</span><span class="p">,</span><span class="s">&#39;sig0&#39;</span><span class="p">,</span><span class="s">&#39;xrshift&#39;</span><span class="p">,</span><span class="s">&#39;yrshift&#39;</span><span class="p">,</span><span class="s">&#39;sad&#39;</span><span class="p">,</span><span class="s">&#39;ssd0&#39;</span><span class="p">,</span><span class="s">&#39;Deff&#39;</span><span class="p">,</span><span class="s">&#39;indicesRay&#39;</span><span class="p">,</span><span class="s">&#39;x0y0z0_IECF&#39;</span><span class="p">,</span><span class="s">&#39;IECFSpacing&#39;</span><span class="p">,</span><span class="s">&#39;rotMatrixInv&#39;</span><span class="p">]):</span>
        <span class="n">item</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">flags</span><span class="p">[</span><span class="s">&#39;C_CONTIGUOUS&#39;</span><span class="p">]:</span>
            <span class="n">strErr</span> <span class="o">=</span> <span class="s">&#39;In beamletSimulation, &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span><span class="s">&#39; is not *C-Contiguous* NumPy array&#39;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">strErr</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">typeFloat</span> <span class="o">==</span> <span class="s">&#39;float32&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_beamletSimulation</span><span class="o">.</span><span class="n">beamletSimul</span><span class="p">(</span><span class="n">rhomw</span><span class="p">,</span><span class="n">Smw</span><span class="p">,</span><span class="n">Xr</span><span class="p">,</span><span class="n">Yr</span><span class="p">,</span><span class="n">Zr</span><span class="p">,</span><span class="n">dmax</span><span class="p">,</span><span class="n">z_dd</span><span class="p">,</span><span class="n">dd</span><span class="p">,</span><span class="n">sig0</span><span class="p">,</span><span class="n">xrshift</span><span class="p">,</span><span class="n">yrshift</span><span class="p">,</span><span class="n">sad</span><span class="p">,</span><span class="n">ssd0</span><span class="p">,</span><span class="n">Deff</span><span class="p">,</span><span class="n">indicesRay</span><span class="p">,</span><span class="n">x0y0z0_IECF</span><span class="p">,</span><span class="n">IECFSpacing</span><span class="p">,</span><span class="n">rotMatrixInv</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_beamletSimulationDouble</span><span class="o">.</span><span class="n">beamletSimulDouble</span><span class="p">(</span><span class="n">rhomw</span><span class="p">,</span><span class="n">Smw</span><span class="p">,</span><span class="n">Xr</span><span class="p">,</span><span class="n">Yr</span><span class="p">,</span><span class="n">Zr</span><span class="p">,</span><span class="n">dmax</span><span class="p">,</span><span class="n">z_dd</span><span class="p">,</span><span class="n">dd</span><span class="p">,</span><span class="n">sig0</span><span class="p">,</span><span class="n">xrshift</span><span class="p">,</span><span class="n">yrshift</span><span class="p">,</span><span class="n">sad</span><span class="p">,</span><span class="n">ssd0</span><span class="p">,</span><span class="n">Deff</span><span class="p">,</span><span class="n">indicesRay</span><span class="p">,</span><span class="n">x0y0z0_IECF</span><span class="p">,</span><span class="n">IECFSpacing</span><span class="p">,</span><span class="n">rotMatrixInv</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="doseCorrectionFactor"><a class="viewcode-back" href="../../../mspt.scanning.html#mspt.scanning.deliverySimulation_Static_Dynamic.doseCorrectionFactor">[docs]</a><span class="k">def</span> <span class="nf">doseCorrectionFactor</span><span class="p">(</span> <span class="n">energy</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Function created to match RayStation absolute dose. It uses a linear interpolation to obtain a multiplicative dose correction factor for an energy.</span>
<span class="sd">    </span>
<span class="sd">    The function has been obtained by measuring the ratio between the dose obtained in RayStation and in our simulator</span>
<span class="sd">    for single beamlets in water for energies ranging from 30MeV to 245MeV.</span>
<span class="sd">    </span>
<span class="sd">    :param energy: energy in MeV</span>
<span class="sd">    </span>
<span class="sd">    :returns: The correction factor</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">listCoeff</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.926</span><span class="p">,</span>	<span class="mf">1.346</span><span class="p">,</span>	<span class="mf">1.215</span><span class="p">,</span>	<span class="mf">1.155</span><span class="p">,</span>	<span class="mf">1.117</span><span class="p">,</span>	<span class="mf">1.090</span><span class="p">,</span>	<span class="mf">1.070</span><span class="p">,</span>	<span class="mf">1.055</span><span class="p">,</span>	<span class="mf">1.044</span><span class="p">,</span>	<span class="mf">1.034</span><span class="p">,</span>	<span class="mf">1.026</span><span class="p">,</span>	<span class="mf">1.019</span><span class="p">,</span>	<span class="mf">1.014</span><span class="p">,</span>	<span class="mf">1.008</span><span class="p">,</span>	<span class="mf">1.004</span><span class="p">,</span>	<span class="mf">0.999</span><span class="p">,</span>	<span class="mf">0.995</span><span class="p">,</span>	<span class="mf">0.992</span><span class="p">,</span>	<span class="mf">0.989</span><span class="p">,</span>	<span class="mf">0.986</span><span class="p">,</span>	<span class="mf">0.983</span><span class="p">,</span>	<span class="mf">0.980</span><span class="p">,</span>	<span class="mf">0.977</span><span class="p">,</span>	<span class="mf">0.974</span><span class="p">,</span>	<span class="mf">0.972</span><span class="p">,</span>	<span class="mf">0.969</span><span class="p">,</span>	<span class="mf">0.966</span><span class="p">,</span>	<span class="mf">0.964</span><span class="p">,</span>	<span class="mf">0.961</span><span class="p">,</span>	<span class="mf">0.959</span><span class="p">,</span>	<span class="mf">0.956</span><span class="p">,</span>	<span class="mf">0.954</span><span class="p">,</span>	<span class="mf">0.951</span><span class="p">,</span>	<span class="mf">0.949</span><span class="p">,</span>	<span class="mf">0.947</span><span class="p">,</span>	<span class="mf">0.944</span><span class="p">,</span>	<span class="mf">0.942</span><span class="p">,</span>	<span class="mf">0.939</span><span class="p">,</span>	<span class="mf">0.937</span><span class="p">,</span>	<span class="mf">0.934</span><span class="p">,</span>	<span class="mf">0.932</span><span class="p">,</span>	<span class="mf">0.930</span><span class="p">,</span>	<span class="mf">0.927</span><span class="p">,</span>	<span class="mf">0.923</span><span class="p">,</span>	<span class="mf">0.920</span><span class="p">,</span>	<span class="mf">0.918</span><span class="p">]</span>
    <span class="n">listEner</span> <span class="o">=</span>   <span class="p">[</span><span class="mf">20.1</span>    <span class="p">,</span>	<span class="mf">25.1</span>    <span class="p">,</span>	<span class="mf">30.1</span>    <span class="p">,</span>	<span class="mf">35.1</span>    <span class="p">,</span>	<span class="mf">40.1</span>    <span class="p">,</span>	<span class="mf">45.1</span>    <span class="p">,</span>	<span class="mf">50.1</span>    <span class="p">,</span>	<span class="mf">55.1</span>    <span class="p">,</span>	<span class="mf">60.1</span>    <span class="p">,</span>	<span class="mf">65.09</span>   <span class="p">,</span>	<span class="mf">70.09</span>   <span class="p">,</span>	<span class="mf">75.09</span>   <span class="p">,</span>	<span class="mf">80.09</span>   <span class="p">,</span>	<span class="mf">85.09</span>   <span class="p">,</span>	<span class="mf">90.09</span>   <span class="p">,</span>	<span class="mf">95.09</span>   <span class="p">,</span>	<span class="mf">100.09</span>  <span class="p">,</span>	<span class="mf">105.09</span>  <span class="p">,</span>	<span class="mf">110.09</span>  <span class="p">,</span>	<span class="mf">115.09</span>  <span class="p">,</span>	<span class="mf">120.09</span>  <span class="p">,</span>	<span class="mf">125.09</span>  <span class="p">,</span>	<span class="mf">130.09</span>  <span class="p">,</span>	<span class="mf">135.09</span>  <span class="p">,</span>	<span class="mf">140.09</span>  <span class="p">,</span>	<span class="mf">145.09</span>  <span class="p">,</span>	<span class="mf">150.09</span>  <span class="p">,</span>	<span class="mf">155.09</span>  <span class="p">,</span>	<span class="mf">160.09</span>  <span class="p">,</span>	<span class="mf">165.09</span>  <span class="p">,</span>	<span class="mf">170.09</span>  <span class="p">,</span>	<span class="mf">175.09</span>  <span class="p">,</span>	<span class="mf">180.09</span>  <span class="p">,</span>	<span class="mf">185.09</span>  <span class="p">,</span>	<span class="mf">190.09</span>  <span class="p">,</span>	<span class="mf">195.09</span>  <span class="p">,</span>	<span class="mf">200.09</span>  <span class="p">,</span>	<span class="mf">205.09</span>  <span class="p">,</span>	<span class="mf">210.09</span>  <span class="p">,</span>	<span class="mf">215.09</span>  <span class="p">,</span>	<span class="mf">220.09</span>  <span class="p">,</span>	<span class="mf">225.09</span>  <span class="p">,</span>	<span class="mf">230.09</span>  <span class="p">,</span>	<span class="mf">235.09</span>  <span class="p">,</span>	<span class="mf">240.09</span>  <span class="p">,</span>	<span class="mf">245.09</span><span class="p">]</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">listEner</span><span class="p">,</span> <span class="n">listCoeff</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s">&#39;linear&#39;</span><span class="p">,</span><span class="n">bounds_error</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">fill_value</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="n">factor</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">factor</span>

    </div>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, Paul Morel, LIGM, Univ. Paris-Est MLV, France.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>