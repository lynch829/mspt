

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mspt.dataViewer.array2DViewer &mdash; mspt  documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="mspt  documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../../../index.html" class="fa fa-home"> mspt</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../mspt.html">mspt package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../mspt.html#subpackages">Subpackages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../mspt.html#module-mspt">Module contents</a></li>
</ul>
</li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">mspt</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      
    <li>mspt.dataViewer.array2DViewer</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <h1>Source code for mspt.dataViewer.array2DViewer</h1><div class="highlight"><pre>
<span class="c">########################################################################</span>
<span class="c">#</span>
<span class="c"># array2DViewer.py</span>
<span class="c"># </span>
<span class="c"># Created by Paul Morel, LIGM, Universite Paris-Est Marne La Vallee, France</span>
<span class="c"># paul.morel@univ-mlv.fr</span>
<span class="c"># June 2012</span>
<span class="c">#</span>
<span class="c"># Copyright 2011-2014 Paul Morel, LIGM, Universite Paris-Est Marne La Vallee, France</span>
<span class="c">#</span>
<span class="c"># This file is part of MSPT- Motion Simulator in Proton Therapy.</span>
<span class="c">#</span>
<span class="c">#    MSPT- Motion Simulator in Proton Therapy is free software: you can redistribute it and/or modify</span>
<span class="c">#    it under the terms of the GNU General Public License as published by</span>
<span class="c">#    the Free Software Foundation, either version 3 of the License, or</span>
<span class="c">#    (at your option) any later version.</span>
<span class="c">#</span>
<span class="c">#    MSPT- Motion Simulator in Proton Therapy is distributed in the hope that it will be useful,</span>
<span class="c">#    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c">#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c">#    GNU General Public License for more details.</span>
<span class="c">#</span>
<span class="c">#    You should have received a copy of the GNU General Public License</span>
<span class="c">#    along with MSPT- Motion Simulator in Proton Therapy.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c"># </span>
<span class="c">#   Code used to save a 2D numpy array to a PNG or Tiff image</span>
<span class="c">#   A file is also stored with each image file: &quot;.met&quot;. It is a file readable</span>
<span class="c">#   with cPickle library and is intended to store the data used to convert actual intensities</span>
<span class="c">#   to the intensity range used in the image, i.e. 0-255 for PNG and 0-65535 for Tiff</span>
<span class="c">########################################################################</span>
<span class="kn">import</span> <span class="nn">PIL.Image</span> <span class="kn">as</span> <span class="nn">Image</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">cPickle</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="kn">as</span> <span class="nn">mpl</span>



<div class="viewcode-block" id="XServer_is_running"><a class="viewcode-back" href="../../../mspt.dataViewer.html#mspt.dataViewer.array2DViewer.XServer_is_running">[docs]</a><span class="k">def</span> <span class="nf">XServer_is_running</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Code used to test if the X11 server is running. This is used to know how configure the displays in matplotlib</span>
<span class="sd">    </span>
<span class="sd">    :returns: True or False</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">Popen</span><span class="p">,</span> <span class="n">PIPE</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Popen</span><span class="p">([</span><span class="s">&quot;xset&quot;</span><span class="p">,</span> <span class="s">&quot;-q&quot;</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span>

</div>
<span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;DISPLAY&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">mpl</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s">&quot;Agg&quot;</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;No display&quot;</span>
<span class="k">else</span><span class="p">:</span> <span class="c">#Some problems appeared for the display on some servers ([ &quot;c-iibi000&quot; ])  </span>
        <span class="c"># when connecting by ssh without using X11 on the client and when the ssh options</span>
        <span class="c"># -X or -Y are not used: &#39;DISPLAY&#39; was in os.environ.keys() whereas it should not</span>
        <span class="c"># So the lines right after intend to fix this problem. However, there is no problem is </span>
        <span class="c"># the server is accessed using ssh -X or -Y. No other fix has been found yet.</span>
    <span class="kn">import</span> <span class="nn">socket</span>
    <span class="n">currentServer</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
    <span class="k">if</span>  <span class="n">currentServer</span> <span class="ow">in</span> <span class="p">[</span> <span class="s">&quot;c-iibi000&quot;</span> <span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span>  <span class="n">XServer_is_running</span><span class="p">():</span><span class="c"># Test if X11 is running on the server.</span>
            <span class="n">mpl</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s">&quot;Agg&quot;</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;No display&quot;</span>


<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">colorConverter</span>
<span class="kn">import</span> <span class="nn">matplotlib.image</span> <span class="kn">as</span> <span class="nn">mpimg</span>
<span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="kn">as</span> <span class="nn">cm</span>
<span class="kn">import</span> <span class="nn">time</span>

    
<div class="viewcode-block" id="saveDataToImagePNG"><a class="viewcode-back" href="../../../mspt.dataViewer.html#mspt.dataViewer.array2DViewer.saveDataToImagePNG">[docs]</a><span class="k">def</span> <span class="nf">saveDataToImagePNG</span><span class="p">(</span> <span class="n">data</span> <span class="p">,</span> <span class="n">filename</span><span class="p">,</span><span class="n">min_max</span><span class="o">=</span><span class="p">[],</span><span class="n">bw</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Save a 2D array to an image file: png if the data is in the range 0-255 and tiff otherwise. \ </span>
<span class="sd">    The array is linearly scaled to be in the range 0-255 (png) or 0-65535 (tiff). This is determined by the maximum value stored in min_max.</span>
<span class="sd">    </span>
<span class="sd">    :param data: 2D numpy array</span>
<span class="sd">    :param filename: path and name of the image to be saved. The extension (.png or .tiff) will be added in the function.</span>
<span class="sd">    :param min_max: By default min_max = []. In this case the maximum image intensity is automatically set to 255 or 65535 depending on what\</span>
<span class="sd">    the maximum value is in data. If min_max = [min_Val , max_Val], the linear scaling determines the slope and the intercept to be used \</span>
<span class="sd">    based on these min_max values. Max_Val will determine if the image will be a png (0-255) or a tiff (0-65535).</span>
<span class="sd">    :param bw: True (Default) / False. True to save the image in black and white (grayscale), False to save it in color. Note that images saved \</span>
<span class="sd">    in tiff format are automatically saved in black-and white.</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">if</span> <span class="n">min_max</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">mini</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">maxi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mini</span> <span class="o">=</span> <span class="n">min_max</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">maxi</span> <span class="o">=</span> <span class="n">min_max</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
          
    <span class="k">if</span> <span class="n">mini</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">maxi</span><span class="o">!=</span> <span class="mi">255</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">maxi</span> <span class="o">&lt;</span> <span class="mi">255</span><span class="p">:</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="mi">255</span> <span class="c">#pow(2,8)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">limit</span> <span class="o">=</span> <span class="mi">65535</span> <span class="c">#pow(2,16)</span>
        
        <span class="k">if</span> <span class="n">mini</span> <span class="o">!=</span> <span class="n">maxi</span><span class="p">:</span>
            <span class="n">slope</span> <span class="o">=</span>  <span class="n">limit</span><span class="o">/</span> <span class="p">(</span><span class="n">maxi</span> <span class="o">-</span> <span class="n">mini</span><span class="p">)</span>
            <span class="n">intercept</span> <span class="o">=</span> <span class="o">-</span><span class="n">slope</span> <span class="o">*</span> <span class="n">mini</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">slope</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="k">if</span> <span class="n">mini</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">intercept</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">maxi</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">:</span>
                <span class="n">intercept</span> <span class="o">=</span> <span class="n">limit</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">intercept</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">limit</span> <span class="o">==</span> <span class="mi">255</span><span class="p">:</span>
            <span class="n">scaledData_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">scaledData_int</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">scaledData_int</span><span class="p">[:,:]</span> <span class="o">+</span>  <span class="n">slope</span> <span class="o">*</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="n">intercept</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">bw</span><span class="p">:</span>
                <span class="n">dataRange01</span> <span class="o">=</span> <span class="n">scaledData_int</span> <span class="o">/</span> <span class="mf">255.0</span> 
                <span class="n">coloredData</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">(</span><span class="n">dataRange01</span><span class="p">)</span>
                <span class="n">scaledData_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span> <span class="n">coloredData</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                <span class="n">scaledData_int</span><span class="p">[:,:,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">coloredData</span><span class="o">*</span><span class="mf">255.0</span><span class="p">)[:,:,:]</span>
                
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scaledData_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>
            <span class="n">scaledData_int</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">scaledData_int</span><span class="p">[:,:]</span> <span class="o">+</span>  <span class="n">slope</span> <span class="o">*</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="n">intercept</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">bw</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="n">limit</span> <span class="o">==</span> <span class="mi">255</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">scaledData_int</span><span class="p">)</span>
            <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">((</span><span class="n">filename</span><span class="o">+</span><span class="s">&#39;.png&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">scaledData_int</span><span class="p">,</span><span class="s">&#39;I;16&#39;</span><span class="p">)</span>
            <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">((</span><span class="n">filename</span><span class="o">+</span><span class="s">&#39;.tiff&#39;</span><span class="p">))</span>            

    <span class="k">else</span><span class="p">:</span>
        <span class="n">data_int</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">data_int</span><span class="p">)</span>
        <span class="n">img</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s">&quot;dpi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">360</span>
        <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">((</span><span class="n">filename</span><span class="o">+</span><span class="s">&#39;.png&#39;</span><span class="p">))</span>
        
        </div>
<div class="viewcode-block" id="openPNGImageToArray"><a class="viewcode-back" href="../../../mspt.dataViewer.html#mspt.dataViewer.array2DViewer.openPNGImageToArray">[docs]</a><span class="k">def</span> <span class="nf">openPNGImageToArray</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Loads a PNG image and returns it as a numpy array.</span>
<span class="sd">    </span>
<span class="sd">    :param filename: The image file to open.</span>
<span class="sd">    </span>
<span class="sd">    :returns: A 2D numpy array corresponding to the input image.</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">fileName</span><span class="p">,</span> <span class="n">fileExtension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span>
        </div>
<div class="viewcode-block" id="displayImageFromArray"><a class="viewcode-back" href="../../../mspt.dataViewer.html#mspt.dataViewer.array2DViewer.displayImageFromArray">[docs]</a><span class="k">def</span> <span class="nf">displayImageFromArray</span><span class="p">(</span> <span class="n">data</span> <span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Displays an image from a numpy array using matplotlib. It uses &quot;jet&quot; colormap and \</span>
<span class="sd">    the figure opens and closes automatically.</span>
<span class="sd">    </span>
<span class="sd">    :param data: 2D numpy array.</span>
<span class="sd">    :param name: If name is not None, it is used as the title of the figure. </span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
   
    <span class="n">img</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">cmap</span> <span class="o">=</span> <span class="s">&#39;jet&#39;</span><span class="p">)</span>
    <span class="n">cbar</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s">&#39;jet&#39;</span><span class="p">)</span>
    
    <span class="n">displayPlot</span><span class="p">()</span>

    


</div>
<div class="viewcode-block" id="displayPlot"><a class="viewcode-back" href="../../../mspt.dataViewer.html#mspt.dataViewer.array2DViewer.displayPlot">[docs]</a><span class="k">def</span> <span class="nf">displayPlot</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Draws the window with the figure and the subplots. It is displayed during 10 seconds.</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
    <span class="k">if</span> <span class="s">&#39;DISPLAY&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="closePlot"><a class="viewcode-back" href="../../../mspt.dataViewer.html#mspt.dataViewer.array2DViewer.closePlot">[docs]</a><span class="k">def</span> <span class="nf">closePlot</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Closes the matplotlib plotting area.</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s">&#39;all&#39;</span><span class="p">)</span>
 
    </div>
<div class="viewcode-block" id="saveFigure"><a class="viewcode-back" href="../../../mspt.dataViewer.html#mspt.dataViewer.array2DViewer.saveFigure">[docs]</a><span class="k">def</span> <span class="nf">saveFigure</span><span class="p">(</span> <span class="n">pathToSave</span><span class="p">,</span><span class="n">filename</span> <span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="s">&#39;png&#39;</span><span class="p">,</span> <span class="n">subplotIdx</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Saves a matplotlib figure to an image file (png or pdf).</span>
<span class="sd">    </span>
<span class="sd">    :param pathToSave: Path where to save the image.</span>
<span class="sd">    :param filename: Image name.</span>
<span class="sd">    :param ext: File extension (png or pdf). By default: png.</span>
<span class="sd">    :param subplotIdx: If the figure contains several subplots and the user wants to save only 1 subplot it needs to specify it.\</span>
<span class="sd">    For example if the plots are in a grid 2x3 and one wants to plot the 4th subplot, subplotIdx = 234. \</span>
<span class="sd">    If there is a single subplot: 111. It is None by default.</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
    <span class="c">#format = png or pdf</span>
    <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;png&#39;</span><span class="p">,</span><span class="s">&#39;pdf&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ext</span><span class="p">)):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>       
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;Wrong extension: </span><span class="si">%s</span><span class="s">. Should be pdf or png&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;Plot will be saved as png.&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.png&#39;</span><span class="p">):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">&#39;.png&#39;</span> 
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pathToSave</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">pathToSave</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">subplotIdx</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">pathToSave</span> <span class="o">+</span><span class="n">filename</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s">&#39;tight&#39;</span><span class="p">,</span><span class="n">dpi</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span><span class="n">transparent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">pathToSave</span> <span class="o">+</span><span class="n">filename</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;.pdf&#39;</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s">&#39;tight&#39;</span><span class="p">,</span><span class="n">dpi</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span><span class="n">transparent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;Something went wrong: image : </span><span class="si">%s</span><span class="s"> could not be saved.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">pathToSave</span> <span class="o">+</span><span class="n">filename</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">print</span> <span class="s">&quot;Sorry, something went wrong. Image was saved as a pdf.&quot;</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;.pdf&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">extent</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">subplotIdx</span><span class="p">)</span><span class="o">.</span><span class="n">get_window_extent</span><span class="p">()</span><span class="o">.</span><span class="n">transformed</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">dpi_scale_trans</span><span class="o">.</span><span class="n">inverted</span><span class="p">())</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">pathToSave</span> <span class="o">+</span><span class="n">filename</span> <span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="n">extent</span><span class="o">.</span><span class="n">expanded</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">),</span><span class="n">dpi</span> <span class="o">=</span> <span class="mi">360</span><span class="p">,</span><span class="n">transparent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> 
        <span class="k">except</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">pathToSave</span> <span class="o">+</span><span class="n">filename</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;.pdf&#39;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="n">extent</span><span class="o">.</span><span class="n">expanded</span><span class="p">(</span><span class="mf">1.7</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">),</span><span class="n">dpi</span> <span class="o">=</span> <span class="mi">360</span><span class="p">,</span><span class="n">transparent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;Something went wrong: image : </span><span class="si">%s</span><span class="s"> could not be saved.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">pathToSave</span> <span class="o">+</span><span class="n">filename</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">print</span> <span class="s">&quot;Sorry, something went wrong. Image was saved as a pdf.&quot;</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;.pdf&#39;</span>
    <span class="k">print</span> <span class="s">&quot;Image </span><span class="si">%s</span><span class="s"> saved&quot;</span><span class="o">%</span><span class="p">((</span><span class="n">pathToSave</span> <span class="o">+</span><span class="n">filename</span><span class="p">))</span>


</div>
<div class="viewcode-block" id="storeMatrixAsImage"><a class="viewcode-back" href="../../../mspt.dataViewer.html#mspt.dataViewer.array2DViewer.storeMatrixAsImage">[docs]</a><span class="k">def</span> <span class="nf">storeMatrixAsImage</span><span class="p">(</span><span class="n">pathToSave</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">name</span><span class="p">,</span> <span class="n">alongAxis</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span><span class="n">cpkl</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">bw</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>  <span class="n">minmax</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Stores a 3D numpy array as a stack of images and stores the numpy array data in a cPickle structure through the function &#39;storeData()&#39;.</span>
<span class="sd">    Slices can be stored along a given axis: &#39;z&#39; dicom patient axis, &#39;y&#39; dicom patient axis, &#39;x&#39; dicom patient axis. \</span>
<span class="sd">    By default &#39;z&#39; axis is chosen. </span>
<span class="sd">    </span>
<span class="sd">    :param pathToSave: Path where to save the images.</span>
<span class="sd">    :param data: 3D numpy array to save.</span>
<span class="sd">    :param name: Name for the images to save.</span>
<span class="sd">    :param alongAxis: List of the axis along which the images will be saved. By default the value is None which corresponds to &#39;z&#39;. \</span>
<span class="sd">    Possible values are &#39;x&#39; (i.e. the images are stored along the column axis of the dicom image), &#39;y&#39; (i.e. the images are stored \</span>
<span class="sd">    along the rows axis of the dicom image), &#39;z&#39; (i.e. the images are stored along the frame axis of the dicom image). This can be used\</span>
<span class="sd">    when the patient is moving and the user wants to see the motions from the side, the top or the front of the dicom image.</span>
<span class="sd">    :param cpkl: True to save the 3D numpy array to a cPickle structure. This allows to have have access to the numpy array outside the simulator. \</span>
<span class="sd">    False otherwise. Default: False.</span>
<span class="sd">    :param bw: True to save the images in black and white. False otherwise. Default: True</span>
<span class="sd">    :param minmax: Min and Max values used to scale the image intensities. Default: None, in this case the min and max used are the min and max \</span>
<span class="sd">    of the numpy array.</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pathToSave</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">pathToSave</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cpkl</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">pathToSave</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;.cpkl&quot;</span>
        <span class="n">storeData</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">alongAxis</span> <span class="o">!=</span> <span class="s">&#39;z&#39;</span> <span class="ow">and</span> <span class="n">alongAxis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">alongAxis</span> <span class="o">==</span> <span class="s">&#39;x&#39;</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> : Slices being stored along X axis&quot;</span><span class="o">%</span><span class="n">name</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">data</span> <span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span><span class="s">&quot;_alongX&quot;</span>
        <span class="k">elif</span> <span class="n">alongAxis</span> <span class="o">==</span> <span class="s">&#39;y&#39;</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> : Slices being stored along Y axis&quot;</span><span class="o">%</span><span class="n">name</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">data</span> <span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span><span class="s">&quot;_alongY&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot; Unrecognized &#39;alongAxis&#39; value : </span><span class="si">%s</span><span class="s">. Slices will be sotred along Z axis.&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">alongAxis</span><span class="p">))</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span><span class="s">&quot;_alongZ&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> : Slices being stored along Z axis&quot;</span><span class="o">%</span><span class="n">name</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span><span class="s">&quot;_alongZ&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">pathToSave</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;/&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                
    <span class="n">countFrame</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">minmax</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">mini</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">maxi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mini</span> <span class="o">=</span> <span class="n">minmax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">maxi</span> <span class="o">=</span> <span class="n">minmax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
    <span class="k">if</span> <span class="n">maxi</span> <span class="o">&gt;</span> <span class="mi">255</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">bw</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;Warning - image saved will be stored in tiff and color in not supported yet. It will be saved in black/white.&quot;</span>
        <span class="n">bw</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">strFrame</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%04d</span><span class="s">&quot;</span><span class="o">%</span><span class="n">countFrame</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;-frame-&quot;</span><span class="o">+</span><span class="n">strFrame</span>
        <span class="n">saveDataToImagePNG</span><span class="p">(</span><span class="n">frame</span> <span class="p">,</span> <span class="n">filename</span><span class="p">,</span><span class="n">min_max</span><span class="o">=</span><span class="p">[</span><span class="n">mini</span><span class="p">,</span><span class="n">maxi</span><span class="p">],</span><span class="n">bw</span> <span class="o">=</span> <span class="n">bw</span><span class="p">)</span>
        <span class="n">countFrame</span> <span class="o">=</span> <span class="n">countFrame</span><span class="o">+</span><span class="mi">1</span>    
</div>
<div class="viewcode-block" id="storeData"><a class="viewcode-back" href="../../../mspt.dataViewer.html#mspt.dataViewer.array2DViewer.storeData">[docs]</a><span class="k">def</span> <span class="nf">storeData</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Stores some data to a cPickle structure. This allows to open the data, as it would be in the simulator, outside the simulator.</span>
<span class="sd">    </span>
<span class="sd">    :param filename: Path where to save the cPickle file.</span>
<span class="sd">    :param data: Any python data to save.</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">cPickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">&#39;wb&#39;</span><span class="p">),</span> <span class="n">protocol</span><span class="o">=</span><span class="n">cPickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">Data stored to cPickle struct.: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">filename</span> 
    </div>
<div class="viewcode-block" id="loadData"><a class="viewcode-back" href="../../../mspt.dataViewer.html#mspt.dataViewer.array2DViewer.loadData">[docs]</a><span class="k">def</span> <span class="nf">loadData</span><span class="p">(</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Loads cPickle data to retrieve the python data stored in it.</span>
<span class="sd">    </span>
<span class="sd">    :param filename: Path to the file to load.</span>
<span class="sd">    </span>
<span class="sd">    :returns: The data loaded.</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">fileData</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s">&quot;rb&quot;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fileData</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Data loaded from cPickle struct.: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">filename</span> 
    <span class="k">return</span> <span class="n">data</span></div>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, Paul Morel, LIGM, Univ. Paris-Est MLV, France.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>