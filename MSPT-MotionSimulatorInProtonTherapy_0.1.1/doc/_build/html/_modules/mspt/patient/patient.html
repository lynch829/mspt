

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mspt.patient.patient &mdash; mspt  documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="mspt  documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="../../../index.html" class="fa fa-home"> mspt</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../mspt.html">mspt package</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../mspt.html#subpackages">Subpackages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../mspt.html#module-mspt">Module contents</a></li>
</ul>
</li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">mspt</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      
    <li>mspt.patient.patient</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <h1>Source code for mspt.patient.patient</h1><div class="highlight"><pre>
<span class="c">########################################################################</span>
<span class="c">#</span>
<span class="c"># patient.py</span>
<span class="c"># Proton Therapy Simulator Project</span>
<span class="c"># Created by Paul Morel, LIGM, Universite Paris-Est Marne La Vallee</span>
<span class="c"># On 04/06/2012</span>
<span class="c">#</span>
<span class="c"># Copyright 2011-2014 Paul Morel, LIGM, Universite Paris-Est Marne La Vallee, France</span>
<span class="c">#</span>
<span class="c"># This file is part of MSPT- Motion Simulator in Proton Therapy.</span>
<span class="c">#</span>
<span class="c">#    MSPT- Motion Simulator in Proton Therapy is free software: you can redistribute it and/or modify</span>
<span class="c">#    it under the terms of the GNU General Public License as published by</span>
<span class="c">#    the Free Software Foundation, either version 3 of the License, or</span>
<span class="c">#    (at your option) any later version.</span>
<span class="c">#</span>
<span class="c">#    MSPT- Motion Simulator in Proton Therapy is distributed in the hope that it will be useful,</span>
<span class="c">#    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c">#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c">#    GNU General Public License for more details.</span>
<span class="c">#</span>
<span class="c">#    You should have received a copy of the GNU General Public License</span>
<span class="c">#    along with MSPT- Motion Simulator in Proton Therapy.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c">##</span>
<span class="c">########################################################################</span>
<span class="kn">import</span> <span class="nn">tools</span> <span class="kn">as</span> <span class="nn">patientTools</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">dicom</span><span class="o">,</span> <span class="nn">dicom.UID</span>
<span class="kn">from</span> <span class="nn">dicom.dataset</span> <span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">FileDataset</span>
<span class="kn">from</span> <span class="nn">..dicomReader</span> <span class="kn">import</span> <span class="n">ctToDensityConv</span>  <span class="k">as</span> <span class="n">ctToDensConv</span>
<span class="kn">from</span> <span class="nn">..dicomReader</span> <span class="kn">import</span> <span class="n">tools</span> <span class="k">as</span> <span class="n">dcmTools</span>
<span class="kn">from</span> <span class="nn">..mathTools</span> <span class="kn">import</span> <span class="n">tools</span> <span class="k">as</span> <span class="n">mathTools</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">cPickle</span>
<span class="kn">from</span> <span class="nn">..dataViewer</span> <span class="kn">import</span> <span class="n">array2DViewer</span> <span class="k">as</span> <span class="n">viewer2D</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">itemgetter</span><span class="p">,</span> <span class="n">attrgetter</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">..simulator.tools</span> <span class="kn">import</span> <span class="n">Tools</span> <span class="k">as</span> <span class="n">simTools</span>

<span class="n">templateRDFile</span> <span class="o">=</span> <span class="s">&#39;/RefData/RD1_TemplateFile.dcm&#39;</span>


<div class="viewcode-block" id="Patient"><a class="viewcode-back" href="../../../mspt.patient.html#mspt.patient.patient.Patient">[docs]</a><span class="k">class</span> <span class="nc">Patient</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    The class &quot;Patient&quot; aims to represent the patient. The patient is represented by a set of 3D matrices. It is built from the CT dicom image and the RS (Structure set)\</span>
<span class="sd">     dicom file. The 3D matrices created are:</span>
<span class="sd">     </span>
<span class="sd">        * **CT Matrix**: 3D matrix representing the CT image in Hounsfield Units.</span>
<span class="sd">        * **Density Matrix**: 3D matrix representing the densities at each voxel of the CT Matrix. The conversion from CT number to density is \</span>
<span class="sd">        made by the dicomReader.ctToDensityConv data. </span>
<span class="sd">        * **Relative Stopping Power matrix** : 3D matrix representing the relative (to water) stopping power at each voxel of the CT Matrix. It is built using the \</span>
<span class="sd">        data provided by physics.stoppingPower and the density matrix.</span>
<span class="sd">        * **Expected dose distribution** (optional): It corresponds to the 3D matrix of the dose distribution (RD dicom file) computed beforehand when planning the treatment.\</span>
<span class="sd">        If the RD dicom file is provided to the simulator the CT will be resized to cover the same volume as the RD dicom file. Moreover,\</span>
<span class="sd">        the matrix containing the RD data is resampled to have the same spacing as the CT matrix.</span>
<span class="sd">        * **Volumes of Interest (VOIs) 3D masks**: For each volume structure defined in the RS dicom file, a 3D matrix is created to store a binary mask \</span>
<span class="sd">        (1 in the volume and 0 outside) of each structure.</span>
<span class="sd">        * **Three 3D arrays** : X,Y,Z corresponding to the x,y,z coordinates in the dicom image of each voxel.</span>
<span class="sd"> </span>
<span class="sd">    :param stopPwrDataRef: Stopping power data ( physics.stoppingPower.StoppingPower) to be used for the conversion from density to relative stopping power.</span>
<span class="sd">    :param dcmData: Dictionary containing the dicom readers. The keys are:&#39;CT Image Storage&#39;,&#39;RT Structure Set Storage&#39;,&#39;RT Dose Storage&#39;  </span>
<span class="sd">    :param configData:  Dictionary configuring the motion. Mandatory keys are:</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">        * *&#39;mainPath&#39;* : corresponds to the path where any simulation will be saved.</span>
<span class="sd">        * *&#39;nameSimulation&#39;* : corresponds to the path where the current simulation will be saved.</span>
<span class="sd">        * *&#39;typeFloat&#39;* : The type of numpy float to be used: &#39;float32&#39; or &#39;float64&#39;</span>
<span class="sd">        * *&#39;staticDelivery&#39;* : True if the patient is not moving, or False otherwise</span>
<span class="sd">        * *&#39;ctPadding&#39;* (if &#39;staticDelivery&#39; is False) : True if the user wants to add margins of a specified density (see &#39;paddedCTValue&#39; ) around\</span>
<span class="sd">        the current CT image. This is useful, when the moving patient can be outside of the bounding box formed by the borders of the CT image. </span>
<span class="sd">        * *&#39;padValueFRC&#39;* (if &#39;ctPadding&#39; is True) : Numpy array of 3 integer values : [ number of added frames : nbF, number of added rows : nbR, \</span>
<span class="sd">        number of added columns : nbC]. For example : [ 0,0,10] will add 10 columns to the right of the CT image and 10 columns to the left of the CT image.</span>
<span class="sd">        * *&#39;paddedCTValue&#39;* (if &#39;ctPadding&#39; is True): The value in CT number to use to pad the CT image. For example: air = -1000, water = 0.</span>
<span class="sd">        * *&#39;storeMasksAsCPKL&#39;* : True if the user wants to store the masks of the VOIs as numpy array in a cPickle structure (this allows to have access to the \</span>
<span class="sd">        3D numpy array outdise the simulation). False otherwise. Note: whether the value is set to True or False the masks are saved as png images.</span>
<span class="sd">        * *&#39;skipSaveDensityImage&#39;* : True to skip the storage of the 3D density matrix as png images. False otherwise. Moreover, if False and the patient is moving\</span>
<span class="sd">        it will stored the 3D density array every time the array is updated. </span>
<span class="sd">        * *&#39;listSaveDensImAlong&#39;* (if &#39;skipSaveDensityImage&#39; is False) : list of the axis along which the user wants to save the density images. Possible values are\</span>
<span class="sd">        &#39;x&#39; (i.e. the images are stored along the column axis of the dicom image), &#39;y&#39; (i.e. the images are stored along the rows axis of the dicom image), \</span>
<span class="sd">        &#39;z&#39; (i.e. the images are stored along the frame axis of the dicom image). This can be used when the patient us moving and the user wants to see the motions\</span>
<span class="sd">        from the side, the top or the front of the dicom image. Examlpes: listSaveDensImAlong = [] , or listSaveDensImAlong = [&#39;x&#39;] or listSaveDensImAlong = [&#39;x&#39;,&#39;z&#39;] ... </span>
<span class="sd">        * *&#39;saveDensCPKL&#39;* (if &#39;skipSaveDensityImage&#39; is False) : True if the user wants to store the density 3D array in a cPickle structure (this allows to have access to the \</span>
<span class="sd">        3D numpy array outdise the simulation). False otherwise. Moreover, if False and the patient is moving\</span>
<span class="sd">        it will stored the 3D density array every time the array is updated. </span>
<span class="sd">        * *&#39;skipSaveStpPwrImage&#39;* : True to skip the storage of the 3D relative stopping power matrix as png images. False otherwise, however, if the patient is moving it only stores it once.</span>
<span class="sd">        * *&#39;listSaveStPwrImAlong&#39;* (if &#39;skipSaveStpPwrImage&#39; is False) :  Similar to &#39;listSaveDensImAlong&#39;, to save the images of the 3D relative stopping power matrix.</span>
<span class="sd">        * *&#39;saveStpPwrCPKL&#39;* (if &#39;skipSaveStpPwrImage&#39; is False): Similar to &#39;saveDensCPKL&#39; to save the 3D array of the relative stopping power. However, if the patient is moving it only stores it once.</span>
<span class="sd">        * *&#39;skipSaveDeff&#39;* : Similar to &#39;skipSaveStpPwrImage&#39; to save the 3D array of the radiologcial depth. If the patient is moving it stored the array at every update.  </span>
<span class="sd">        * *&#39;listSaveDeffAlong&#39;* (if &#39;skipSaveDeff&#39; is False) : Similar to &#39;listSaveDensImAlong&#39;, to save the images of the 3D radiological depth matrix.  </span>
<span class="sd">        * *&#39;saveDeffCPKL&#39;* (if &#39;skipSaveDeff&#39; is False) :  Similar to &#39;saveDensCPKL&#39; to save the 3D radiological depth matrix. If the patient is moving it stores the array at every update. </span>
<span class="sd">        * *&#39;MeV&#39;* : Constant to convert 1MeV to Joules: 1MeV = 1.602e-13J</span>
<span class="sd">        * *&#39;protPerMU&#39;* : Number of protons per MU to use.</span>

<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">  </span>
<span class="sd">        </span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>

    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">stopPwrDataRef</span><span class="p">,</span> <span class="n">dcmData</span><span class="p">,</span> <span class="n">configData</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Creates a patient from dicom data</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span> <span class="o">=</span> <span class="n">configData</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pathToOutput</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">mainPath</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">nameSimulation</span>
        <span class="k">if</span> <span class="n">dcmData</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">stopPwrDataRef</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_spacingInfo</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initPatientWithDicomData</span><span class="p">(</span><span class="n">stopPwrDataRef</span><span class="p">,</span> <span class="n">dcmData</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;No input data for Patient&quot;</span><span class="p">)</span>

            
        
<div class="viewcode-block" id="Patient.initPatientWithDicomData"><a class="viewcode-back" href="../../../mspt.patient.html#mspt.patient.patient.Patient.initPatientWithDicomData">[docs]</a>    <span class="k">def</span> <span class="nf">initPatientWithDicomData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">stopPwrDataRef</span><span class="p">,</span> <span class="n">dcmData</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Create a patient from Dicom Data. Dicom Data should be provided by a dictionnary with 3 keys:</span>
<span class="sd">        &#39;CT Image Storage&#39;,&#39;RT Structure Set Storage&#39;,&#39;RT Dose Storage&#39;. Their values are respectively dicomCTReader, dicomRSReader,</span>
<span class="sd">        dicomRDReader.</span>
<span class="sd">        </span>
<span class="sd">        :param stopPwrDataRef: Stopping power data ( physics.stoppingPower.StoppingPower) to be used for the conversion from density to relative stopping power.</span>
<span class="sd">        :param dcmData: Dictionary containing the dicom readers. The keys are:&#39;CT Image Storage&#39;,&#39;RT Structure Set Storage&#39;,&#39;RT Dose Storage&#39;  </span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">dcmData</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;DcmData is None in initPatientWithDicomData.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dcmCTReader</span> <span class="o">=</span> <span class="n">dcmData</span><span class="p">[</span><span class="s">&#39;CT Image Storage&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dcmRSReader</span> <span class="o">=</span> <span class="n">dcmData</span><span class="p">[</span><span class="s">&#39;RT Structure Set Storage&#39;</span><span class="p">]</span>
        <span class="n">dcmRDReader</span> <span class="o">=</span> <span class="n">dcmData</span><span class="p">[</span><span class="s">&#39;RT Dose Storage&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stopPwrDataRef</span> <span class="o">=</span> <span class="n">stopPwrDataRef</span>
        <span class="k">if</span> <span class="n">dcmRDReader</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pathRDFile</span> <span class="o">=</span> <span class="n">dcmRDReader</span><span class="o">.</span><span class="n">getPath</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_RDFileLoaded</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pathRDFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="n">templateRDFile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_RDFileLoaded</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buildPatient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dcmCTReader</span><span class="p">,</span><span class="n">dcmRDReader</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_dcmRSReader</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_stopPwrDataRef</span> <span class="p">)</span>
        


        
        </div>
<div class="viewcode-block" id="Patient.saveDoseDistrAsRDDcmFile"><a class="viewcode-back" href="../../../mspt.patient.html#mspt.patient.patient.Patient.saveDoseDistrAsRDDcmFile">[docs]</a>    <span class="k">def</span> <span class="nf">saveDoseDistrAsRDDcmFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newDose</span> <span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Store the &quot;newDose&quot; in a RD Dicom file. </span>
<span class="sd">        </span>
<span class="sd">        :param newDose: 3D numpy array storing a dose distribution in Gy.</span>
<span class="sd">        :param filename: Name of the file to be saved. It will be saved in at &#39;mainPath&#39;/&#39;nameSimulation&#39;/  (see class initialization).</span>
<span class="sd">        </span>
<span class="sd">        .. note::</span>
<span class="sd">        </span>
<span class="sd">            If the user provides a RD dicom file to the simulator, the new RD files created will used the values of the tags used in the input RD file,\</span>
<span class="sd">            otherwise it will rely on the tags and values used in the CT images and the RS dicom file and use a template of RD dicom file stored in the package \</span>
<span class="sd">            of the simulator. </span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">rdDcmFile</span> <span class="o">=</span> <span class="n">dicom</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pathRDFile</span><span class="p">)</span>
        
        <span class="n">file_meta</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">rdDcmFile</span><span class="o">.</span><span class="n">file_meta</span><span class="o">.</span><span class="n">dir</span><span class="p">():</span>
            <span class="n">code</span> <span class="o">=</span> <span class="s">&#39;file_meta.</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">tag</span><span class="o">+</span><span class="s">&#39; = rdDcmFile.file_meta.</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">tag</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">exec</span> <span class="n">code</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Info: </span><span class="si">%s</span><span class="s"> was not in the RD file tag&quot;</span><span class="o">%</span><span class="n">tag</span>

        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.dcm&#39;</span><span class="p">):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span>  <span class="s">&#39;.dcm&#39;</span>
            
        <span class="n">pathToSave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pathToOutput</span> <span class="c">#+ &quot;NewRefDose&quot;</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pathToSave</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">pathToSave</span><span class="p">)</span>
        
        
        <span class="n">newRD</span> <span class="o">=</span> <span class="n">FileDataset</span><span class="p">(</span><span class="n">pathToSave</span><span class="o">+</span><span class="n">filename</span><span class="p">,</span> <span class="p">{},</span><span class="n">file_meta</span> <span class="o">=</span> <span class="n">file_meta</span><span class="p">,</span><span class="n">preamble</span><span class="o">=</span><span class="n">rdDcmFile</span><span class="o">.</span><span class="n">preamble</span><span class="p">,</span>\
                    <span class="n">is_implicit_VR</span> <span class="o">=</span> <span class="n">rdDcmFile</span><span class="o">.</span><span class="n">is_implicit_VR</span> <span class="p">,</span> <span class="n">is_little_endian</span> <span class="o">=</span> <span class="n">rdDcmFile</span><span class="o">.</span><span class="n">is_little_endian</span><span class="p">)</span>
        
        <span class="n">skippedTags</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;DoseSummationType&#39;</span><span class="p">,</span><span class="s">&#39;Columns&#39;</span><span class="p">,</span><span class="s">&#39;Rows&#39;</span><span class="p">,</span><span class="s">&#39;NumberOfFrames&#39;</span><span class="p">,</span><span class="s">&#39;PixelSpacing&#39;</span><span class="p">,</span><span class="s">&#39;SliceThickness&#39;</span><span class="p">,</span><span class="s">&#39;GridFrameOffsetVector&#39;</span><span class="p">,</span><span class="s">&#39;DoseGridScaling&#39;</span><span class="p">,</span><span class="s">&#39;PixelData&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">rdDcmFile</span><span class="o">.</span><span class="n">dir</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skippedTags</span><span class="p">:</span>
                <span class="n">code</span> <span class="o">=</span> <span class="s">&#39;newRD.</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">tag</span><span class="o">+</span><span class="s">&#39; = rdDcmFile.</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="n">tag</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">exec</span> <span class="n">code</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">Info:</span><span class="si">%s</span><span class="s"> was not in the RD file tag&quot;</span><span class="o">%</span><span class="n">tag</span>
 
<span class="c">#         print &quot;rd array type:%s&quot;%(str(rdDcmFile.pixel_array.dtype))</span>
<span class="c">#         print &quot;rd dose shape: %s&quot;%(str(newDose.shape))</span>

        <span class="n">rdDcmFile</span><span class="o">.</span><span class="n">DoseSummationType</span> <span class="o">=</span> <span class="s">&#39;PLAN&#39;</span>

        <span class="n">typeArray</span> <span class="o">=</span> <span class="n">rdDcmFile</span><span class="o">.</span><span class="n">pixel_array</span><span class="o">.</span><span class="n">dtype</span>
        <span class="k">if</span> <span class="n">typeArray</span> <span class="o">==</span> <span class="s">&#39;uint16&#39;</span><span class="p">:</span>
            <span class="n">maxVal</span> <span class="o">=</span> <span class="mi">65535</span>
        <span class="k">elif</span> <span class="n">typeArray</span> <span class="o">==</span> <span class="s">&#39;uint8&#39;</span><span class="p">:</span>
            <span class="n">maxVal</span> <span class="o">=</span> <span class="mi">255</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">strErr</span> <span class="o">=</span> <span class="s">&quot;newType used in dicom not defined yet: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">typeArray</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">strErr</span><span class="p">)</span>

        <span class="n">newRD</span><span class="o">.</span><span class="n">Columns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">newDose</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">newRD</span><span class="o">.</span><span class="n">Rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">newDose</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">newRD</span><span class="o">.</span><span class="n">NumberOfFrames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">newDose</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">newRD</span><span class="o">.</span><span class="n">PixelSpacing</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">getSpacingInfo</span><span class="p">(</span><span class="s">&#39;rows&#39;</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">getSpacingInfo</span><span class="p">(</span><span class="s">&#39;cols&#39;</span><span class="p">)]</span>
        <span class="n">newRD</span><span class="o">.</span><span class="n">SliceThickness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSpacingInfo</span><span class="p">(</span><span class="s">&#39;frames&#39;</span><span class="p">)</span>
        <span class="n">newRD</span><span class="o">.</span><span class="n">GridFrameOffsetVector</span> <span class="o">=</span>  <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="o">+</span><span class="n">newRD</span><span class="o">.</span><span class="n">SliceThickness</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">newRD</span><span class="o">.</span><span class="n">NumberOfFrames</span><span class="p">)]</span>

        <span class="k">exec</span> <span class="s">&quot;gridScaling = np.</span><span class="si">%s</span><span class="s">(np.max(newDose))  / np.</span><span class="si">%s</span><span class="s">(maxVal)&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span> 
<span class="c">#         print &quot;grid scaling:%f&quot;%gridScaling</span>
        <span class="n">newRD</span><span class="o">.</span><span class="n">DoseGridScaling</span> <span class="o">=</span> <span class="n">gridScaling</span>
            
        <span class="n">scaledData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">newDose</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">typeArray</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span>
        <span class="n">scaledData</span><span class="p">[:,:,:]</span> <span class="o">=</span> <span class="p">((</span><span class="n">newDose</span> <span class="o">/</span> <span class="n">gridScaling</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">typeArray</span><span class="p">))[:,:,:]</span>
        <span class="n">newRD</span><span class="o">.</span><span class="n">PixelData</span> <span class="o">=</span> <span class="n">scaledData</span><span class="o">.</span><span class="n">tostring</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RDFileLoaded</span><span class="p">:</span>
            <span class="n">newRD</span><span class="o">.</span><span class="n">FrameOfReferenceUID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dcmRSReader</span><span class="o">.</span><span class="n">dataForAttribute</span><span class="p">(</span><span class="s">&#39;FrameOfReferenceUID&#39;</span><span class="p">)</span>
            <span class="n">newRD</span><span class="o">.</span><span class="n">StudyInstanceUID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dcmRSReader</span><span class="o">.</span><span class="n">dataForAttribute</span><span class="p">(</span><span class="s">&#39;StudyInstanceUID&#39;</span><span class="p">)</span>
            <span class="n">newRD</span><span class="o">.</span><span class="n">ManufacturerModelName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dcmRSReader</span><span class="o">.</span><span class="n">dataForAttribute</span><span class="p">(</span><span class="s">&#39;ManufacturerModelName&#39;</span><span class="p">)</span>
            <span class="n">newRD</span><span class="o">.</span><span class="n">Manufacturer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dcmRSReader</span><span class="o">.</span><span class="n">dataForAttribute</span><span class="p">(</span><span class="s">&#39;Manufacturer&#39;</span><span class="p">)</span>
            <span class="n">newRD</span><span class="o">.</span><span class="n">SoftwareVersions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dcmRSReader</span><span class="o">.</span><span class="n">dataForAttribute</span><span class="p">(</span><span class="s">&#39;SoftwareVersions&#39;</span><span class="p">)</span>
            <span class="n">newRD</span><span class="o">.</span><span class="n">PatientName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dcmRSReader</span><span class="o">.</span><span class="n">dataForAttribute</span><span class="p">(</span><span class="s">&#39;PatientName&#39;</span><span class="p">)</span>
            <span class="n">newRD</span><span class="o">.</span><span class="n">PatientID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dcmRSReader</span><span class="o">.</span><span class="n">dataForAttribute</span><span class="p">(</span><span class="s">&#39;PatientID&#39;</span><span class="p">)</span>
            <span class="n">newRD</span><span class="o">.</span><span class="n">InstanceCreationTime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dcmRSReader</span><span class="o">.</span><span class="n">dataForAttribute</span><span class="p">(</span><span class="s">&#39;InstanceCreationTime&#39;</span><span class="p">)</span>
            <span class="n">newRD</span><span class="o">.</span><span class="n">InstanceCreationDate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dcmRSReader</span><span class="o">.</span><span class="n">dataForAttribute</span><span class="p">(</span><span class="s">&#39;InstanceCreationDate&#39;</span><span class="p">)</span>
            <span class="n">newRD</span><span class="o">.</span><span class="n">StudyDate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dcmRSReader</span><span class="o">.</span><span class="n">dataForAttribute</span><span class="p">(</span><span class="s">&#39;StudyDate&#39;</span><span class="p">)</span>
            <span class="n">newRD</span><span class="o">.</span><span class="n">StudyTime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dcmRSReader</span><span class="o">.</span><span class="n">dataForAttribute</span><span class="p">(</span><span class="s">&#39;StudyTime&#39;</span><span class="p">)</span>
            <span class="n">newRD</span><span class="o">.</span><span class="n">PatientBirthDate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dcmRSReader</span><span class="o">.</span><span class="n">dataForAttribute</span><span class="p">(</span><span class="s">&#39;PatientBirthDate&#39;</span><span class="p">)</span>
            <span class="n">newRD</span><span class="o">.</span><span class="n">ImagePositionPatient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dcmCTReader</span><span class="o">.</span><span class="n">dataForAttribute</span><span class="p">(</span><span class="s">&#39;ImagePositionPatient&#39;</span><span class="p">)</span>
        
        <span class="n">newRD</span><span class="o">.</span><span class="n">save_as</span><span class="p">(</span><span class="n">pathToSave</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;RD File: </span><span class="si">%s</span><span class="s"> saved&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">pathToSave</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
        
</div>
<div class="viewcode-block" id="Patient.buildPatient"><a class="viewcode-back" href="../../../mspt.patient.html#mspt.patient.patient.Patient.buildPatient">[docs]</a>    <span class="k">def</span> <span class="nf">buildPatient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dcmCTReader</span><span class="p">,</span><span class="n">dcmRDReader</span><span class="p">,</span><span class="n">dcmRSReader</span><span class="p">,</span><span class="n">stopPwrDataRef</span> <span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Function that &quot;creates&quot; the patient. It builds and initialize all the 3D arrays.</span>
<span class="sd">        </span>
<span class="sd">        :param dcmCTReader: dicomCTReader giving access to the CT dicom series.</span>
<span class="sd">        :param dcmRDReader: dicomRDReader giving access to the RD dicom data. Note: dcmRDReader can be None is the user did not provide a RD dicom file since\</span>
<span class="sd">        this dicom file is optional.</span>
<span class="sd">        :param dcmRSReader: dicomRSReader giving access to the RS dicom data.</span>
<span class="sd">        :param stopPwrDataRef: Stopping power data ( physics.stoppingPower.StoppingPower) to be used for the conversion from density to relative stopping power.</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
    
    
        <span class="k">print</span> <span class="s">&quot;############### Start building patient data ################&quot;</span>

        <span class="c">#Extract needed data from dcm CT image</span>
        <span class="n">pixelArray</span> <span class="o">=</span> <span class="n">dcmCTReader</span><span class="o">.</span><span class="n">dataForAttribute</span><span class="p">(</span><span class="s">&#39;PixelArray&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spacingInfo</span> <span class="o">=</span> <span class="n">dcmCTReader</span><span class="o">.</span><span class="n">dataForAttribute</span><span class="p">(</span><span class="s">&#39;SpacingInfo&#39;</span><span class="p">)</span> <span class="c">#Note: spacing info in mm</span>
        <span class="n">spacingInfoCT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spacingInfo</span>
        <span class="n">imageOrientationCT</span> <span class="o">=</span> <span class="n">dcmCTReader</span><span class="o">.</span><span class="n">dataForAttribute</span><span class="p">(</span><span class="s">&#39;ImageOrientationPatient&#39;</span><span class="p">)</span>
        <span class="n">imagePositionCT</span> <span class="o">=</span> <span class="n">dcmCTReader</span><span class="o">.</span><span class="n">dataForAttribute</span><span class="p">(</span><span class="s">&#39;ImagePositionPatient&#39;</span><span class="p">)</span>
        <span class="n">endImagePositionCT</span> <span class="o">=</span> <span class="n">dcmCTReader</span><span class="o">.</span><span class="n">dataForAttribute</span><span class="p">(</span><span class="s">&#39;EndImagePositionPatient&#39;</span><span class="p">)</span>
        <span class="n">frameDirection</span> <span class="o">=</span> <span class="n">dcmTools</span><span class="o">.</span><span class="n">crossProduct</span><span class="p">(</span> <span class="n">imageOrientationCT</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="p">,</span> <span class="n">imageOrientationCT</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
        <span class="k">print</span> <span class="s">&quot;Image Orientation CT: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">imageOrientationCT</span><span class="p">)</span>
        
        
        <span class="c">#Extract data from RD file</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RDFileLoaded</span><span class="p">:</span> <span class="c"># If a RD dicom has been provided, load the data</span>
            <span class="n">imagePositionRD</span> <span class="o">=</span> <span class="n">dcmRDReader</span><span class="o">.</span><span class="n">dataForAttribute</span><span class="p">(</span><span class="s">&#39;ImagePositionPatient&#39;</span><span class="p">)</span>
            <span class="n">endImagePositionRD</span> <span class="o">=</span> <span class="n">dcmRDReader</span><span class="o">.</span><span class="n">dataForAttribute</span><span class="p">(</span><span class="s">&#39;EndImagePositionPatient&#39;</span><span class="p">)</span>
            <span class="n">spacingInfoRD</span> <span class="o">=</span> <span class="n">dcmRDReader</span><span class="o">.</span><span class="n">dataForAttribute</span><span class="p">(</span><span class="s">&#39;SpacingInfo&#39;</span><span class="p">)</span>
            <span class="n">pixelArrayRD</span> <span class="o">=</span> <span class="n">dcmRDReader</span><span class="o">.</span><span class="n">PixelArray</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span> <span class="c"># Otherwise use the CT data</span>
            <span class="n">imagePositionRD</span> <span class="o">=</span> <span class="n">imagePositionCT</span>
            <span class="n">endImagePositionRD</span> <span class="o">=</span> <span class="n">endImagePositionCT</span>
            <span class="n">spacingInfoRD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spacingInfo</span>
            <span class="n">pixelArrayRD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pixelArray</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        
        <span class="c">#Find between the CT image and the RD dicom data the one that have the tightest field of view and set the values of &quot;imagePosition&quot; </span>
        <span class="c">#(i.e. coordinates of the first voxel (0,0,0) of the 3D arrays in the dicom coordinates system) and the values of &quot;endImagePosition&quot;</span>
        <span class="c">#(i.e. coordinates of the last voxel (nb Frames - 1,nb Rows - 1, nbCols -1) of the 3D arrays in the dicom coordinates system)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_imagePosition</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">imagePositionRD</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">imagePositionCT</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_imagePosition</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">imagePositionCT</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_imagePosition</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">imagePositionRD</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        
        <span class="n">endImagePosition</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">endImagePositionRD</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">endImagePositionCT</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                <span class="n">endImagePosition</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">endImagePositionCT</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">endImagePosition</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">endImagePositionRD</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        
 
        <span class="c">#Build list of x,y,z values to build the matrices self._XArray, self._YArray ,self._ZArray</span>
        <span class="n">xList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imagePosition</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">endImagePosition</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">spacingInfoCT</span><span class="p">[</span><span class="s">&#39;cols&#39;</span><span class="p">],</span><span class="n">spacingInfoCT</span><span class="p">[</span><span class="s">&#39;cols&#39;</span><span class="p">]))</span>
        <span class="n">yList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imagePosition</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">endImagePosition</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">spacingInfoCT</span><span class="p">[</span><span class="s">&#39;rows&#39;</span><span class="p">],</span><span class="n">spacingInfoCT</span><span class="p">[</span><span class="s">&#39;rows&#39;</span><span class="p">]))</span>
        <span class="n">zList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imagePosition</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">endImagePosition</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">spacingInfoCT</span><span class="p">[</span><span class="s">&#39;frames&#39;</span><span class="p">],</span><span class="n">spacingInfoCT</span><span class="p">[</span><span class="s">&#39;frames&#39;</span><span class="p">]))</span>
  
  
  
        <span class="c">#Set the shape of the 3D arrays. This considers the case where the user want to add padding values around the CT image.</span>
        <span class="n">nbFramesRD</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">zList</span><span class="p">)</span>
        <span class="n">nbRowsRD</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">yList</span><span class="p">)</span>
        <span class="n">nbColsRD</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xList</span><span class="p">)</span>
        
        <span class="n">padFrames</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">padRows</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">padCols</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">staticDelivery</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">ctPadding</span><span class="p">:</span>
                <span class="n">padFrames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">padValueFRC</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">padRows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">padValueFRC</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">padCols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">padValueFRC</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_nFrames</span> <span class="o">=</span> <span class="n">nbFramesRD</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">padFrames</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nRows</span> <span class="o">=</span> <span class="n">nbRowsRD</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">padRows</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nCols</span> <span class="o">=</span> <span class="n">nbColsRD</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">padCols</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">staticDelivery</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">ctPadding</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;Padding with </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">padValueFRC</span><span class="p">)</span>
                <span class="n">maskPadding</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_nFrames</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nRows</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nCols</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span>
                <span class="n">startFrame</span> <span class="o">=</span> <span class="n">padFrames</span>
                <span class="n">startRow</span> <span class="o">=</span> <span class="n">padRows</span>
                <span class="n">startCol</span> <span class="o">=</span> <span class="n">padCols</span>
                <span class="n">maskPadding</span><span class="p">[</span><span class="n">startFrame</span><span class="p">:</span><span class="n">startFrame</span> <span class="o">+</span> <span class="n">nbFramesRD</span><span class="p">,</span> \
                            <span class="n">startRow</span><span class="p">:</span><span class="n">startRow</span> <span class="o">+</span> <span class="n">nbRowsRD</span><span class="p">,</span>\
                            <span class="n">startCol</span><span class="p">:</span><span class="n">startCol</span> <span class="o">+</span> <span class="n">nbColsRD</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                            
                <span class="n">indPadding</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">maskPadding</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">newZ1</span> <span class="o">=</span> <span class="p">[</span> <span class="n">zList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_spacingInfo</span><span class="p">[</span><span class="s">&#39;frames&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">startFrame</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
                <span class="n">newZ2</span> <span class="o">=</span> <span class="p">[</span> <span class="n">zList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_spacingInfo</span><span class="p">[</span><span class="s">&#39;frames&#39;</span><span class="p">]</span>  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">padFrames</span> <span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
                <span class="n">newZ1</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                <span class="n">zList</span> <span class="o">=</span> <span class="n">newZ1</span> <span class="o">+</span> <span class="n">zList</span> <span class="o">+</span> <span class="n">newZ2</span>
                
                <span class="n">newY1</span> <span class="o">=</span> <span class="p">[</span> <span class="n">yList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_spacingInfo</span><span class="p">[</span><span class="s">&#39;rows&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">startRow</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
                <span class="n">newY2</span> <span class="o">=</span> <span class="p">[</span> <span class="n">yList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_spacingInfo</span><span class="p">[</span><span class="s">&#39;rows&#39;</span><span class="p">]</span>  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">padRows</span> <span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
                <span class="n">newY1</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                <span class="n">yList</span> <span class="o">=</span> <span class="n">newY1</span> <span class="o">+</span> <span class="n">yList</span> <span class="o">+</span> <span class="n">newY2</span>
                
                <span class="n">newX1</span> <span class="o">=</span> <span class="p">[</span> <span class="n">xList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_spacingInfo</span><span class="p">[</span><span class="s">&#39;cols&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">startCol</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
                <span class="n">newX2</span> <span class="o">=</span> <span class="p">[</span> <span class="n">xList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_spacingInfo</span><span class="p">[</span><span class="s">&#39;cols&#39;</span><span class="p">]</span>  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">padCols</span> <span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
                <span class="n">newX1</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                <span class="n">xList</span> <span class="o">=</span> <span class="n">newX1</span><span class="o">+</span> <span class="n">xList</span> <span class="o">+</span> <span class="n">newX2</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">indPadding</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indPadding</span> <span class="o">=</span> <span class="bp">None</span>
            
        <span class="k">print</span> <span class="s">&quot;Patient data: Num Frames: </span><span class="si">%i</span><span class="s"> , num Rows: </span><span class="si">%i</span><span class="s">, num Cols: </span><span class="si">%i</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nFrames</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nRows</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nCols</span><span class="p">)</span>
        
        <span class="c">#Initialize all the 3D numpy arrays:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pixelArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_nFrames</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nRows</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nCols</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_densityArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_nFrames</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nRows</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nCols</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">_stpPwrArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_nFrames</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nRows</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nCols</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prescribDoseArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_nFrames</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nRows</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nCols</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_receivedDoseArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_nFrames</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nRows</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nCols</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_deff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_nFrames</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nRows</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nCols</span><span class="p">),</span><span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">staticDelivery</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tmpPixelArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_nFrames</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nRows</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nCols</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tmpDensityArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_nFrames</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nRows</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nCols</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">_tmpStpPwrArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_nFrames</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nRows</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nCols</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tmpMaskVOIs</span> <span class="o">=</span> <span class="p">[]</span>
            
        <span class="c">#Matrices storing the coordinates of the arrays&#39; voxels.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_XArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_nFrames</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nRows</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nCols</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_YArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_nFrames</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nRows</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nCols</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ZArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_nFrames</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nRows</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nCols</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>

        <span class="p">[</span><span class="n">x_mat</span><span class="p">,</span><span class="n">y_mat</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span> <span class="n">xList</span><span class="p">,</span><span class="n">yList</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nFrames</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_XArray</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">x_mat</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_YArray</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">y_mat</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nFrames</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ZArray</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">zList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ZArray</span><span class="p">[</span><span class="n">i</span><span class="p">,:,:]</span>
        
        
        <span class="c">#Attribute used to store the treatment plan isocenter.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Isocenter</span> <span class="o">=</span> <span class="bp">None</span>


        <span class="c">#Indices of the first voxel and the last voxel used for the field of view in the CT image.</span>
        <span class="n">indCTStart</span> <span class="o">=</span> <span class="n">dcmTools</span><span class="o">.</span><span class="n">coordinatesToIndexFromImagePosition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imagePosition</span><span class="p">,</span> <span class="n">imagePositionCT</span><span class="p">,</span> <span class="n">imageOrientationCT</span><span class="p">,</span> <span class="n">spacingInfoCT</span><span class="p">)</span>
        <span class="n">indCTEnd</span> <span class="o">=</span>  <span class="n">dcmTools</span><span class="o">.</span><span class="n">coordinatesToIndexFromImagePosition</span><span class="p">(</span><span class="n">endImagePosition</span><span class="p">,</span> <span class="n">imagePositionCT</span><span class="p">,</span> <span class="n">imageOrientationCT</span><span class="p">,</span> <span class="n">spacingInfoCT</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_imageOrientation</span> <span class="o">=</span> <span class="n">imageOrientationCT</span>


        <span class="c">###Fill pixel array CT ############################################################################################</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">staticDelivery</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">ctPadding</span><span class="p">:</span> <span class="c">#Padding</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pixelArray</span><span class="p">[:,:,:]</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">paddedCTValue</span>
            
        <span class="n">pixelArray3D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pixelArray</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>
        <span class="n">indStart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">indCTStart</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">,</span> <span class="n">indCTStart</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">,</span> <span class="n">indCTStart</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">nbFramesRD</span><span class="p">,</span><span class="n">nbRowsRD</span><span class="p">,</span><span class="n">nbColsRD</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;CT Shape: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">shape</span>
        <span class="n">newPixelArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span> <span class="n">patientTools</span><span class="o">.</span><span class="n">fillPatientCT</span><span class="p">(</span><span class="n">pixelArray3D</span><span class="p">,</span><span class="n">shape</span><span class="p">,</span><span class="n">indStart</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">indPadding</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pixelArray</span> <span class="o">=</span> <span class="n">newPixelArray</span>
        <span class="k">else</span><span class="p">:</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">_pixelArray</span><span class="p">[</span><span class="n">startFrame</span><span class="p">:</span><span class="n">startFrame</span> <span class="o">+</span> <span class="n">nbFramesRD</span><span class="p">,</span> \
                            <span class="n">startRow</span><span class="p">:</span><span class="n">startRow</span> <span class="o">+</span> <span class="n">nbRowsRD</span><span class="p">,</span>\
                            <span class="n">startCol</span><span class="p">:</span><span class="n">startCol</span> <span class="o">+</span> <span class="n">nbColsRD</span><span class="p">]</span><span class="o">=</span> <span class="n">newPixelArray</span><span class="p">[:,:,:]</span>
         
     
        <span class="c">### End -fill pixel array CT ############################################################################################</span>
        
        
        <span class="c">### Fill Dose Grid ############################################################################################</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RDFileLoaded</span><span class="p">:</span>
            <span class="n">spacingRD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">spacingInfoRD</span><span class="p">[</span><span class="s">&#39;frames&#39;</span><span class="p">],</span><span class="n">spacingInfoRD</span><span class="p">[</span><span class="s">&#39;rows&#39;</span><span class="p">],</span><span class="n">spacingInfoRD</span><span class="p">[</span><span class="s">&#39;cols&#39;</span><span class="p">]],</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span> 
            <span class="n">spacingCT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">spacingInfoCT</span><span class="p">[</span><span class="s">&#39;frames&#39;</span><span class="p">],</span><span class="n">spacingInfoCT</span><span class="p">[</span><span class="s">&#39;rows&#39;</span><span class="p">],</span><span class="n">spacingInfoCT</span><span class="p">[</span><span class="s">&#39;cols&#39;</span><span class="p">]],</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>
            <span class="n">dimNewGrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">nbFramesRD</span><span class="p">,</span><span class="n">nbRowsRD</span><span class="p">,</span><span class="n">nbColsRD</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>
            <span class="n">doseArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">patientTools</span><span class="o">.</span><span class="n">fillPatientDose</span><span class="p">(</span><span class="n">dimNewGrid</span><span class="p">,</span><span class="n">pixelArrayRD</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imagePosition</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">endImagePosition</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">imageOrientationCT</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">),</span><span class="n">spacingCT</span><span class="p">,</span><span class="n">spacingRD</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">imagePositionRD</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">doseArray</span>  <span class="o">=</span> <span class="n">pixelArrayRD</span>
        
        <span class="k">if</span> <span class="n">indPadding</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prescribDoseArray</span> <span class="o">=</span> <span class="n">doseArray</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prescribDoseArray</span><span class="p">[</span><span class="n">startFrame</span><span class="p">:</span><span class="n">startFrame</span> <span class="o">+</span> <span class="n">nbFramesRD</span><span class="p">,</span> \
                            <span class="n">startRow</span><span class="p">:</span><span class="n">startRow</span> <span class="o">+</span> <span class="n">nbRowsRD</span><span class="p">,</span>\
                            <span class="n">startCol</span><span class="p">:</span><span class="n">startCol</span> <span class="o">+</span> <span class="n">nbColsRD</span><span class="p">]</span> <span class="o">=</span> <span class="n">doseArray</span><span class="p">[:,:,:]</span>
        
        <span class="c">### End fill dose grid ############################################################################################</span>
        
        
        <span class="c">### Fill density grid ############################################################################################</span>
        <span class="n">tableConversion</span> <span class="o">=</span> <span class="n">ctToDensConv</span><span class="o">.</span><span class="n">getConversionTableCTToMassDens</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_densityArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">patientTools</span><span class="o">.</span><span class="n">fillPatientDensity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pixelArray</span><span class="p">,</span><span class="n">tableConversion</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">skipSaveDensityImage</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">listSaveDensImAlong</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;density_along</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">axis</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                <span class="n">viewer2D</span><span class="o">.</span><span class="n">storeMatrixAsImage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pathToOutput</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_densityArray</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">alongAxis</span> <span class="o">=</span> <span class="n">axis</span> <span class="p">,</span><span class="n">cpkl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">saveDensCPKL</span><span class="p">)</span>
        <span class="c">### End fill density grid ############################################################################################</span>
              
        
        <span class="c">### Create masks VOIs ############################################################################################</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_maskVOIs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dcmRSReader</span><span class="o">.</span><span class="n">getMasksForAssociatedDicomImage</span><span class="p">(</span><span class="n">imagePositionCT</span><span class="p">,</span> <span class="n">imageOrientationCT</span><span class="p">,</span> <span class="n">spacingInfoCT</span><span class="p">,</span> <span class="n">pixelArray3D</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">voi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maskVOIs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">voi</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;CLOSED_PLANAR&quot;</span><span class="p">:</span>
                <span class="n">indStart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">indCTStart</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">,</span> <span class="n">indCTStart</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">,</span> <span class="n">indCTStart</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>
                
                <span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">nbFramesRD</span><span class="p">,</span><span class="n">nbRowsRD</span><span class="p">,</span><span class="n">nbColsRD</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>
                <span class="n">reshapedMask</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span> <span class="n">patientTools</span><span class="o">.</span><span class="n">fillPatientCT</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">voi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s">&quot;C&quot;</span><span class="p">),</span><span class="n">shape</span><span class="p">,</span><span class="n">indStart</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="s">&#39;int8&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">indPadding</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">voi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">reshapedMask</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tmpMask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_nFrames</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nRows</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nCols</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="s">&#39;int8&#39;</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span>
                    <span class="n">tmpMask</span><span class="p">[</span><span class="n">startFrame</span><span class="p">:</span><span class="n">startFrame</span> <span class="o">+</span> <span class="n">nbFramesRD</span><span class="p">,</span> \
                            <span class="n">startRow</span><span class="p">:</span><span class="n">startRow</span> <span class="o">+</span> <span class="n">nbRowsRD</span><span class="p">,</span>\
                            <span class="n">startCol</span><span class="p">:</span><span class="n">startCol</span> <span class="o">+</span> <span class="n">nbColsRD</span><span class="p">]</span> <span class="o">=</span> <span class="n">reshapedMask</span><span class="p">[:,:,:]</span>
                    <span class="n">voi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmpMask</span>

        <span class="c">#Store all the VOIs as png images</span>
        <span class="k">for</span> <span class="n">voi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maskVOIs</span><span class="p">:</span> 
            <span class="k">if</span> <span class="n">voi</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;CLOSED_PLANAR&quot;</span><span class="p">:</span>
                <span class="n">nameROI</span> <span class="o">=</span> <span class="p">((</span><span class="n">voi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;(&#39;</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;)&#39;</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">)</span>
                <span class="n">obsROI</span> <span class="o">=</span> <span class="p">((</span><span class="n">voi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;(&#39;</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;)&#39;</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">)</span>
                <span class="n">nameFile</span> <span class="o">=</span> <span class="s">&quot;ROI_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">nameROI</span><span class="p">,</span><span class="n">obsROI</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">voi</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
                <span class="n">viewer2D</span><span class="o">.</span><span class="n">storeMatrixAsImage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pathToOutput</span><span class="p">,</span><span class="n">voi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">nameFile</span><span class="p">,</span> <span class="n">alongAxis</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">cpkl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">storeMasksAsCPKL</span><span class="p">)</span>
                <span class="n">nbVoxelsVOI</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">voi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">print</span> <span class="s">&quot;ROI </span><span class="si">%s</span><span class="s"> : </span><span class="si">%i</span><span class="s"> voxels -&gt; </span><span class="si">%0.3e</span><span class="s"> cm^3.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">nameFile</span><span class="p">,</span><span class="n">nbVoxelsVOI</span><span class="p">,</span><span class="n">nbVoxelsVOI</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_spacingInfo</span><span class="p">[</span><span class="s">&#39;frames&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spacingInfo</span><span class="p">[</span><span class="s">&#39;cols&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spacingInfo</span><span class="p">[</span><span class="s">&#39;rows&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1000.</span><span class="p">)</span>
                <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t\t</span><span class="s">---&quot;</span>
                <span class="k">if</span> <span class="n">voi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;EXTERNAL&#39;</span><span class="p">:</span>
                    <span class="n">voiExternal</span> <span class="o">=</span> <span class="n">voi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                
            <span class="k">elif</span> <span class="n">voi</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;POINT&quot;</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;ROI point: </span><span class="si">%s</span><span class="s"> &quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">voi</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;Unknown voi type: </span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">voi</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;ROI error : unkown type&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fillIndicesVOIPatient</span><span class="p">()</span>
        <span class="c">####End - CReate masks VOIs ############################################################################################</span>
     
        <span class="k">print</span> <span class="s">&quot;############ Patient initialiezd !! ###################&quot;</span>

    
    
    
    
    </div>
<div class="viewcode-block" id="Patient.computeStoppingPowerArray"><a class="viewcode-back" href="../../../mspt.patient.html#mspt.patient.patient.Patient.computeStoppingPowerArray">[docs]</a>    <span class="k">def</span> <span class="nf">computeStoppingPowerArray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">energy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Function that computes and fill the relative stopping power 3D array.</span>
<span class="sd">        </span>
<span class="sd">        :param energy: Energy of the beam being used.</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">convTable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stopPwrDataRef</span><span class="o">.</span><span class="n">getConversionTableStpPwrForEnergy</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>
<span class="c">#         tStpPwr0 = time.clock()</span>
        <span class="n">correcFactorTable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stopPwrDataRef</span><span class="o">.</span><span class="n">getStopPwrCorrecFactor</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stpPwrArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">patientTools</span><span class="o">.</span><span class="n">fillPatientStopPwr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_densityArray</span><span class="p">,</span><span class="n">convTable</span><span class="p">,</span><span class="n">correcFactorTable</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>
<span class="c">#         tStpPwr1 = time.clock()</span>
<span class="c">#         print &quot;Time Conversion to Stop Pwr Ratio (energy:%f): %s sec&quot;%(energy,str( tStpPwr1 - tStpPwr0 ))    </span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">skipSaveStpPwrImage</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">listSaveStPwrImAlong</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;StoppingPwr_E</span><span class="si">%0.3f</span><span class="s">MeV_along</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">energy</span><span class="p">,</span><span class="n">axis</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                <span class="n">viewer2D</span><span class="o">.</span><span class="n">storeMatrixAsImage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pathToOutput</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_stpPwrArray</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">alongAxis</span> <span class="o">=</span> <span class="n">axis</span> <span class="p">,</span><span class="n">cpkl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">saveStpPwrCPKL</span><span class="p">)</span>

                    
        </div>
<div class="viewcode-block" id="Patient.setIsocenter"><a class="viewcode-back" href="../../../mspt.patient.html#mspt.patient.patient.Patient.setIsocenter">[docs]</a>    <span class="k">def</span> <span class="nf">setIsocenter</span><span class="p">(</span><span class="bp">self</span> <span class="p">,</span> <span class="n">isoCoord</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Function used from scanning.deliverySimulation_Static_Dynamic to set the treatment plan isocenter coordinates.</span>
<span class="sd">        </span>
<span class="sd">        :param isoCoord: treatment plan isocenter coordinates (x,y,z)</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Isocenter</span> <span class="o">=</span> <span class="n">isoCoord</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_IsoInd</span> <span class="o">=</span> <span class="bp">None</span>
    </div>
<div class="viewcode-block" id="Patient.getIsocenterInd"><a class="viewcode-back" href="../../../mspt.patient.html#mspt.patient.patient.Patient.getIsocenterInd">[docs]</a>    <span class="k">def</span> <span class="nf">getIsocenterInd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Function that computes and return the indices of the voxel representing the isocenter of the treatment plan.</span>
<span class="sd">        </span>
<span class="sd">        :returns: Indices of the isocenter voxel : [frame, row, columns]</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_IsoInd</span> <span class="ow">is</span> <span class="bp">None</span> <span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Isocenter</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s">&quot;Treatment plan isocenter has not been set! Cannot convert to indices&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_IsoInd</span><span class="o">=</span> <span class="n">dcmTools</span><span class="o">.</span><span class="n">coordinatesToIndexFromImagePosition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Isocenter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imagePosition</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_imageOrientation</span> <span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spacingInfo</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_IsoInd</span>
</div>
<div class="viewcode-block" id="Patient.shape"><a class="viewcode-back" href="../../../mspt.patient.html#mspt.patient.patient.Patient.shape">[docs]</a>    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        </span>
<span class="sd">        :returns: The patient 3D matrices shape: (number of frames,rows,cols )</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pixelArray</span><span class="o">.</span><span class="n">shape</span>
</div>
<div class="viewcode-block" id="Patient.getSpacingInfo"><a class="viewcode-back" href="../../../mspt.patient.html#mspt.patient.patient.Patient.getSpacingInfo">[docs]</a>    <span class="k">def</span> <span class="nf">getSpacingInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Function to obtain the spacing information used in the patient arrays.</span>
<span class="sd">        </span>
<span class="sd">        :param key: If None (default), it returns the dictionary with the spacings in mm between the frames (&#39;frames&#39;), rows (&#39;rows&#39;) and columns (&#39;cols&#39;).\</span>
<span class="sd">        if key is not None, it should be &#39;cols&#39; or &#39;x_spacing&#39;, &#39;rows&#39; or &#39;y_spacing&#39;, &#39;frames&#39; or &#39;z_spacing&#39;.</span>
<span class="sd">        </span>
<span class="sd">        :returns:  the spacing information corresponding to key. </span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;x_spacing&#39;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;cols&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spacingInfo</span><span class="p">[</span><span class="s">&#39;cols&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;y_spacing&#39;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;rows&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spacingInfo</span><span class="p">[</span><span class="s">&#39;rows&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;z_spacing&#39;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;frames&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spacingInfo</span><span class="p">[</span><span class="s">&#39;frames&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spacingInfo</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Error - getSpacingInfo - no key: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">+</span> <span class="s">&quot;found.&quot;</span>
            <span class="k">return</span> <span class="bp">None</span>
    

</div>
<div class="viewcode-block" id="Patient.getUnpaddedPatientDataForAttr"><a class="viewcode-back" href="../../../mspt.patient.html#mspt.patient.patient.Patient.getUnpaddedPatientDataForAttr">[docs]</a>    <span class="k">def</span> <span class="nf">getUnpaddedPatientDataForAttr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">attr</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the unpadded 3D numpy array of the patient for an attribute. </span>
<span class="sd">        </span>
<span class="sd">        :param attr: Attribute for a patient array. See getPatientArrayForAttr(attr) for more information on the attributes.</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        :returns: The unpadded patient array.</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">dataPatient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPatientArrayForAttr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">staticDelivery</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">staticDelivery</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">ctPadding</span><span class="p">)</span> <span class="p">:</span>
            <span class="k">return</span> <span class="n">dataPatient</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">padValueFRC</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">padValueFRC</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">cols</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">padValueFRC</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s">&#39;maskVOIs&#39;</span><span class="p">:</span>
                <span class="n">unpaddedVOIs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">voi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maskVOIs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">voi</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;CLOSED_PLANAR&quot;</span><span class="p">:</span>
                        <span class="n">shape</span> <span class="o">=</span>  <span class="n">voi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
                        <span class="n">newMask</span> <span class="o">=</span><span class="n">voi</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">frames</span><span class="p">:</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">frames</span><span class="p">,</span><span class="n">rows</span><span class="p">:</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">rows</span><span class="p">,</span><span class="n">cols</span><span class="p">:</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">cols</span><span class="p">]</span>
                        <span class="n">unpaddedVOIs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">newMask</span> <span class="p">,</span> <span class="n">voi</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">voi</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">voi</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">voi</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="p">)</span> 
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">unpaddedVOIs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">voi</span> <span class="p">)</span> 
                <span class="k">return</span> <span class="n">unpaddedVOIs</span>
            <span class="k">else</span><span class="p">:</span>     
                <span class="n">shape</span> <span class="o">=</span> <span class="n">dataPatient</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">return</span> <span class="n">dataPatient</span><span class="p">[</span><span class="n">frames</span><span class="p">:</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">frames</span><span class="p">,</span><span class="n">rows</span><span class="p">:</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">rows</span><span class="p">,</span><span class="n">cols</span><span class="p">:</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">cols</span><span class="p">]</span>
    
        
</div>
<div class="viewcode-block" id="Patient.getPatientArrayForAttr"><a class="viewcode-back" href="../../../mspt.patient.html#mspt.patient.patient.Patient.getPatientArrayForAttr">[docs]</a>    <span class="k">def</span> <span class="nf">getPatientArrayForAttr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the 3D numpy array of the static patient for an attribute. </span>
<span class="sd">        </span>
<span class="sd">        :param attr: Attribute for a patient array. Attributes are:</span>
<span class="sd">            </span>
<span class="sd">            * *&#39;x&#39;*: 3D numpy array storing the x values of each voxel in the dicom coordinate system.</span>
<span class="sd">            * *&#39;y&#39;*: 3D numpy array storing the y values of each voxel in the dicom coordinate system.</span>
<span class="sd">            * *&#39;z&#39;*: 3D numpy array storing the z values of each voxel in the dicom coordinate system.</span>
<span class="sd">            * *&#39;density&#39;* : 3D numpy array storing the density of each voxel.</span>
<span class="sd">            * *&#39;stpPwrRatio&#39;* : 3D numpy array storing the relative stopping power of each voxel.</span>
<span class="sd">            * *&#39;prescribedDose&#39;* : 3D numpy array storing the expected dose distribution obtained from the RD dicom file. \</span>
<span class="sd">            If the used did not provide a RD dicom file, it returns None.</span>
<span class="sd">            * *&#39;receivedDose&#39;* : 3D numpy array storing the computed dose distribution.</span>
<span class="sd">            * *&#39;pixelValues&#39;* : 3D numpy array storing the CT number at each voxel.</span>
<span class="sd">            * *&#39;MaskTumor&#39;* : 3D binary array: 1 in the tumor, 0 outside.</span>
<span class="sd">            * *&#39;maskVOIs&#39;* :  A list of tuple in which are stored the VOIs information as: ( mask 3D Numpy array , ROI name, ROI observation, ROI index, ROI type)  - Type = &#39;CLOSED_PLANAR&#39; or &#39;POINT&#39;</span>
<span class="sd">        </span>
<span class="sd">        :returns: The patient array.</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="n">array</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s">&#39;x&#39;</span><span class="p">:</span>
            <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_XArray</span>
        <span class="k">elif</span> <span class="n">attr</span> <span class="o">==</span> <span class="s">&#39;y&#39;</span><span class="p">:</span>
            <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_YArray</span>
        <span class="k">elif</span> <span class="n">attr</span> <span class="o">==</span> <span class="s">&#39;z&#39;</span><span class="p">:</span>
            <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ZArray</span>
        <span class="k">elif</span> <span class="n">attr</span> <span class="o">==</span> <span class="s">&#39;density&#39;</span><span class="p">:</span>
            <span class="n">array</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_densityArray</span>
        <span class="k">elif</span> <span class="n">attr</span> <span class="o">==</span> <span class="s">&#39;stpPwrRatio&#39;</span><span class="p">:</span>
            <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stpPwrArray</span>
        <span class="k">elif</span> <span class="n">attr</span> <span class="o">==</span> <span class="s">&#39;prescribedDose&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RDFileLoaded</span><span class="p">:</span>
                <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prescribDoseArray</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">array</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="n">attr</span> <span class="o">==</span> <span class="s">&#39;receivedDose&#39;</span><span class="p">:</span>
            <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_receivedDoseArray</span>
        <span class="k">elif</span> <span class="n">attr</span> <span class="o">==</span> <span class="s">&#39;pixelValues&#39;</span><span class="p">:</span>
            <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pixelArray</span>
        <span class="k">elif</span> <span class="n">attr</span> <span class="o">==</span> <span class="s">&#39;MaskTumor&#39;</span><span class="p">:</span>
            <span class="n">array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maskTumor</span>
        <span class="k">elif</span> <span class="n">attr</span> <span class="o">==</span> <span class="s">&#39;maskVOIs&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maskVOIs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">strErr</span> <span class="o">=</span> <span class="s">&quot;Unknown attr: </span><span class="si">%s</span><span class="s">, in patient.getPatientArrayForAttr()&quot;</span><span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">strErr</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">array</span>

        </div>
<div class="viewcode-block" id="Patient.getPatientDataForDisplVector"><a class="viewcode-back" href="../../../mspt.patient.html#mspt.patient.patient.Patient.getPatientDataForDisplVector">[docs]</a>    <span class="k">def</span> <span class="nf">getPatientDataForDisplVector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">attr</span> <span class="p">,</span> <span class="n">dispVec</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)):</span>
        <span class="sd">&#39;&#39;&#39;Get the 3D numpy array of the moving patient for an attribute and a given displacement vector. </span>
<span class="sd">        </span>
<span class="sd">        :param attr: Attribute for a patient array. Attributes are:</span>
<span class="sd">        </span>
<span class="sd">            * *&#39;x&#39;*: 3D numpy array storing the x values of each voxel in the dicom coordinate system. This array is the same if the patient is moving or not.</span>
<span class="sd">            * *&#39;y&#39;*: 3D numpy array storing the y values of each voxel in the dicom coordinate system. This array is the same if the patient is moving or not.</span>
<span class="sd">            * *&#39;z&#39;*: 3D numpy array storing the z values of each voxel in the dicom coordinate system. This array is the same if the patient is moving or not.</span>
<span class="sd">            * *&#39;density&#39;* : 3D numpy array storing the density of each voxel.</span>
<span class="sd">            * *&#39;stpPwrRatio&#39;* : 3D numpy array storing the relative stopping power of each voxel.</span>
<span class="sd">            * *&#39;pixelValues&#39;* : 3D numpy array storing the CT number at each voxel.</span>
<span class="sd">            * *&#39;maskVOIs&#39;* :  A list of tuple in which are stored the VOIs information as: ( mask 3D Numpy array , ROI name, ROI observation, ROI index, ROI type)  - Type = &#39;CLOSED_PLANAR&#39; or &#39;POINT&#39;</span>

<span class="sd">        </span>
<span class="sd">        :param dispVec: Displacement vector in the IEC Fixed coordinate system in cm,  i.e., x_IEC_f = x_Dicom ,y_IEC_f = z_Dicom,z_IEC_f = -y_Dicom </span>
<span class="sd">        </span>
<span class="sd">        :returns: The patient array.</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
            
        <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s">&#39;x&#39;</span> <span class="ow">or</span> <span class="n">attr</span> <span class="o">==</span> <span class="s">&#39;y&#39;</span> <span class="ow">or</span> <span class="n">attr</span> <span class="o">==</span> <span class="s">&#39;z&#39;</span> <span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPatientArrayForAttr</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        
        <span class="n">extentStatic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPatientExtentInStaticModel</span><span class="p">()</span>
        <span class="n">extentDynamic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPatientExtentInDynamicModel</span><span class="p">(</span><span class="n">dispVec</span><span class="p">)</span>
        
                  
        <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s">&quot;density&quot;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_densityArray</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tmpDensityArray</span><span class="p">[:,:,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_densityArray</span><span class="p">[:,:,:]</span> 
            <span class="n">newData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmpDensityArray</span>
            <span class="n">valueReplacement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_densityArray</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">attr</span> <span class="o">==</span> <span class="s">&quot;pixelValues&quot;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pixelArray</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tmpPixelArray</span><span class="p">[:,:,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pixelArray</span><span class="p">[:,:,:]</span>
            <span class="n">newData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmpPixelArray</span>
            <span class="n">valueReplacement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pixelArray</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">attr</span> <span class="o">==</span> <span class="s">&quot;stpPwrRatio&quot;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stpPwrArray</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tmpStpPwrArray</span> <span class="p">[:,:,:]</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stpPwrArray</span><span class="p">[:,:,:]</span>
            <span class="n">newData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmpStpPwrArray</span>
            <span class="n">valueReplacement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stpPwrArray</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span>  <span class="n">attr</span> <span class="o">==</span> <span class="s">&quot;maskVOIs&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_tmpMaskVOIs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">voi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maskVOIs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_tmpMaskVOIs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">voi</span><span class="p">[:])</span>
                <span class="n">newVOI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmpMaskVOIs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">newVOI</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;CLOSED_PLANAR&quot;</span><span class="p">:</span>
                    <span class="n">tmpMask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_nFrames</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nRows</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nCols</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span>
                    <span class="n">tmpMask</span><span class="p">[</span><span class="n">extentDynamic</span><span class="p">]</span> <span class="o">=</span> <span class="n">newVOI</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">extentStatic</span><span class="p">]</span>
                    <span class="n">newVOI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span> <span class="n">tmpMask</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tmpMaskVOIs</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">strErr</span> <span class="o">=</span> <span class="s">&quot;Unknown attr: </span><span class="si">%s</span><span class="s">, in patient.getPatientDataForDisplVector()&quot;</span><span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">strErr</span><span class="p">)</span>            
            
        <span class="c">#Save original values in bounding box</span>
        <span class="n">tmpData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">extentStatic</span><span class="p">]</span>
        
        <span class="c">#Fill new values in static bounding box</span>
        <span class="n">newData</span><span class="p">[</span><span class="n">extentStatic</span><span class="p">]</span> <span class="o">=</span> <span class="n">valueReplacement</span>

        <span class="c">#Fill new values in dynamic bounding box (i.e. including the padding)</span>
        <span class="n">newData</span><span class="p">[</span><span class="n">extentDynamic</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmpData</span>
        
        <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s">&quot;density&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">skipSaveDensityImage</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">listSaveDensImAlong</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;density_[</span><span class="si">%.2f</span><span class="s">,</span><span class="si">%.2f</span><span class="s">,</span><span class="si">%.2f</span><span class="s">]_along</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">dispVec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dispVec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">dispVec</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">axis</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                    <span class="n">viewer2D</span><span class="o">.</span><span class="n">storeMatrixAsImage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pathToOutput</span><span class="p">,</span><span class="n">newData</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">alongAxis</span> <span class="o">=</span> <span class="n">axis</span> <span class="p">,</span><span class="n">cpkl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">saveDensCPKL</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">newData</span>

        
        
        
        </div>
<div class="viewcode-block" id="Patient.getPatientExtentInStaticModel"><a class="viewcode-back" href="../../../mspt.patient.html#mspt.patient.patient.Patient.getPatientExtentInStaticModel">[docs]</a>    <span class="k">def</span> <span class="nf">getPatientExtentInStaticModel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        :returns: the patient body indices in the 3D arrays, i.e., the voxels inside the patient body.</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indPatient</span>
        
        
        
        
        
    </div>
<div class="viewcode-block" id="Patient.getPatientExtentInDynamicModel"><a class="viewcode-back" href="../../../mspt.patient.html#mspt.patient.patient.Patient.getPatientExtentInDynamicModel">[docs]</a>    <span class="k">def</span> <span class="nf">getPatientExtentInDynamicModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dispVec</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Computes new patient indices in dynamic model, i.e. after a displacement of dispVec.</span>
<span class="sd">        </span>
<span class="sd">        :param dispVec: Displacement vector in the IEC Fixed coordinate system in cm,  i.e., x_IEC_f = x_Dicom ,y_IEC_f = z_Dicom,z_IEC_f = -y_Dicom </span>
<span class="sd">        </span>
<span class="sd">        :returns: the patient body indices in the 3D arrays, i.e., the voxels inside the moving patient body .</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">dispIndices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDispIndices</span><span class="p">(</span><span class="n">dispVec</span><span class="p">)</span>
        <span class="n">newIndices</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_indPatient</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">dispIndices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">_indPatient</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dispIndices</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">_indPatient</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">dispIndices</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
        
        <span class="k">return</span> <span class="n">newIndices</span>
        
        </div>
<div class="viewcode-block" id="Patient.getDispIndices"><a class="viewcode-back" href="../../../mspt.patient.html#mspt.patient.patient.Patient.getDispIndices">[docs]</a>    <span class="k">def</span> <span class="nf">getDispIndices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dispVec</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calculates the displacement vector converted into indices</span>
<span class="sd">        </span>
<span class="sd">        :param dispVec: Displacement vector in the IEC Fixed coordinate system in cm,  i.e., x_IEC_f = x_Dicom ,y_IEC_f = z_Dicom,z_IEC_f = -y_Dicom </span>
<span class="sd">        </span>
<span class="sd">        :returns: Indices in the dicom image (based on the dicom image coordinate system)</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">dispVec_mm</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">dispVec_mm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dispVec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">10.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imagePosition</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        
        <span class="p">(</span><span class="n">nbFrames</span><span class="p">,</span><span class="n">nbRows</span><span class="p">,</span> <span class="n">nbCols</span><span class="p">)</span> <span class="o">=</span>  <span class="n">dcmTools</span><span class="o">.</span><span class="n">coordinatesToIndexFromImagePosition</span><span class="p">(</span><span class="n">dispVec_mm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imagePosition</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imageOrientation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spacingInfo</span><span class="p">)</span>
        
        <span class="n">dispIndices</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">nbFrames</span><span class="p">)</span> <span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">nbRows</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">nbCols</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">dispIndices</span>
 
 
 
 
 </div>
<div class="viewcode-block" id="Patient.computeRadiologicalDepth"><a class="viewcode-back" href="../../../mspt.patient.html#mspt.patient.patient.Patient.computeRadiologicalDepth">[docs]</a>    <span class="k">def</span> <span class="nf">computeRadiologicalDepth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">startVec</span><span class="p">,</span> <span class="n">incVec</span><span class="p">,</span> <span class="n">sourceVec</span><span class="p">,</span> <span class="n">dispVec</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">,</span> <span class="n">ener</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Computes the radiological depth of the entire patient volume for a given displacement vector.</span>
<span class="sd">        </span>
<span class="sd">        :param startVec: Coordinates (x,y,z) in cm of the voxel (0,nb Rows - 1, 0) in the IEC fixed coordinate system.</span>
<span class="sd">        :param incVec: Positive increment vector. It corresponds to (x_spacing, y_spacing, z_spacing) in cm.</span>
<span class="sd">        :param sourceVec: (x,y,z) coordinates of the beam&#39;s source in cm in the in the IEC fixed coordinate system.</span>
<span class="sd">        :param dispVec: displacement vector in cm in the in the IEC fixed coordinate system.</span>
<span class="sd">        :param ener: Beam&#39;s energy. Used if the user wants to store the radiological depth every time it is updated.</span>
<span class="sd">        </span>
<span class="sd">        :returns: 3D numpy array filled with the radiological depth values</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">t_start_Deff</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">staticDelivery</span><span class="p">:</span>
            <span class="n">stopPwr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPatientArrayForAttr</span><span class="p">(</span><span class="s">&quot;stpPwrRatio&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stopPwr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPatientDataForDisplVector</span><span class="p">(</span><span class="s">&quot;stpPwrRatio&quot;</span> <span class="p">,</span> <span class="n">dispVec</span> <span class="o">=</span> <span class="n">dispVec</span><span class="p">)</span>
        <span class="n">reshapedStpPwrGrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">stopPwr</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span> 
        <span class="c">#Note: &quot;Transpose (1,0,2)&quot; changes the slices: slices are not along z dicom axis anymore, but along y dicom axis. &quot;flipud&quot; change the order of the slice (flip upside-down): the 1st becomes last,the last becomes first, the second slice becomes the penultimate and so on... These changes are made such that We can add incVec(positive spacing) to startVec (top left voxel of the first slice) in the IEC FIXED coordinate system to move alonge x,y,z coordinates in the volume until the last voxel(bottom right of the last slice)   </span>
        <span class="n">tmpDeff</span><span class="o">=</span> <span class="n">patientTools</span><span class="o">.</span><span class="n">calcRadiolDepth</span><span class="p">(</span><span class="n">reshapedStpPwrGrid</span><span class="p">,</span> <span class="n">startVec</span><span class="p">,</span> <span class="n">incVec</span><span class="p">,</span> <span class="n">sourceVec</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>
        <span class="n">radioDepth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">tmpDeff</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span><span class="c"># Undo the initial transformation.</span>
        <span class="n">t_end_Deff</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&quot;Radiological depth computed in </span><span class="si">%f</span><span class="s"> sec&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">t_end_Deff</span> <span class="o">-</span> <span class="n">t_start_Deff</span><span class="p">)</span>
        
        <span class="c">#If the user wants to save the radiological depth as an image</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">skipSaveDeff</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">listSaveDeffAlong</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;RadiolDepth_[</span><span class="si">%.2f</span><span class="s">,</span><span class="si">%.2f</span><span class="s">,</span><span class="si">%.2f</span><span class="s">]_along</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">dispVec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dispVec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">dispVec</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">axis</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">ener</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&quot;_</span><span class="si">%i</span><span class="s">MeV&quot;</span><span class="o">%</span><span class="n">ener</span>
                <span class="n">viewer2D</span><span class="o">.</span><span class="n">storeMatrixAsImage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pathToOutput</span><span class="p">,</span><span class="n">radioDepth</span><span class="p">,</span><span class="n">name</span><span class="p">,</span> <span class="n">alongAxis</span> <span class="o">=</span> <span class="n">axis</span><span class="p">,</span> <span class="n">cpkl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">saveDeffCPKL</span><span class="p">,</span><span class="n">bw</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">radioDepth</span>
 
</div>
<div class="viewcode-block" id="Patient.computeLocalizedRadiologicalDepth"><a class="viewcode-back" href="../../../mspt.patient.html#mspt.patient.patient.Patient.computeLocalizedRadiologicalDepth">[docs]</a>    <span class="k">def</span> <span class="nf">computeLocalizedRadiologicalDepth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">startVec</span><span class="p">,</span> <span class="n">incVec</span><span class="p">,</span> <span class="n">sourceVec</span><span class="p">,</span> <span class="n">sourceIECG</span><span class="p">,</span><span class="n">rotMatrix</span><span class="p">,</span><span class="n">Xr</span><span class="p">,</span><span class="n">Yr</span><span class="p">,</span><span class="n">Zr</span><span class="p">,</span><span class="n">xrshift</span><span class="p">,</span><span class="n">yrshift</span><span class="p">,</span> <span class="n">nbPositionsX</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nbPositionsY</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dispVec</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">ener</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Computes the radiological depth only for few rays. All the voxels encountered by the rays will have a value other than -1. The rest of the array will\</span>
<span class="sd">        be equal to -1.</span>
<span class="sd">        </span>
<span class="sd">        :param startVec: Coordinates (x,y,z) in cm of the voxel (0,nb Rows - 1, 0) in the IEC fixed coordinate system.</span>
<span class="sd">        :param incVec: Positive increment vector. It corresponds to (x_spacing, y_spacing, z_spacing) in cm.</span>
<span class="sd">        :param sourceVec: (x,y,z) coordinates of the beam&#39;s source in cm in the in the IEC fixed coordinate system.</span>
<span class="sd">        :param sourceIECG: (x,y,z) coordinates of the beam&#39;s source in cm in the in the IEC gantry coordinate system.</span>
<span class="sd">        :param rotMatrix: Rotation matrix corresponding to  -(gantry angle). It allows to go from the IEC gantry \</span>
<span class="sd">        coordinate system to the IEC Fixed coordinate system.</span>
<span class="sd">        :param Xr: 3D array of x coordinates in the IEC gantry coordinate system</span>
<span class="sd">        :param Yr: 3D array of y coordinates in the IEC gantry coordinate system</span>
<span class="sd">        :param Zr: 3D array of z coordinates in the IEC gantry coordinate system</span>
<span class="sd">        :param xrshift: beam shift along the x axis of the gantry coordinate system. </span>
<span class="sd">        :param yrshift: beam shift along the y axis of the gantry coordinate system. Note: (xrshift,yrshift) corresponds to the central ray. </span>
<span class="sd">        :param nbPositionsX: Number of positions (i.e. number of rays) along the X axis to the right and to the left of the central ray.</span>
<span class="sd">        :param nbPositionsY: Number of positions (i.e. number of rays) along the Y axis to the right and to the left of the central ray.</span>
<span class="sd">        :param dispVec: displacement vector in cm in the in the IEC fixed coordinate system.</span>
<span class="sd">        :param ener: Beam&#39;s energy. Used if the user wants to store the radiological depth every time it is updated.</span>
<span class="sd">         </span>
<span class="sd">        </span>
<span class="sd">        The rays simulated are all the possible combinations of nbPositionsX and nbPositionsY in addition to the central ray. For example, if \</span>
<span class="sd">        nbPositionsX = nbPositionsY = 2. All the rays are [xrshift,yrshift], [xrshift + 1 * spacing,yrshift] , \</span>
<span class="sd">        [xrshift + 1 * spacing, yrshift + 1 * spacing] ,  [xrshift + 1 * spacing, yrshift - 1 * spacing] , \</span>
<span class="sd">        [xrshift , yrshift + 1 * spacing] , [xrshift - 1 * spacing, yrshift + 1 * spacing], [xrshift - 1 * spacing, yrshift - 1 * spacing], \</span>
<span class="sd">        [xrshift - 1 * spacing,yrshift] , [xrshift , yrshift - 1 * spacing].....</span>
<span class="sd">        </span>
<span class="sd">        Spacing = sqrt( incVec[0]^2 + incVec[1]^2)</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        :returns: A tuple:</span>
<span class="sd">            </span>
<span class="sd">            #. The radiological depth array computed for the rays.</span>
<span class="sd">            #. The distance between the source and the patient surface along the central ray</span>
<span class="sd">            #. The list of voxels indices encountered in the CT volume along the central ray. The voxels are sorted in increasing distance from the source.</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">t_start_beamletRadiolDepth</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>

        <span class="n">minSpacing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">incVec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">incVec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">incVec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">incVec</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="c">#Note we take only these 2 spacings because the gantry rotates around the 3rd coordinate.</span>
        
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">staticDelivery</span><span class="p">:</span>
            <span class="n">stopPwr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPatientArrayForAttr</span><span class="p">(</span><span class="s">&quot;stpPwrRatio&quot;</span><span class="p">)</span>
            <span class="n">density</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPatientArrayForAttr</span><span class="p">(</span><span class="s">&quot;density&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stopPwr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPatientDataForDisplVector</span><span class="p">(</span><span class="s">&quot;stpPwrRatio&quot;</span> <span class="p">,</span> <span class="n">dispVec</span> <span class="o">=</span> <span class="n">dispVec</span><span class="p">)</span>
            <span class="n">density</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPatientDataForDisplVector</span><span class="p">(</span><span class="s">&quot;density&quot;</span> <span class="p">,</span> <span class="n">dispVec</span> <span class="o">=</span> <span class="n">dispVec</span><span class="p">)</span>
                
        <span class="n">dynaPatientLoc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPatientExtentInDynamicModel</span><span class="p">(</span><span class="n">dispVec</span><span class="p">)</span>
        <span class="n">patientMask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">stopPwr</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s">&#39;int8&#39;</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span>
        <span class="n">patientMask</span><span class="p">[</span><span class="n">dynaPatientLoc</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        
        
        <span class="n">auxTargets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">xPos</span><span class="p">,</span><span class="n">yPos</span><span class="p">)</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">nbPositionsX</span><span class="p">,</span><span class="n">nbPositionsX</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">nbPositionsY</span><span class="p">,</span><span class="n">nbPositionsY</span><span class="o">+</span><span class="mi">1</span><span class="p">)):</span> 

            <span class="k">if</span> <span class="n">xPos</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">yPos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">targetIECG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xrshift</span><span class="p">,</span><span class="n">yrshift</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span><span class="c"># target point in isocenter frame</span>
                <span class="n">targetIECF</span> <span class="o">=</span>  <span class="n">mathTools</span><span class="o">.</span><span class="n">rotateCoordinates</span><span class="p">(</span><span class="n">rotMatrix</span><span class="p">,</span><span class="n">targetIECG</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>      
                <span class="n">ssd0</span><span class="p">,</span> <span class="n">listIndices</span><span class="p">,</span><span class="n">listLenVoxels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculateSSD0</span><span class="p">(</span><span class="n">sourceVec</span><span class="p">,</span><span class="n">targetIECF</span><span class="p">,</span><span class="n">Xr</span><span class="p">,</span><span class="n">Yr</span><span class="p">,</span><span class="n">Zr</span><span class="p">,</span><span class="n">density</span><span class="p">,</span><span class="n">startVec</span><span class="p">,</span><span class="n">incVec</span><span class="p">,</span><span class="n">sourceIECG</span><span class="p">,</span><span class="n">patientMask</span><span class="p">)</span>
                <span class="k">print</span> <span class="s">&quot;SSD0: </span><span class="si">%f</span><span class="s"> cm&quot;</span><span class="o">%</span><span class="n">ssd0</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">pointIECG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xrshift</span> <span class="o">+</span>  <span class="n">minSpacing</span> <span class="o">*</span> <span class="n">xPos</span><span class="p">,</span> \
                        <span class="n">yrshift</span> <span class="o">+</span>  <span class="n">minSpacing</span> <span class="o">*</span> <span class="n">yPos</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">)</span><span class="c"># target point in isocenter frame                    </span>
                <span class="n">pointIECF</span> <span class="o">=</span> <span class="n">mathTools</span><span class="o">.</span><span class="n">rotateCoordinates</span><span class="p">(</span><span class="n">rotMatrix</span><span class="p">,</span><span class="n">pointIECG</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>
    
                <span class="n">auxTargets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pointIECF</span><span class="p">)</span>
        
        <span class="n">reshapedStpPwrGrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">stopPwr</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span> 
        <span class="n">tmpDeff</span> <span class="o">=</span> <span class="n">patientTools</span><span class="o">.</span><span class="n">calcRadiolDepthFewRays</span><span class="p">(</span><span class="n">reshapedStpPwrGrid</span><span class="p">,</span><span class="n">startVec</span><span class="p">,</span><span class="n">incVec</span><span class="p">,</span><span class="n">sourceVec</span><span class="p">,</span> \
                                     <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">targetIECF</span><span class="p">,</span><span class="n">dtype</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="s">&#39;C&#39;</span><span class="p">),</span>\
                                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">auxTargets</span><span class="p">,</span><span class="n">dtype</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="s">&#39;C&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span> <span class="p">)</span>
        <span class="n">radioDepth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">tmpDeff</span><span class="p">),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span><span class="c"># Undo the initial transformation.</span>
                                
        <span class="n">t_end_beamletRadiolDepth</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>     
        <span class="k">print</span> <span class="s">&quot;Time to compute  localized radiol depth : </span><span class="si">%f</span><span class="s"> sec&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">t_end_beamletRadiolDepth</span> <span class="o">-</span> <span class="n">t_start_beamletRadiolDepth</span><span class="p">)</span>  
               
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">skipSaveDeff</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">listSaveDeffAlong</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;RadiolDepth_[</span><span class="si">%.2f</span><span class="s">,</span><span class="si">%.2f</span><span class="s">,</span><span class="si">%.2f</span><span class="s">]_along</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">dispVec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dispVec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">dispVec</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">axis</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">ener</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&quot;_</span><span class="si">%i</span><span class="s">MeV&quot;</span><span class="o">%</span><span class="n">ener</span>
                <span class="n">viewer2D</span><span class="o">.</span><span class="n">storeMatrixAsImage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pathToOutput</span><span class="p">,</span><span class="n">radioDepth</span><span class="p">,</span><span class="n">name</span><span class="p">,</span> <span class="n">alongAxis</span> <span class="o">=</span> <span class="n">axis</span><span class="p">,</span> <span class="n">cpkl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">saveDeffCPKL</span><span class="p">,</span><span class="n">bw</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
 
        <span class="k">return</span> <span class="n">radioDepth</span><span class="p">,</span><span class="n">ssd0</span><span class="p">,</span><span class="n">listIndices</span>
        

 </div>
<div class="viewcode-block" id="Patient.calculateSSD0"><a class="viewcode-back" href="../../../mspt.patient.html#mspt.patient.patient.Patient.calculateSSD0">[docs]</a>    <span class="k">def</span> <span class="nf">calculateSSD0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sourceIECF</span><span class="p">,</span><span class="n">targetIECF</span><span class="p">,</span><span class="n">Xr</span><span class="p">,</span><span class="n">Yr</span><span class="p">,</span><span class="n">Zr</span><span class="p">,</span><span class="n">dens</span><span class="p">,</span><span class="n">startVec</span><span class="p">,</span><span class="n">incVec</span><span class="p">,</span><span class="n">sourceIECG</span><span class="p">,</span> <span class="n">patientMask</span><span class="p">):</span>
    
        <span class="sd">&#39;&#39;&#39;The goal of this function is to find the indices of the voxels crossing the ray starting from source </span>
<span class="sd">        and aiming at target. To obtain the distance source-surface (SSD0), we look along the beam the first voxel</span>
<span class="sd">        with a radiological depth &gt; 0.</span>
<span class="sd">        </span>
<span class="sd">        :param sourceIECF: (x,y,z) coordinates of the beam&#39;s source in cm in the in the IEC fixed coordinate system.</span>
<span class="sd">        :param targetIECF: (x,y,z) coordinates of the beam&#39;s target in cm in the in the IEC fixed coordinate system.</span>
<span class="sd">        :param Xr: 3D array of x coordinates in the IEC gantry coordinate system</span>
<span class="sd">        :param Yr: 3D array of y coordinates in the IEC gantry coordinate system</span>
<span class="sd">        :param Zr: 3D array of z coordinates in the IEC gantry coordinate system</span>
<span class="sd">        :param dens: 3D density array. It is used to estimate where the patient body starts in case &#39;patientMask&#39; is None (i.e. no &#39;EXTERNAL&#39; structure\</span>
<span class="sd">        was present in the RS dicom file)</span>
<span class="sd">        :param startVec: Coordinates (x,y,z) in cm of the voxel (0,nb Rows - 1, 0) in the IEC fixed coordinate system.</span>
<span class="sd">        :param incVec: Positive increment vector. It corresponds to (x_spacing, y_spacing, z_spacing) in cm.</span>
<span class="sd">        :param sourceIECG: (x,y,z) coordinates of the beam&#39;s source in cm in the in the IEC gantry coordinate system.</span>
<span class="sd">        :param patientMask: 3D binary array : 1 inside the patient body , 0 outside. It can be None if no &#39;EXTERNAL&#39; structure\</span>
<span class="sd">        was present in the RS dicom file)</span>
<span class="sd">        </span>
<span class="sd">        :returns: A tuple:</span>
<span class="sd">            </span>
<span class="sd">            #. The source to the patient body surface. If no voxel was found to be considered as the patient surface, the plan isocenter is used and \</span>
<span class="sd">            the function returns the distance between the source and the isocenter.</span>
<span class="sd">            #. The list of voxels indices encountered in the CT volume along the central ray. The voxels are sorted in increasing distance from the source.</span>
<span class="sd">            #. The length of the ray inside each encountered voxel.</span>

<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c">#air_high = 0.001205 # From ICRU report - see stoppingPower.py</span>
        <span class="c">#adipose_high = 0.950</span>
        <span class="n">medDens</span> <span class="o">=</span> <span class="mf">0.01</span><span class="c">#</span>
        <span class="n">reshapedDensGrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">dens</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))),</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span> 
        
        <span class="c">#Note: &quot;Transpose (1,0,2)&quot; changes the slices: slices are not along z dicom axis anymore, but along y dicom axis. </span>
        <span class="c">#&quot;flipud&quot; change the order of the slice (flip upside-down): the 1st becomes last,the last becomes first, </span>
        <span class="c">#the second slice becomes the penultimate and so on... </span>
        <span class="c">#These changes are made such that We can add incVec(positive spacing) to startVec (top left voxel of the first slice) </span>
        <span class="c">#in the IEC FIXED coordinate system to move alonge x,y,z coordinates in the volume until the last voxel(bottom right of the last slice)   </span>
        
        <span class="n">newTargetIECF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="s">&#39;C&#39;</span><span class="p">)</span>
        <span class="n">newTargetIECF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sourceIECF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span> <span class="n">targetIECF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">sourceIECF</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mf">100.0</span>
        <span class="n">newTargetIECF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sourceIECF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span> <span class="n">targetIECF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">sourceIECF</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">100.0</span>
        <span class="n">newTargetIECF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sourceIECF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span> <span class="n">targetIECF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">sourceIECF</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="mf">100.0</span>

        
        <span class="n">indices</span> <span class="o">=</span> <span class="n">patientTools</span><span class="o">.</span><span class="n">singleRay</span><span class="p">(</span><span class="n">reshapedDensGrid</span><span class="p">,</span><span class="n">startVec</span><span class="p">,</span><span class="n">incVec</span><span class="p">,</span><span class="n">sourceIECF</span><span class="p">,</span> <span class="n">newTargetIECF</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>
        <span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">]</span>
        <span class="c">#Indices: voxel indices from the source to the target</span>
        <span class="n">listIndices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">p1</span> <span class="o">=</span>  <span class="n">sourceIECG</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,(</span><span class="n">r</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">lenVox</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span> <span class="c"># Note: due to the transformations &quot;Transpose&quot; and &quot;flipud&quot; just above on &quot;dens&quot;</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>                                   <span class="c">#the order of the indices returned by singleRay() is row,frame,column!</span>
            <span class="n">c</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>                                   <span class="c">#And due to flipud row returned must be transformed into dens.shape[1]-row</span>
            <span class="n">r</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">dens</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">r</span><span class="p">)</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="p">[</span><span class="n">Xr</span><span class="p">[</span><span class="n">f</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">],</span><span class="n">Yr</span><span class="p">[</span><span class="n">f</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">],</span><span class="n">Zr</span><span class="p">[</span><span class="n">f</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]]</span>
            <span class="n">listIndices</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">f</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">lenVox</span><span class="p">,</span><span class="n">mathTools</span><span class="o">.</span><span class="n">distEuclideanP1P2</span><span class="p">(</span> <span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">)])</span>
        <span class="n">listIndices</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">listIndices</span><span class="p">,</span><span class="n">key</span><span class="o">=</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

        <span class="n">listToReturn</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">patientMask</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,(</span><span class="n">f</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">lenVox</span><span class="p">,</span><span class="n">dist</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">listIndices</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">dens</span><span class="p">[</span><span class="n">f</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">medDens</span> <span class="p">:</span>
                    <span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">Xr</span><span class="p">[</span><span class="n">f</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">],</span><span class="n">Yr</span><span class="p">[</span><span class="n">f</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">],</span><span class="n">Zr</span><span class="p">[</span><span class="n">f</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]]</span>
                    <span class="n">ssd0</span> <span class="o">=</span> <span class="n">dist</span>
                    <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,(</span><span class="n">f</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">lenVox</span><span class="p">,</span><span class="n">dist</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">listIndices</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">patientMask</span><span class="p">[</span><span class="n">f</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">:</span>
                    <span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">Xr</span><span class="p">[</span><span class="n">f</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">],</span><span class="n">Yr</span><span class="p">[</span><span class="n">f</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">],</span><span class="n">Zr</span><span class="p">[</span><span class="n">f</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]]</span>
                    <span class="n">ssd0</span> <span class="o">=</span> <span class="n">dist</span>
                    <span class="k">break</span>
        
        <span class="k">if</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">]:</span>
            <span class="n">ssd0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="n">sourceIECF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">newTargetIECF</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">sourceIECF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">newTargetIECF</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>\
                            <span class="p">(</span><span class="n">sourceIECF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">newTargetIECF</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">sourceIECF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">newTargetIECF</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span>\
                            <span class="p">(</span><span class="n">sourceIECF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">newTargetIECF</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">sourceIECF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">newTargetIECF</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
       
                    
        <span class="n">listToReturn</span> <span class="o">=</span> <span class="n">listIndices</span>           
        <span class="n">newListIndices</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">listToReturn</span> <span class="p">]</span>
        <span class="k">exec</span> <span class="s">&quot;listLenVoxels = [ np.</span><span class="si">%s</span><span class="s">(item[3]) for item in listToReturn ]&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span>
        
        <span class="k">return</span> <span class="n">ssd0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">newListIndices</span><span class="p">,</span><span class="n">dtype</span> <span class="o">=</span> <span class="s">&#39;int&#39;</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="s">&#39;C&#39;</span><span class="p">),</span><span class="n">listLenVoxels</span>


    </div>
<div class="viewcode-block" id="Patient.setReceivedDose"><a class="viewcode-back" href="../../../mspt.patient.html#mspt.patient.patient.Patient.setReceivedDose">[docs]</a>    <span class="k">def</span> <span class="nf">setReceivedDose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">computedDose</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Set the &quot;received dose&quot;. This should be done, once the delivery simulation ended.</span>
<span class="sd">        </span>
<span class="sd">        :param computedDose: 3D numpy array - 3D dose distribution</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">voiExternal</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">voi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maskVOIs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">voi</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;CLOSED_PLANAR&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">voi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;EXTERNAL&#39;</span><span class="p">:</span>
                    <span class="n">voiExternal</span> <span class="o">=</span> <span class="n">voi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">break</span>
        
        <span class="k">if</span> <span class="n">voiExternal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">tmpDose</span> <span class="o">=</span>  <span class="n">computedDose</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">voiExternal</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">typeFloat</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RDFileLoaded</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tmpDose</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c">#If the external is to deep in the image and the radiation did not reach it because of the absence of the RD file.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_receivedDoseArray</span> <span class="o">=</span> <span class="n">computedDose</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_receivedDoseArray</span> <span class="o">=</span> <span class="n">tmpDose</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_receivedDoseArray</span> <span class="o">=</span> <span class="n">computedDose</span>
        <span class="k">print</span> <span class="s">&quot;Computed dose distribution set in the patient.&quot;</span>
    
        </div>
<div class="viewcode-block" id="Patient.fillIndicesVOIPatient"><a class="viewcode-back" href="../../../mspt.patient.html#mspt.patient.patient.Patient.fillIndicesVOIPatient">[docs]</a>    <span class="k">def</span> <span class="nf">fillIndicesVOIPatient</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Function to find the indices of the voxels representing the patient body.\</span>
<span class="sd">        It fills the patient attribute &#39;_indPatient&#39;. \</span>
<span class="sd">        The Patient body corresponds to the voxels where the value is 1 in the mask of the VOI &#39;EXTERNAL&#39;. </span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">voiExternal</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">voi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maskVOIs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">voi</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;CLOSED_PLANAR&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">voi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;EXTERNAL&#39;</span><span class="p">:</span>
                    <span class="n">voiExternal</span> <span class="o">=</span> <span class="n">voi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="n">voiExternal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_indPatient</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">voiExternal</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_indPatient</span> <span class="o">=</span> <span class="bp">None</span>
 
         </div>
<div class="viewcode-block" id="Patient.getPatientMask"><a class="viewcode-back" href="../../../mspt.patient.html#mspt.patient.patient.Patient.getPatientMask">[docs]</a>    <span class="k">def</span> <span class="nf">getPatientMask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the patient body mask. It corresponds to the VOI &#39;EXTERNAL&#39; in the RS dicom file.</span>
<span class="sd">        </span>
<span class="sd">        :returns: 3D binary matrix: 1 in the patient body, 0 outside</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">voiExternal</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">voi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maskVOIs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">voi</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;CLOSED_PLANAR&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">voi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;EXTERNAL&#39;</span><span class="p">:</span>
                    <span class="n">voiExternal</span> <span class="o">=</span> <span class="n">voi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">break</span>
        <span class="k">return</span> <span class="n">voiExternal</span>    
    
            
        </div>
<div class="viewcode-block" id="Patient.displaySliceOrderingInfo"><a class="viewcode-back" href="../../../mspt.patient.html#mspt.patient.patient.Patient.displaySliceOrderingInfo">[docs]</a>    <span class="k">def</span> <span class="nf">displaySliceOrderingInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Function that displays the slice information,i.e. slice number and slice location in mm</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">nbSlices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pixelArray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">framesSpacing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSpacingInfo</span><span class="p">(</span><span class="s">&#39;frames&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="s">&quot;########### Slice ordering information ##############&quot;</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">nbSlices</span><span class="p">):</span>
            <span class="k">print</span> <span class="s">&quot;Slice # </span><span class="si">%i</span><span class="s"> / </span><span class="si">%i</span><span class="s"> : </span><span class="si">%f</span><span class="s"> mm&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nbSlices</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_imagePosition</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">idx</span> <span class="o">*</span> <span class="n">framesSpacing</span> <span class="p">)</span>
        <span class="k">print</span><span class="s">&quot;#####################################################&quot;</span>
           
        
        </div>
<div class="viewcode-block" id="Patient.exportSliceOrderingInfo"><a class="viewcode-back" href="../../../mspt.patient.html#mspt.patient.patient.Patient.exportSliceOrderingInfo">[docs]</a>    <span class="k">def</span> <span class="nf">exportSliceOrderingInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Export the slice ordering information (i.e. slice number-in first row- and slice location in mm -in second row)to a \</span>
<span class="sd">        csv file in the folder /CSV_Data of the current working directory (i.e. &#39;mainPath&#39;/&#39;nameSimulation&#39;) .Note: Rows will become columns if \</span>
<span class="sd">        there are more than 255 slices, in order to be able to open the CSV file in excel or numbers.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">pathToSave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pathToOutput</span> <span class="o">+</span> <span class="s">&quot;CSV_Data/&quot;</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pathToSave</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">pathToSave</span><span class="p">)</span>     

        <span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;SlicesInformation.csv&quot;</span>
        <span class="n">nbSlices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pixelArray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">arrayInfo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">nbSlices</span><span class="p">))</span>
        <span class="n">framesSpacing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSpacingInfo</span><span class="p">(</span><span class="s">&#39;frames&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">nbSlices</span><span class="p">):</span>
            <span class="n">arrayInfo</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">arrayInfo</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imagePosition</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">idx</span> <span class="o">*</span> <span class="n">framesSpacing</span>
            
        <span class="k">if</span> <span class="n">arrayInfo</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">:</span>
            <span class="n">arrayInfo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">arrayInfo</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)))</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span> <span class="n">pathToSave</span><span class="o">+</span><span class="n">filename</span><span class="p">,</span><span class="n">arrayInfo</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s"> </span><span class="si">%s</span><span class="s"> saved.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">pathToSave</span><span class="o">+</span><span class="n">filename</span><span class="p">)</span> 

<span class="c">################################################</span>
<span class="c">#########         Utility functions</span>
<span class="c">################################################</span>
</div>
<div class="viewcode-block" id="Patient.hotAndColdSpotsPerStrcuture"><a class="viewcode-back" href="../../../mspt.patient.html#mspt.patient.patient.Patient.hotAndColdSpotsPerStrcuture">[docs]</a>    <span class="k">def</span> <span class="nf">hotAndColdSpotsPerStrcuture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volRef</span><span class="p">,</span> <span class="n">volTest</span><span class="p">,</span> <span class="n">unpadded</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Computes the hot and cold spots in the different structures. This function is called from scanning.deliverySimulation_Static_Dynamic for a moving patient. \</span>
<span class="sd">        A spot is considered as a hot (cold) spot if its dose is higher (smaller) than 5% of the maximum of volRef.</span>
<span class="sd">            </span>
<span class="sd">        :param volRef: 3D numpy array. Dose distribution of reference.</span>
<span class="sd">        :param volTest: 3D numpy array. Dose distribution to test.</span>
<span class="sd">        :param unpadded: True to use unpadded masks, False (default) otherwise.</span>
<span class="sd">        </span>
<span class="sd">        :returns: Dictionary with the name of the VOIs as keys. The value of each of these key (i.e. for each VOI) is a dictionary whose keys are:</span>
<span class="sd">        </span>
<span class="sd">            * *&#39;nbVoxels&#39;*: Number of voxels in the VOI</span>
<span class="sd">            * *&#39;nbHotSpots&#39;* : Number of hot spots in the VOI</span>
<span class="sd">            * *&#39;nbColdSpots&#39;* : Number of cold spots in the VOI</span>
<span class="sd">            * *&#39;nbCorrectSpots&#39;* : Number of spots with a &#39;correct&#39; (i.e. within 5%) dose.</span>
<span class="sd">            * *&#39;percHotSpots&#39;* : Percentage of hot spots compared to the entire VOI.</span>
<span class="sd">            * *&#39;percColdSpots&#39;* : Percentage of cold spots compared to the entire VOI.</span>
<span class="sd">            * *&#39;percCorrectSpots&#39;* : Percentage of correct spots compared to the entire VOI.</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">hotAndColdSpots</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RDFileLoaded</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span>  <span class="p">(</span><span class="mi">5</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">volRef</span><span class="p">)</span> <span class="c">#5% of the maximum reference dose distribution</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">simTools</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="p">)</span><span class="o">.</span><span class="n">getMatrixHotAndColdSpot</span><span class="p">(</span><span class="n">volRef</span><span class="p">,</span> <span class="n">volTest</span><span class="p">)</span>
            
            <span class="n">same</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">same</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">unpadded</span><span class="p">:</span>
                <span class="n">maskVOIs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getUnpaddedPatientDataForAttr</span><span class="p">(</span><span class="s">&#39;maskVOIs&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">maskVOIs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maskVOIs</span>
            <span class="k">for</span> <span class="n">voi</span> <span class="ow">in</span> <span class="n">maskVOIs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">voi</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;CLOSED_PLANAR&quot;</span><span class="p">:</span>
                    <span class="n">nameROI</span> <span class="o">=</span> <span class="n">voi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="c">#obsROI = voi[2]</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="n">voi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                
                    <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">diff</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                        <span class="n">strErr</span> <span class="o">=</span> <span class="s">&quot;Wrong dimensions in hot and cold spots per structure: diff:</span><span class="si">%s</span><span class="s"> / mask:</span><span class="si">%s</span><span class="s"> / pixel array:</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pixelArray</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">strErr</span><span class="p">)</span>
                
                    <span class="n">hotAndColdSpots</span><span class="p">[</span><span class="n">nameROI</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="n">hotAndColdSpots</span><span class="p">[</span><span class="n">nameROI</span><span class="p">][</span><span class="s">&#39;nbVoxels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">same</span><span class="p">:</span>
                        <span class="n">hotAndColdSpots</span><span class="p">[</span><span class="n">nameROI</span><span class="p">][</span><span class="s">&#39;nbHotSpots&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&gt;=</span> <span class="n">p</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">hotAndColdSpots</span><span class="p">[</span><span class="n">nameROI</span><span class="p">][</span><span class="s">&#39;nbHotSpots&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">same</span><span class="p">:</span>                    
                        <span class="n">hotAndColdSpots</span><span class="p">[</span><span class="n">nameROI</span><span class="p">][</span><span class="s">&#39;nbColdSpots&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="n">p</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">hotAndColdSpots</span><span class="p">[</span><span class="n">nameROI</span><span class="p">][</span><span class="s">&#39;nbColdSpots&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">same</span><span class="p">:</span>
                        <span class="n">hotAndColdSpots</span><span class="p">[</span><span class="n">nameROI</span><span class="p">][</span><span class="s">&#39;nbCorrectSpots&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">diff</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">p</span><span class="p">)))[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">hotAndColdSpots</span><span class="p">[</span><span class="n">nameROI</span><span class="p">][</span><span class="s">&#39;nbCorrectSpots&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hotAndColdSpots</span><span class="p">[</span><span class="n">nameROI</span><span class="p">][</span><span class="s">&#39;nbVoxels&#39;</span><span class="p">]</span>
                        
                    <span class="n">hotAndColdSpots</span><span class="p">[</span><span class="n">nameROI</span><span class="p">][</span><span class="s">&#39;percHotSpots&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hotAndColdSpots</span><span class="p">[</span><span class="n">nameROI</span><span class="p">][</span><span class="s">&#39;nbHotSpots&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">100.0</span><span class="o">/</span><span class="n">hotAndColdSpots</span><span class="p">[</span><span class="n">nameROI</span><span class="p">][</span><span class="s">&#39;nbVoxels&#39;</span><span class="p">]</span>
                    <span class="n">hotAndColdSpots</span><span class="p">[</span><span class="n">nameROI</span><span class="p">][</span><span class="s">&#39;percColdSpots&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hotAndColdSpots</span><span class="p">[</span><span class="n">nameROI</span><span class="p">][</span><span class="s">&#39;nbColdSpots&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">100.0</span><span class="o">/</span><span class="n">hotAndColdSpots</span><span class="p">[</span><span class="n">nameROI</span><span class="p">][</span><span class="s">&#39;nbVoxels&#39;</span><span class="p">]</span>
                    <span class="n">hotAndColdSpots</span><span class="p">[</span><span class="n">nameROI</span><span class="p">][</span><span class="s">&#39;percCorrectSpots&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hotAndColdSpots</span><span class="p">[</span><span class="n">nameROI</span><span class="p">][</span><span class="s">&#39;nbCorrectSpots&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">100.0</span><span class="o">/</span><span class="n">hotAndColdSpots</span><span class="p">[</span><span class="n">nameROI</span><span class="p">][</span><span class="s">&#39;nbVoxels&#39;</span><span class="p">]</span>
                
        <span class="k">return</span> <span class="n">hotAndColdSpots</span>
        
        </div>
<div class="viewcode-block" id="Patient.computeEnergyReceivedByStructures"><a class="viewcode-back" href="../../../mspt.patient.html#mspt.patient.patient.Patient.computeEnergyReceivedByStructures">[docs]</a>    <span class="k">def</span> <span class="nf">computeEnergyReceivedByStructures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">doseData</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Computes the energy in Joules received by each patient structure. The data is exported to a .txt file save in the simulation folder.</span>
<span class="sd">        </span>
<span class="sd">        :param doseData: 3D numpy array representing the dose distribution.</span>
<span class="sd">        :param filename: Name of the file to save. Filename is preceded of &#39;SummaryEnergy&#39; when the file is being written.</span>
<span class="sd">            </span>
<span class="sd">        &#39;&#39;&#39;</span>
    
        <span class="n">pathToSave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pathToOutput</span> 
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pathToSave</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">pathToSave</span><span class="p">)</span>
        <span class="n">meV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">MeV</span> <span class="c">#J</span>
        <span class="n">nbProt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_globalVar</span><span class="o">.</span><span class="n">protPerMU</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pathToSave</span> <span class="o">+</span> <span class="s">&quot;SummaryEnergy_&quot;</span><span class="o">+</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="n">filename</span><span class="o">+</span><span class="s">&#39;.txt&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;Summary (</span><span class="si">%s</span><span class="s">) - energy repartition, per fraction, in patient body:</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">%</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">vois</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getUnpaddedPatientDataForAttr</span><span class="p">(</span><span class="s">&#39;maskVOIs&#39;</span><span class="p">)</span>
            <span class="n">spacing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSpacingInfo</span><span class="p">()</span>
            <span class="n">densityMat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getUnpaddedPatientDataForAttr</span><span class="p">(</span><span class="s">&#39;density&#39;</span><span class="p">)</span>  
            <span class="k">for</span> <span class="n">voi</span> <span class="ow">in</span> <span class="n">vois</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">voi</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;CLOSED_PLANAR&quot;</span><span class="p">:</span>
                    <span class="n">nameROI</span> <span class="o">=</span> <span class="p">((</span><span class="n">voi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;(&#39;</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;)&#39;</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">)</span>
                    <span class="n">obsROI</span> <span class="o">=</span> <span class="p">((</span><span class="n">voi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;(&#39;</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;)&#39;</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">)</span>
                    <span class="n">nameFile</span> <span class="o">=</span> <span class="s">&quot;ROI_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">nameROI</span><span class="p">,</span><span class="n">obsROI</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">voi</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
                    <span class="n">energyVoiMat</span> <span class="o">=</span> <span class="mf">1e-3</span> <span class="o">*</span> <span class="n">densityMat</span> <span class="o">*</span> <span class="n">voi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">doseData</span> <span class="o">*</span> <span class="n">spacing</span><span class="p">[</span><span class="s">&#39;frames&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">spacing</span><span class="p">[</span><span class="s">&#39;rows&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">spacing</span><span class="p">[</span><span class="s">&#39;cols&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-3</span>
                    <span class="n">energyVoi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">energyVoiMat</span><span class="p">)</span>
                    
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s"> </span><span class="si">%s</span><span class="s"> :</span><span class="se">\t</span><span class="s"> </span><span class="si">%f</span><span class="s"> </span><span class="se">\t</span><span class="s"> Joules,  </span><span class="se">\t</span><span class="s"> </span><span class="si">%f</span><span class="s"> </span><span class="se">\t</span><span class="s"> MeV ,  </span><span class="se">\t</span><span class="s"> </span><span class="si">%f</span><span class="s"> </span><span class="se">\t</span><span class="s"> MeV(Fluence: 1e-9 Prot/MU) </span><span class="se">\n</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span> <span class="n">nameROI</span><span class="p">,</span> <span class="n">energyVoi</span><span class="p">,</span><span class="n">energyVoi</span><span class="o">/</span><span class="n">meV</span><span class="p">,</span><span class="n">energyVoi</span><span class="o">/</span><span class="p">(</span><span class="n">meV</span><span class="o">*</span><span class="n">nbProt</span><span class="p">)))</span>
        </div></div>
</pre></div>

          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, Paul Morel, LIGM, Univ. Paris-Est MLV, France.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>